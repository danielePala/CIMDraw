!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).cimTopologyProcessor=t()}(this,(function(){"use strict";let e=null;return{css:'cimtopologyprocessor #cim-topology-processor,[is="cimtopologyprocessor"] #cim-topology-processor{ display: none }',exports:{onBeforeMount(t,n){e=this,t.dispatcher.on("diagrams",(function(){document.querySelector("#cim-topology-processor").style.display="flex"}))},run(t){document.querySelector("#tpMsg").textContent="Loading...",$("#tpStatusModal").modal("show"),$("#tpStatusModal").on("shown.bs.modal",(function(t){let n=topologyProcessor(e.props.model).calcTopology();document.querySelector("#tpMsg").textContent="Done ("+n.length+" nodes calculated)."}))}},template:function(e,t,n,a){return e('<ul class="nav navbar-nav" id="cim-topology-processor"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span id="seText">Topology Processor</span><span class="caret"></span></a><div class="dropdown-menu"><a expr19="expr19" class="dropdown-item" id="runLabel">Run</a></div></li></ul><div class="modal fade" id="tpStatusModal" tabindex="-1" role="dialog" aria-labelledby="tpStatusModalLabel"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="seConfigModalLabel">Topology processor results</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><p id="tpMsg">Loading...</p></div></div></div></div>',[{redundantAttribute:"expr19",selector:"[expr19]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.run}}]}])},name:"cimtopologyprocessor"}})),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).cimDiagram=t()}(this,(function(){"use strict";const e=14,t=d3.scaleSequential([0,500],d3.interpolateTurbo);let n=null,a="ConnectivityNode",o="ConnectivityNode.Terminals",r="Terminal.ConnectivityNode";return{css:'cimdiagram .app-diagram,[is="cimdiagram"] .app-diagram{ max-height: 800px; } cimdiagram path.domain,[is="cimdiagram"] path.domain{ fill: none; stroke: black; } cimdiagram g.tick > line,[is="cimdiagram"] g.tick > line{ stroke: black; stroke-dasharray: 1 5; } cimdiagram svg,[is="cimdiagram"] svg{ width: 1200px; height: 800px; } cimdiagram line.highlight-x,[is="cimdiagram"] line.highlight-x,cimdiagram line.highlight-y,[is="cimdiagram"] line.highlight-y{ stroke: red; stroke-width: 1; } cimdiagram g.resize > rect,[is="cimdiagram"] g.resize > rect{ stroke: black; stroke-width: 2; }',exports:{onBeforeMount(e,t){n=this,n.props.dispatcher.on("showDiagram",(function(e,t,i){if(decodeURI(t)!==n.diagramName){"BUS_BRANCH"===n.props.model.getMode()&&(a="TopologicalNode",o="TopologicalNode.Terminal",r="Terminal.TopologicalNode"),n.render(t)}void 0!==i?(n.moveTo(i),n.props.dispatcher.trigger("moveTo",i)):n.props.dispatcher.trigger("deselect")})),n.props.dispatcher.on("transform",(function(){let e=d3.zoomTransform(d3.select("svg").node()),t=e.x,n=e.y,a=e.k,o=parseInt(d3.select("svg").style("width")),r=parseInt(d3.select("svg").style("height")),i=d3.scaleLinear().domain([-t/a,(o-t)/a]).range([0,o]),l=d3.scaleLinear().domain([-n/a,(r-n)/a]).range([0,r]),s=d3.axisRight(l),c=d3.axisBottom(i);d3.select("svg").select("#yAxisG").call(s),d3.select("svg").select("#xAxisG").call(c)})),n.props.model.on("setAttribute",(function(e,t,a){switch(t){case"cim:IdentifiedObject.name":{let t=e.localName,o=n.props.model.ID(e);if("cim:BusbarSection"===e.nodeName){let a=n.props.model.getNode(e);if(null===a)return;t=a.localName,o=n.props.model.ID(a)}d3.select("svg").selectAll("svg > g.diagram > g."+t+"s").select("#cimdiagram-"+o).select("text").html(a);break}case"cim:AnalogValue.value":{let t=n.props.model.getTargets([e],"AnalogValue.Analog"),a=n.props.model.getTargets(t,"Measurement.PowerSystemResource")[0];"cim:BusbarSection"===a.nodeName&&(a=n.props.model.getNode(a));let o=n.props.model.ID(a),r=d3.select("g#cimdiagram-"+o);n.createStatusInfo(r);break}case"cim:SvPowerFlow.p":case"cim:SvPowerFlow.q":{let t=n.props.model.getTargets([e],"SvPowerFlow.Terminal")[0];if(void 0!==t){let e=n.props.model.getTargets([t],"Terminal.ConductingEquipment")[0],a=n.props.model.ID(e),o=d3.select("g#cimdiagram-"+a);n.createStatusInfo(o)}break}case"cim:BaseVoltage.nominalVoltage":{n.drawLegend();const t=n.props.model.getTargets([e],"BaseVoltage.ConductingEquipment"),a=t.filter((function(e){return!0===n.props.model.schema.isA("ACLineSegment",e)}));n.drawACLines(a);let o=t.filter((function(e){return!0===n.props.model.schema.isA("BusbarSection",e)})).map((e=>n.props.model.getNode(e)));n.drawNodes(o);const r=n.props.model.getTargets([e],"BaseVoltage.TransformerEnds");for(const e of r){const t=n.getTermNode(e);null!==t&&n.handlePowerTransformerEnds(t)}break}}if("cim:Analog"===e.nodeName||"cim:Discrete"===e.nodeName){let t=n.props.model.getTargets([e],"Measurement.PowerSystemResource")[0];if(void 0!==t){"cim:BusbarSection"===t.nodeName&&(t=n.props.model.getNode(t));let e=n.props.model.ID(t),a=d3.select("g#cimdiagram-"+e);n.createStatusInfo(a)}}if("cim:OperationalLimitSet"===e.nodeName){let t=n.props.model.getTargets([e],"OperationalLimitSet.Equipment"),a=n.props.model.getTargets([e],"OperationalLimitSet.Terminal");if(t=t.concat(n.props.model.getTargets(a,"Terminal.ConductingEquipment"))[0],void 0!==t){"cim:BusbarSection"===t.nodeName&&(t=n.props.model.getNode(t));let e=n.props.model.ID(t),a=d3.select("g#cimdiagram-"+e);n.createStatusInfo(a)}}})),n.props.model.on("setEnum",(function(e,t,a){if("cim:Analog"===e.nodeName||"cim:Discrete"===e.nodeName){let t=n.props.model.getTargets([e],"Measurement.PowerSystemResource")[0];if(void 0!==t){"cim:BusbarSection"===t.nodeName&&(t=n.props.model.getNode(t));let e=n.props.model.ID(t),a=d3.select("g#cimdiagram-"+e);n.createStatusInfo(a)}}switch(t){case"cim:PowerTransformerEnd.connectionKind":{const t=n.getTermNode(e);null!==t&&n.handlePowerTransformerEnds(t);break}}})),n.props.model.on("updateActiveDiagram",(function(e){let t=null;switch(e.nodeName){case"cim:ACLineSegment":t=n.drawACLines([e])[0],n.createTerminals(t);break;case"cim:"+a:n.drawNodes([e])}let o=e.localName,r=n.props.model.ID(e),i=d3.select("svg").selectAll("svg > g.diagram > g."+o+"s").select("#cimdiagram-"+r);n.forceTick(i)})),n.props.model.on("addToActiveDiagram",(function(e){let t=null;switch(e.nodeName){case"cim:ACLineSegment":t=n.drawACLines([e])[1];break;case"cim:Breaker":t=n.drawBreakers([e]);break;case"cim:Disconnector":t=n.drawDisconnectors([e]);break;case"cim:LoadBreakSwitch":t=n.drawLoadBreakSwitches([e]);break;case"cim:Junction":t=n.drawJunctions([e]);break;case"cim:EnergySource":t=n.drawEnergySources([e]);break;case"cim:SynchronousMachine":t=n.drawSynchronousMachines([e]);break;case"cim:AsynchronousMachine":t=n.drawAsynchronousMachines([e]);break;case"cim:EnergyConsumer":t=n.drawEnergyConsumers([e]);break;case"cim:ConformLoad":t=n.drawConformLoads([e]);break;case"cim:NonConformLoad":t=n.drawNonConformLoads([e]);break;case"cim:EquivalentInjection":t=n.drawEquivalentInjections([e]);break;case"cim:LinearShuntCompensator":t=n.drawLinearCompensators([e]);break;case"cim:NonlinearShuntCompensator":t=n.drawNonlinearCompensators([e]);break;case"cim:PowerTransformer":t=n.drawPowerTransformers([e]);break;case"cim:"+a:t=n.drawNodes([e]),o(e,null)}if(null!==t&&function(t){let a=n.props.model.getTerminals([e]);for(let e of a){let t=n.props.model.getTargets([e],r)[0];if(void 0!==t){let e=n.props.model.getEquipments(t),a=e.filter((e=>"BusbarSection"===e.localName))[0];if(e=e.filter((e=>e!==a)),e.length>1){n.drawNodes([t]);let a=n.props.model.getTerminals(e);for(let e of a){if(n.props.model.getTargets([e],r)[0]===t){let a={source:t,target:e};n.createEdges([a])}}}}}n.createTerminals(t)}(t),"cim:BusbarSection"===e.nodeName){let a=n.props.model.getTargets([e],"ConductingEquipment.Terminals"),i=n.props.model.getTargets(a,r)[0];t=n.drawNodes([i]),o(i,e)}function o(e,t){let a=n.props.model.getEquipments(e).filter((e=>e!==t)),o=n.props.model.getTerminals(a);for(let t of o){if(void 0===t.x)continue;if(n.props.model.getTargets([t],r)[0]===e){let a={source:e,target:t};n.createEdges([a])}}}null!==t&&(n.forceTick(t),n.props.dispatcher.trigger("addToDiagram",t))})),n.props.model.on("addLink",(function(e,t,i){switch(t){case"cim:"+r:case"cim:"+o:{let t=void 0,o=void 0;if("cim:Terminal"===i.nodeName&&e.nodeName==="cim:"+a)t=e,o=i;else{if("cim:Terminal"!==e.nodeName||i.nodeName!=="cim:"+a)return;o=e,t=i}let r=d3.select("svg").selectAll("svg > g.diagram > g.edges > g").data().filter((e=>e.target===o))[0];if(void 0===r){let e=n.props.model.getTargets([o],"Terminal.ConductingEquipment");n.props.model.getDiagramObjects(e).length>0&&(r={source:t,target:o},n.createEdges([r]))}else r.source=t;let l=n.props.model.ID(t),s=d3.select("svg > g.diagram > g."+a+"s > g#cimdiagram-"+l);n.forceTick(s);break}case"cim:Terminal.SvPowerFlow":case"cim:SvPowerFlow.Terminal":{let t=i;if("cim:Terminal"===e.nodeName&&(t=e),void 0!==t){let e=n.props.model.getTargets([t],"Terminal.ConductingEquipment")[0],a=n.props.model.ID(e),o=d3.select("g#cimdiagram-"+a);n.createStatusInfo(o)}break}case"cim:Measurement.Terminal":case"cim:ACDCTerminal.Measurements":{let t=i;"cim:Terminal"===e.nodeName&&(t=e);let a=n.props.model.getTargets([t],"Terminal.ConductingEquipment")[0],o=n.props.model.ID(a),r=d3.select("g#cimdiagram-"+o);n.createStatusInfo(r);break}case"cim:Measurement.PowerSystemResource":case"cim:PowerSystemResource.Measurements":{let a=i;if("cim:PowerSystemResource.Measurements"===t&&(a=e),void 0!==a){"cim:BusbarSection"===a.nodeName&&(a=n.props.model.getNode(a));let e=n.props.model.ID(a),t=d3.select("g#cimdiagram-"+e);n.createStatusInfo(t)}break}case"cim:OperationalLimitSet.Terminal":case"cim:ACDCTerminal.OperationalLimitSet":{let t=i;"cim:Terminal"===e.nodeName&&(t=e);let a=n.props.model.getTargets([t],"Terminal.ConductingEquipment")[0],o=n.props.model.ID(a),r=d3.select("g#cimdiagram-"+o);n.createStatusInfo(r);break}case"cim:OperationalLimitSet.Equipment":case"cim:Equipment.OperationalLimitSet":{let a=i;if("cim:Equipment.OperationalLimitSet"===t&&(a=e),void 0!==a){"cim:BusbarSection"===a.nodeName&&(a=n.props.model.getNode(a));let e=n.props.model.ID(a),t=d3.select("g#cimdiagram-"+e);n.createStatusInfo(t)}break}case"cim:ConductingEquipment.BaseVoltage":case"cim:BaseVoltage.ConductingEquipment":{let a=e;"cim:BaseVoltage.ConductingEquipment"===t&&(a=i),void 0!==a&&("cim:ACLineSegment"===a.nodeName&&n.drawACLines([a]),"cim:BusbarSection"===a.nodeName&&(a=n.props.model.getNode(a),n.drawNodes([a])));break}case"cim:BaseVoltage.TransformerEnds":case"cim:TransformerEnd.BaseVoltage":{let a=e;if("cim:BaseVoltage.TransformerEnds"===t&&(a=i),void 0!==a){const e=n.getTermNode(a);null!==e&&n.handlePowerTransformerEnds(e)}break}}})),n.props.model.on("removeLink",(function(e,t,i){switch(t){case"cim:Measurement.PowerSystemResource":case"cim:PowerSystemResource.Measurements":{let a=i;if("cim:PowerSystemResource.Measurements"===t&&(a=e),void 0!==a){"cim:BusbarSection"===a.nodeName&&(a=n.props.model.getNode(a));let e=n.props.model.ID(a),t=d3.select("g#"+e);n.createStatusInfo(t)}break}case"cim:"+r:case"cim:"+o:{let t=void 0;if("cim:Terminal"===i.nodeName&&e.nodeName==="cim:"+a)t=i;else{if("cim:Terminal"!==e.nodeName||i.nodeName!=="cim:"+a)return;t=e}d3.select("svg").selectAll("svg > g.diagram > g.edges > g").filter((function(e){return e.target===t})).remove();break}case"cim:OperationalLimitSet.Terminal":case"cim:ACDCTerminal.OperationalLimitSet":{let t=i;"cim:Terminal"===e.nodeName&&(t=e);let a=n.props.model.getTargets([t],"Terminal.ConductingEquipment")[0];if(void 0!==a){let e=n.props.model.ID(a),t=d3.select("g#"+e);n.createStatusInfo(t)}break}case"cim:OperationalLimitSet.Equipment":case"cim:Equipment.OperationalLimitSet":{let a=i;if("cim:Equipment.OperationalLimitSet"===t&&(a=e),void 0!==a&&("cim:BusbarSection"===a.nodeName&&(a=n.props.model.getNode(a)),null!==a)){let e=n.props.model.ID(a),t=d3.select("g#"+e);n.createStatusInfo(t)}break}}}))},onMounted(){let e=d3.scaleLinear().domain([0,1200]).range([0,1200]),t=d3.scaleLinear().domain([0,800]).range([0,800]),a=d3.axisRight(t),o=d3.axisBottom(e);d3.select("svg").append("g").attr("id","yAxisG").call(a),d3.select("svg").append("g").attr("id","xAxisG").call(o),n.drawGrid(1)},render(e){let t=function*(e){d3.select("svg").select("g.diagram").selectAll("g:not(.edges)").remove(),n.props.model.selectDiagram(decodeURI(e)),n.diagramName=decodeURI(e);const t=n.props.model.getNodes();yield"DIAGRAM: extracted nodes";const a=n.props.model.getGraphicObjects(["cim:ACLineSegment","cim:Breaker","cim:Disconnector","cim:LoadBreakSwitch","cim:Junction","cim:EnergySource","cim:SynchronousMachine","cim:AsynchronousMachine","cim:EnergyConsumer","cim:ConformLoad","cim:NonConformLoad","cim:EquivalentInjection","cim:PowerTransformer","cim:BusbarSection","cim:LinearShuntCompensator","cim:NonlinearShuntCompensator"]),o=a["cim:ACLineSegment"],r=a["cim:Breaker"],i=a["cim:Disconnector"],l=a["cim:LoadBreakSwitch"],s=a["cim:Junction"],c=a["cim:EnergySource"],d=a["cim:SynchronousMachine"],m=a["cim:AsynchronousMachine"],u=a["cim:EnergyConsumer"],p=a["cim:ConformLoad"],g=a["cim:NonConformLoad"],f=a["cim:EquivalentInjection"],h=a["cim:PowerTransformer"],b=(a["cim:BusbarSection"],a["cim:LinearShuntCompensator"]),v=a["cim:NonlinearShuntCompensator"];yield"DIAGRAM: extracted equipments";const y=n.drawACLines(o)[1];yield"DIAGRAM: drawn acLines";const x=n.drawBreakers(r);yield"DIAGRAM: drawn breakers";const T=n.drawDisconnectors(i);yield"DIAGRAM: drawn disconnectors";const A=n.drawLoadBreakSwitches(l);yield"DIAGRAM: drawn load break switches";const w=n.drawJunctions(s);yield"DIAGRAM: drawn junctions";const C=n.drawEnergySources(c);yield"DIAGRAM: drawn energy sources";const N=n.drawSynchronousMachines(d);yield"DIAGRAM: drawn synchronous machines";const S=n.drawAsynchronousMachines(m);yield"DIAGRAM: drawn asynchronous machines";const E=n.drawEnergyConsumers(u);yield"DIAGRAM: drawn energy consumers";const L=n.drawConformLoads(p);yield"DIAGRAM: drawn conform loads";const k=n.drawNonConformLoads(g);yield"DIAGRAM: drawn non conform loads";const D=n.drawEquivalentInjections(f);yield"DIAGRAM: drawn equivalent injections";const M=n.drawPowerTransformers(h);yield"DIAGRAM: drawn power transformers";const I=n.drawLinearCompensators(b);yield"DIAGRAM: drawn linear shunt compensators";const B=n.drawNonlinearCompensators(v);yield"DIAGRAM: drawn nonlinear shunt compensators";const O=n.drawNodes(t);n.createStatusInfo(O),yield"DIAGRAM: drawn connectivity nodes",n.createTerminals(y),n.createStatusInfo(y),yield"DIAGRAM: drawn acline terminals",n.createTerminals(x),n.createStatusInfo(x),yield"DIAGRAM: drawn breaker terminals",n.createTerminals(T),n.createStatusInfo(T),yield"DIAGRAM: drawn disconnector terminals",n.createTerminals(A),n.createStatusInfo(A),yield"DIAGRAM: drawn load break switch terminals",n.createTerminals(w),n.createStatusInfo(w),yield"DIAGRAM: drawn junction terminals",n.createTerminals(C),n.createStatusInfo(C),yield"DIAGRAM: drawn energy source terminals",n.createTerminals(N),n.createStatusInfo(N),yield"DIAGRAM: drawn synchronous machine terminals",n.createTerminals(S),n.createStatusInfo(S),yield"DIAGRAM: drawn asynchronous machine terminals",n.createTerminals(E),n.createStatusInfo(E),yield"DIAGRAM: drawn energy consumer terminals",n.createTerminals(L),n.createStatusInfo(L),yield"DIAGRAM: drawn conform load terminals",n.createTerminals(k),n.createStatusInfo(k),yield"DIAGRAM: drawn non conform load terminals",n.createTerminals(D),n.createStatusInfo(D),yield"DIAGRAM: drawn equivalent injection terminals",n.createTerminals(M),n.createStatusInfo(M),yield"DIAGRAM: drawn power transformer terminals",n.createTerminals(I),n.createStatusInfo(I),yield"DIAGRAM: drawn linear shunt compensator terminals",n.createTerminals(B),n.createStatusInfo(B),yield"DIAGRAM: drawn nonlinear shunt compensator terminals",n.drawLegend(),d3.select("svg").on("dragover",(function(e){e.preventDefault()})).on("drop",(function(e){e.preventDefault();const t=e.dataTransfer.getData("text/plain");if(void 0===t)return;const a=n.props.model.getObject(t);if(void 0===a)return;n.props.model.getDiagramObjects([a]).length>0?n.moveTo(t):addToDiagram(n.props.model,e,a)})),n.forceTick(),n.props.dispatcher.trigger("render")}(e);!function e(){let a=t.next().value;void 0!==a?(document.getElementById("loadingDiagramMsg").innerHTML="<br>"+a,setTimeout(e,1)):n.props.dispatcher.trigger("loaded")}()},createEdges(e){let t=d3.select("svg").select("g > g.edges").selectAll("g.edge").data(e,(function(e){return e.source.attributes[0].value+e.target.attributes[0].value})).enter().append("g").attr("class","edge").attr("id",(function(e){return e.source.attributes[0].value+e.target.attributes[0].value})).append("path").attr("fill","none").attr("stroke","black").attr("stroke-width",1);n.props.dispatcher.trigger("createEdges",t)},createStatusInfo(e){e.attr("data-toggle","popover"),e.filter((function(e){return n.props.model.schema.isA("Switch",e)})).selectAll("path").attr("fill",(function(e){let t=n.props.model.getTargets([e],"PowerSystemResource.Measurements")[0];return"0"===n.getDiscreteValue(t)?"white":"black"})),e.each((function(e){let t=[],o=[],r=[],i=n.props.model.getTargets([e],"TopologicalNode.SvVoltage"),l=n.props.model.getTerminals([e]);if(e.nodeName==="cim:"+a){let a=n.props.model.getBusbar(e);if(null===a)return;l=n.props.model.getTerminals([a]),t=n.props.model.getTargets([a],"PowerSystemResource.Measurements"),r=n.props.model.getTargets([a],"Equipment.OperationalLimitSet")}else t=n.props.model.getTargets([e],"PowerSystemResource.Measurements"),r=n.props.model.getTargets([e],"Equipment.OperationalLimitSet");r=r.concat(n.props.model.getTargets(l,"ACDCTerminal.OperationalLimitSet"));for(let e of l){let t=n.props.model.getTargets([e],"Terminal.SvPowerFlow");o=o.concat(t)}if(t.length>0||o.length>0||i.length>0||r.length>0){let e=n.createTooltip(t,o,i,r);$(this).popover("dispose").popover({title:"<b>Element Status Info</b>",content:e,container:"body",html:!0,trigger:"manual",delay:{show:200,hide:0},placement:"auto"})}else d3.select(this).attr("data-toggle",null),$(this).popover("dispose")}))},getDiscreteValue(e){let t="0";if(void 0!==e){let a=n.props.model.getTargets([e],"Discrete.DiscreteValues")[0];if(void 0!==a){let e=n.props.model.getAttribute(a,"cim:DiscreteValue.value");void 0!==e&&(t=e.textContent)}}return t},createTooltip(e,t,a,o){let r="";if(e.length>0){r+="<b>Measurements</b><br><br>";let t=[];for(let a of e){let e="unnamed",o="ABC",r="",i="no unit",l=n.props.model.getAttribute(a,"cim:IdentifiedObject.name"),s=n.props.model.getEnum(a,"cim:Measurement.phases"),c=n.props.model.getEnum(a,"cim:Measurement.unitMultiplier"),d=n.props.model.getEnum(a,"cim:Measurement.unitSymbol");void 0!==l&&(e=l.textContent),void 0!==s&&(o=s),void 0!==c&&(r=c,"none"===r&&(r="")),void 0!==d&&(i=d);let m=n.props.model.getTargets([a],"Analog.AnalogValues")[0],u="",p="n.a.";void 0!==m?void 0!==n.props.model.getAttribute(m,"cim:AnalogValue.value")&&(p=n.props.model.getAttribute(m,"cim:AnalogValue.value").textContent,p=parseFloat(p).toFixed(2)):(p=n.getDiscreteValue(a),p=parseInt(p));let g=n.props.model.ID(a),f=window.location.hash.split("/");u=u+"<a href="+(f[0]+"/"+f[1]+"/"+f[2]+"/"+g)+">"+e+"</a>",u=u+" (phase: "+o+")",u+=": ",u+=p,u=u+" ["+r+i+"]",u+="<br>",t.push(u)}t.sort();for(let e in t)r+=t[e]}if(t.length>0){""!==r&&(r+="<br>"),r+="<b>Power flow results (Power)</b><br><br>";for(let e of t){let t=0,a=0;void 0!==n.props.model.getAttribute(e,"cim:SvPowerFlow.p")&&(t=n.props.model.getAttribute(e,"cim:SvPowerFlow.p").textContent),void 0!==n.props.model.getAttribute(e,"cim:SvPowerFlow.q")&&(a=n.props.model.getAttribute(e,"cim:SvPowerFlow.q").textContent);let o="Active Power: "+parseFloat(t).toFixed(2)+" [MW]";o+="<br>",o=o+"Reactive power: "+parseFloat(a).toFixed(2)+" [MVAr]",o+="<br>",r+=o}}if(a.length>0){""!==r&&(r+="<br>"),r+="<b>Power flow results (Voltage)</b><br><br>";for(let e of a){let t=0,a=0;void 0!==n.props.model.getAttribute(e,"cim:SvVoltage.v")&&(t=n.props.model.getAttribute(e,"cim:SvVoltage.v").textContent),void 0!==n.props.model.getAttribute(e,"cim:SvVoltage.angle")&&(a=n.props.model.getAttribute(e,"cim:SvVoltage.angle").textContent);let o="Voltage magnitude: "+parseFloat(t).toFixed(2)+" [kV]";o+="<br>",o=o+"Voltage angle: "+parseFloat(a).toFixed(2)+" [deg]",o+="<br>",r+=o}}if(o.length>0){""!==r&&(r+="<br>"),r+="<b>Operational limit sets</b><br><br>";for(let e of o){let t="unnamed",a=n.props.model.getAttribute(e,"cim:IdentifiedObject.name");void 0!==a&&(t=a.textContent);let o=n.props.model.ID(e),i=window.location.hash.split("/");r+="<a href="+(i[0]+"/"+i[1]+"/"+i[2]+"/"+o)+">"+t+"</a><br>"}}return r},createSelection(e,t){let a=e+"s";d3.select("svg").select("g."+a).empty()&&d3.select("svg").select("g.diagram").append("g").attr("class",a);for(let e of t)calcLineData(n.props.model,e);let o=d3.select("svg").select("g."+a).selectAll("g."+e).data(t,(function(e){return n.props.model.ID(e)})),r=o.enter().append("g").attr("class",e).attr("id",(function(e){return"cimdiagram-"+n.props.model.ID(e)}));return[o,r]},drawACLines(e){const t=d3.line().x((function(e){return e.x})).y((function(e){return e.y})),a=n.createSelection("ACLineSegment",e),o=a[0],r=a[1];function i(e){e.attr("x",(function(e){let t=d3.select(this.parentNode).select("path").node();return t.getPointAtLength(t.getTotalLength()/2).x+2})).attr("y",(function(e){let t=d3.select(this.parentNode).select("path").node();return t.getPointAtLength(t.getTotalLength()/2).y-2})).text((function(e){let t=n.props.model.getAttribute(e,"cim:IdentifiedObject.name");return void 0!==t?t.innerHTML:""}))}return r.append("path").attr("d",(function(e){return 1===e.lineData.length&&e.lineData.push({x:150,y:0,seq:2}),t(e.lineData)})).attr("fill","none").attr("stroke",(function(e){return n.voltageColor(e,"darkred")})).attr("stroke-width",2),r.append("text").attr("class","cim-object-text").attr("font-size",3),i(o.select("text")),i(r.select("text")),o.select("path").attr("d",(function(e){return 1===e.lineData.length&&e.lineData.push({x:150,y:0,seq:2}),t(e.lineData)})).attr("fill","none").attr("stroke",(function(e){return n.voltageColor(e,"darkred")})).attr("stroke-width",2),[o,r]},drawBreakers:e=>n.drawSwitches(e,"Breaker","green"),drawDisconnectors:e=>n.drawSwitches(e,"Disconnector","blue"),drawLoadBreakSwitches:e=>n.drawSwitches(e,"LoadBreakSwitch","black"),drawJunctions:e=>n.drawSwitches(e,"Junction","red"),drawSwitches(e,t,a){let o=d3.line().x((function(e){return e.x})).y((function(e){return e.y})).curve(d3.curveLinearClosed),r=n.createSelection(t,e)[1];return r.append("path").attr("d",(function(e){return o([{x:-5,y:-5,seq:1},{x:5,y:-5,seq:2},{x:5,y:5,seq:3},{x:-5,y:5,seq:4}])})).attr("fill",(function(e){let t=n.props.model.getTargets([e],"PowerSystemResource.Measurements")[0];return"0"===n.getDiscreteValue(t)?"white":"black"})).attr("stroke",a).attr("stroke-width",1),r.append("text").attr("class","cim-object-text").style("text-anchor","end").attr("font-size",3).attr("x",-10).attr("y",0).text((function(e){let t=n.props.model.getAttribute(e,"cim:IdentifiedObject.name");return void 0!==t?t.innerHTML:""})),r},drawEnergySources:e=>n.drawGenerators(e,"EnergySource"),drawSynchronousMachines:e=>n.drawGenerators(e,"SynchronousMachine"),drawAsynchronousMachines:e=>n.drawGenerators(e,"AsynchronousMachine"),drawEnergyConsumers:e=>n.drawLoads(e,"EnergyConsumer"),drawConformLoads:e=>n.drawLoads(e,"ConformLoad"),drawNonConformLoads:e=>n.drawLoads(e,"NonConformLoad"),drawEquivalentInjections:e=>n.drawLoads(e,"EquivalentInjection"),drawLinearCompensators:e=>n.drawCompensators(e,"LinearShuntCompensator"),drawNonlinearCompensators:e=>n.drawCompensators(e,"NonlinearShuntCompensator"),drawGenerators(e,t){let a=n.createSelection(t,e)[1],o="G";const r=Math.round(15);return"AsynchronousMachine"===t&&(o="M"),a.append("circle").attr("r",12.5).attr("cx",0).attr("cy",0).attr("fill","white").attr("stroke","black").attr("stroke-width",1),a.append("text").attr("class","cim-object-text").style("text-anchor","middle").attr("font-size",3).attr("x",0).attr("y",-47.5).text((function(e){let t=n.props.model.getAttribute(e,"cim:IdentifiedObject.name");return void 0!==t?t.innerHTML:""})),a.append("text").style("text-anchor","middle").attr("font-size",r).attr("x",0).attr("y",6.25).text(o),a},drawLoads(e,t){let a=d3.line().x((function(e){return e.x})).y((function(e){return e.y})).curve(d3.curveLinearClosed),o=n.createSelection(t,e)[1];return o.append("path").attr("d",(function(e){return a([{x:-15,y:-10,seq:1},{x:15,y:-10,seq:2},{x:0,y:10,seq:3}])})).attr("fill","white").attr("stroke","black").attr("stroke-width",2),o.append("text").attr("class","cim-object-text").style("text-anchor","middle").attr("font-size",3).attr("x",0).attr("y",20).text((function(e){let t=n.props.model.getAttribute(e,"cim:IdentifiedObject.name");return void 0!==t?t.innerHTML:""})),o},drawCompensators(e,t){let a=d3.line().x((function(e){return e.x})).y((function(e){return e.y})),o=n.createSelection(t,e)[1];return o.append("path").attr("d",(function(e){return a([{x:0,y:-10,seq:1},{x:0,y:-4,seq:2}])})).attr("fill","white").attr("stroke","black").attr("stroke-width",1),o.append("path").attr("d",(function(e){return a([{x:0,y:4,seq:1},{x:0,y:10,seq:2}])})).attr("fill","white").attr("stroke","black").attr("stroke-width",1),o.append("path").attr("d",(function(e){return a([{x:-15,y:-4,seq:1},{x:15,y:-4,seq:2}])})).attr("fill","white").attr("stroke","black").attr("stroke-width",4),o.append("path").attr("d",(function(e){return a([{x:-15,y:4,seq:1},{x:15,y:4,seq:2}])})).attr("fill","white").attr("stroke","black").attr("stroke-width",4),o.append("text").attr("class","cim-object-text").style("text-anchor","middle").attr("font-size",3).attr("x",0).attr("y",20).text((function(e){let t=n.props.model.getAttribute(e,"cim:IdentifiedObject.name");return void 0!==t?t.innerHTML:""})),o},drawPowerTransformers(t){const a=this.createSelection("PowerTransformer",t)[1],o=a.filter((function(e){return 2===n.props.model.getTargets([e],"PowerTransformer.PowerTransformerEnd").length})),r=a.filter((function(e){return 3===n.props.model.getTargets([e],"PowerTransformer.PowerTransformerEnd").length}));return o.append("circle").attr("r",e).attr("cx",0).attr("cy",11).attr("fill","white").attr("stroke","black").attr("stroke-width",1),r.append("circle").attr("r",e).attr("cx",-11).attr("cy",11).attr("fill","white").attr("stroke","black").attr("stroke-width",1),r.append("circle").attr("r",e).attr("cx",11).attr("cy",11).attr("fill","white").attr("stroke","black").attr("stroke-width",1),o.append("g").attr("class","TransformerEnd").attr("transform",d3.zoomIdentity.translate(0,-11)).append("circle").attr("r",e).attr("cx",0).attr("cy",0).attr("fill","white").attr("stroke","black").attr("stroke-width",1).attr("class","TransformerEndCircle"),o.append("g").attr("class","TransformerEnd").attr("transform",d3.zoomIdentity.translate(0,11)).append("circle").attr("r",e).attr("cx",0).attr("cy",0).attr("fill","white").attr("fill-opacity","0").attr("stroke","black").attr("stroke-width",1).attr("class","TransformerEndCircle"),r.append("g").attr("class","TransformerEnd").attr("transform",d3.zoomIdentity.translate(0,-11)).append("circle").attr("r",e).attr("cx",0).attr("cy",0).attr("fill","white").attr("stroke","black").attr("stroke-width",1).attr("class","TransformerEndCircle"),r.append("g").attr("class","TransformerEnd").attr("transform",d3.zoomIdentity.translate(-11,11)).append("circle").attr("r",e).attr("cx",0).attr("cy",0).attr("fill","white").attr("fill-opacity","0").attr("stroke","black").attr("stroke-width",1).attr("class","TransformerEndCircle"),r.append("g").attr("class","TransformerEnd").attr("transform",d3.zoomIdentity.translate(11,11)).append("circle").attr("r",e).attr("cx",0).attr("cy",0).attr("fill","white").attr("fill-opacity","0").attr("stroke","black").attr("stroke-width",1).attr("class","TransformerEndCircle"),a.append("text").attr("class","cim-object-text").style("text-anchor","end").attr("font-size",3).attr("x",-25).attr("y",25).text((function(e){const t=n.props.model.getAttribute(e,"cim:IdentifiedObject.name");return void 0!==t?t.innerHTML:""})),a},handlePowerTransformerEnds(e){const t=d3.select(e).datum(),a=d3.select(e.parentNode).datum(),o=n.props.model.getTargets([t],"Terminal.TransformerEnd"),r=t.x-a.x,i=t.y-a.y;let l=null,s=null;d3.select(e.parentNode).selectAll(":scope > g.TransformerEnd").each((function(){const e=this.transform.baseVal.consolidate();let t={e:0,f:0};null!==e&&(t=e.matrix);const n=t.e,a=t.f,o=(n-r)**2+(a-i)**2;(null===l||l>o)&&(l=o,s=d3.select(this))})),s.data(o),s.attr("id",(function(){return"cimdiagram-"+n.props.model.ID(o[0])})),s.select("circle.TransformerEndCircle").attr("stroke",(function(e){return n.voltageColor(e,"black")})),s.selectAll("path").remove();const c=n.props.model.getEnum(o[0],"cim:PowerTransformerEnd.connectionKind");if(void 0!==c){const e=.2,t=.4,n=[0,i*e],a=[0,i*t],o=t-e,r=o*Math.sqrt(3)/2,l=o/2,d=[i*-r,i*(e-l)],m=[i*r,i*(e-l)];c.startsWith("Y")&&(s.append("path").attr("d",d3.line()([a,n])).attr("stroke","black"),s.append("path").attr("d",d3.line()([n,d])).attr("stroke","black"),s.append("path").attr("d",d3.line()([n,m])).attr("stroke","black")),"D"===c&&s.append("path").attr("d",d3.line().curve(d3.curveLinearClosed)([a,d,m])).attr("stroke","black").attr("fill","white")}},createTerminals(t){let a=0,o=30,i="none";switch(t.size()>0&&(i=t.data()[0].nodeName),i){case"cim:Breaker":case"cim:Disconnector":case"cim:LoadBreakSwitch":a=-6,o=6;break;case"cim:EnergySource":case"cim:SynchronousMachine":case"cim:AsynchronousMachine":a=-13.5;break;case"cim:EnergyConsumer":case"cim:ConformLoad":case"cim:NonConformLoad":case"cim:EquivalentInjection":a=-11;break;case"cim:PowerTransformer":a=-26,o=26;break;case"cim:LinearShuntCompensator":case"cim:NonlinearShuntCompensator":a=-11;break;default:o=30}let l=[],s=t.selectAll("g.Terminal").data((function(e){return n.props.model.getTerminals([e])})),c=s.enter().append("g").each((function(t,s){let c=n.props.model.getTargets([t],r)[0],d=d3.select(this.parentNode).datum().lineData,m=d[0],u=d[d.length-1],p=d3.select(this.parentNode).datum().x,g=d3.select(this.parentNode).datum().y;1===d.length&&(m={x:0,y:a},u={x:0,y:o});let f=d3.select(this.parentNode).datum().rotation,h=n.props.model.getTerminals(d3.select(this.parentNode).data());if(void 0!==c&&2===h.length){let e=0,a=0;if(f>0){let t=rotate(m,f),n=rotate(u,f);e=Math.pow(p+t.x-c.x,2)+Math.pow(g+t.y-c.y,2),a=Math.pow(p+n.x-c.x,2)+Math.pow(g+n.y-c.y,2)}else e=Math.pow(p+m.x-c.x,2)+Math.pow(g+m.y-c.y,2),a=Math.pow(p+u.x-c.x,2)+Math.pow(g+u.y-c.y,2);a<e?(t.x=p+u.x,t.y=g+u.y):(t.x=p+m.x,t.y=g+m.y),function(e,t,a,o,i,l,s){let c=e.filter((e=>e!==t))[0],d=n.props.model.getTargets([c],r)[0],m=c;if(void 0!==d){n.props.model.getEquipments(d).length>1&&(m=t)}c.x===t.x&&c.y===t.y&&(t.x===o+s.x&&t.y===i+s.y?(m.x=o+l.x,m.y=i+l.y):(m.x=o+s.x,m.y=i+s.y))}(h,t,0,p,g,m,u)}else 1===d.length?(t.x=p,3===h.length?(0===s&&(t.y=g+a),1===s&&(t.x=t.x-25+e,t.y=g+o),2===s&&(t.x=t.x+25-e,t.y=g+o)):t.y=g+a*(1-s)+o*s):(t.x=p+m.x*(1-s)+u.x*s,t.y=g+m.y*(1-s)+u.y*s);if(t.rotation=d3.select(this.parentNode).datum().rotation,void 0!==c&&void 0!==c.lineData){let e={source:c,target:t};l.push(e)}"cim:PowerTransformer"===i&&n.handlePowerTransformerEnds(this)})).attr("id",(function(e){return"cimdiagram-"+n.props.model.ID(e)})).attr("class",(function(e){return e.localName}));return n.createEdges(l),c.append("circle").attr("r",1).style("fill","black").attr("cx",(function(e,t){return d3.select(this.parentNode).datum().x-d3.select(this.parentNode.parentNode).datum().x})).attr("cy",(function(e,t){return d3.select(this.parentNode).datum().y-d3.select(this.parentNode.parentNode).datum().y})),s.each((function(e,t){let n=d3.select(this.parentNode).datum().x,a=d3.select(this.parentNode).datum().y,o=parseInt(d3.select(this.firstChild).attr("cx")),r=parseInt(d3.select(this.firstChild).attr("cy"));if(0===o&&0===r)e.x=n,e.y=a;else{let t=d3.select(this.parentNode).datum().lineData,o=t[t.length-1];e.x=n+o.x,e.y=a+o.y}})),s.selectAll("circle").attr("cx",(function(e,t){return d3.select(this.parentNode).datum().x-d3.select(this.parentNode.parentNode).datum().x})).attr("cy",(function(e,t){return d3.select(this.parentNode).datum().y-d3.select(this.parentNode.parentNode).datum().y})),c.each((function(){let e=d3.select(this).select("circle");d3.select(this).append("circle").attr("cx",e.attr("cx")).attr("cy",e.attr("cy")).attr("r",4).attr("stroke-width",0).attr("fill","steelblue").attr("fill-opacity","0.0").attr("class","big-circle").on("mouseout",(function(e,t){d3.select(this).attr("fill-opacity","0.0")}))})),c.on("mouseover",(function(e,t){0===d3.select(this).select("circle.selection-circle").size()&&d3.select(this).select("circle.big-circle").attr("fill-opacity","0.7")})),c},drawNodes(e){let t=d3.line().x((function(e){return e.x})).y((function(e){return e.y}));for(let t of e)calcLineData(n.props.model,t);d3.select("svg").select("g."+a+"s").empty()&&d3.select("svg").select("g.diagram").append("g").attr("class",a+"s");let o=d3.select("svg").select("g."+a+"s").selectAll("g."+a).data(e,(function(e){return n.props.model.ID(e)})),r=o.enter().append("g").attr("class",a).attr("id",(function(e){return"cimdiagram-"+n.props.model.ID(e)}));function i(e){e.attr("x",(function(e){let t=d3.select(this.parentNode).select("path").node();return t.getPointAtLength(t.getTotalLength()/2).x+2})).attr("y",(function(e){let t=d3.select(this.parentNode).select("path").node();return t.getPointAtLength(t.getTotalLength()/2).y-2})).text((function(e){let t=n.props.model.getBusbar(e);if(null!==t){let e=n.props.model.getAttribute(t,"cim:IdentifiedObject.name");if(void 0!==e)return e.innerHTML}return""}))}return o.select("path").attr("d",(function(e){let n=d3.select(this.parentNode).data()[0].lineData;return t(n)})).attr("stroke",(function(e){return n.voltageColor(n.props.model.getBusbar(e),"black")})),r.append("path").attr("d",(function(e){let n=d3.select(this.parentNode).data()[0].lineData;return t(n)})).attr("stroke",(function(e){return n.voltageColor(n.props.model.getBusbar(e),"black")})).attr("stroke-width",2).attr("fill","none"),r.filter((function(e){return null!==n.props.model.getBusbar(e)})).append("text").attr("class","cim-object-text").attr("font-size",3),i(r.select("text")),i(o.select("text")),r},moveTo(e){let t=n.props.model.getObject(e);if(void 0===t)return;if("cim:BusbarSection"===t.nodeName&&(t=n.props.model.getNode(t)),"cim:Substation"===t.nodeName||"cim:Line"===t.nodeName){let e=n.props.model.getTargets([t],"EquipmentContainer.Equipments");for(let a of e){if("cim:BusbarSection"===a.nodeName){let e=n.props.model.getNode(a);null!==e&&(a=e)}if(void 0!==a.x&&void 0!==a.y){t.x=a.x,t.y=a.y;break}}}if("cim:Analog"!==t.nodeName&&"cim:Discrete"!==t.nodeName||(t=n.props.model.getTargets([t],"Measurement.PowerSystemResource")[0],void 0!==t&&"cim:BusbarSection"===t.nodeName&&(t=n.props.model.getNode(t))),"cim:PowerTransformerEnd"===t.nodeName&&(t=n.props.model.getTargets([t],"PowerTransformerEnd.PowerTransformer")[0]),void 0===t.x||void 0===t.y)return;$('[data-toggle="popover"]').popover("hide");let a=parseInt(d3.select("svg").style("width")),o=parseInt(d3.select("svg").style("height")),r=1*-t.x+a/2,i=1*-t.y+o/2,l=d3.transition().duration(750).ease(d3.easeLinear),s=d3.zoomIdentity.translate(r,i).scale(1);d3.selectAll("svg").select("g.diagram").transition(l).attr("transform",s),d3.zoom().transform(d3.selectAll("svg"),s),n.props.dispatcher.trigger("transform")},forceTick(e){0!==arguments.length&&void 0===e.alpha||(e=d3.select("svg").selectAll("svg > g.diagram > g:not(.edges) > g"));let t=d3.zoomTransform(d3.select("svg").node()),a=t.x,o=t.y,r=t.k;if(function(e){e.attr("transform",(function(e){return"translate("+e.x+","+e.y+") rotate("+e.rotation+")"})).selectAll("g.Terminal").each((function(e,t){e.x=d3.select(this.parentNode).datum().x+parseInt(d3.select(this.firstChild).attr("cx")),e.y=d3.select(this.parentNode).datum().y+parseInt(d3.select(this.firstChild).attr("cy"))})),e.selectAll("text.cim-object-text").attr("transform",(function(e){let t=0,n={x:0,y:0};switch(e.rotation%360==180&&(t=-1*e.rotation),e.nodeName){case"cim:Breaker":case"cim:Disconnector":case"cim:LoadBreakSwitch":case"cim:Junction":n={x:0,y:0};break;case"cim:PowerTransformer":n={x:0,y:30};break;default:n={x:d3.select(this).attr("x"),y:d3.select(this).attr("y")}}return"rotate("+t+","+n.x+","+n.y+")"})),e.selectAll("rect.selection-rect").attr("x",0).attr("y",0).attr("width",0).attr("height",0),e.selectAll("rect.selection-rect").attr("x",(function(e){return this.parentNode.getBBox().x})).attr("y",(function(e){return this.parentNode.getBBox().y})).attr("width",(function(e){return this.parentNode.getBBox().width})).attr("height",(function(e){return this.parentNode.getBBox().height})),e.selectAll("g.resize").selectAll("rect").attr("x",(function(e){return e[0].lineData.filter((t=>t.seq===e[1]))[0].x-2})).attr("y",(function(e){return e[0].lineData.filter((t=>t.seq===e[1]))[0].y-2}))}(e),1===arguments.length){let t=n.props.model.getTerminals(e.data()),i=d3.select("svg").selectAll("svg > g.diagram > g.edges > g").filter((function(n){return e.data().indexOf(n.source)>-1||t.indexOf(n.target)>-1}));n.updateEdges(a,o,r,i)}else n.updateEdges(a,o,r)},updateEdges(e,t,a,o){let r=d3.line().x((function(e){return e.x})).y((function(e){return e.y})).curve(d3.curveStepBefore);3===arguments.length&&(o=d3.select("svg").selectAll("svg > g.diagram > g.edges > g")),o.select("path").attr("d",(function(e){let t={x:e.source.x,y:e.source.y},a={x:e.target.x,y:e.target.y};return 0!==e.target.rotation&&(a=rotateTerm(n.props.model,e.target)),e.source.lineData.length>1?e.p=closestPoint(e.source,a):e.p=[0,0],t.x=t.x+e.p[0],t.y=t.y+e.p[1],r([t,a])})).attr("stroke-dasharray",(function(e){let t=n.props.model.getAttribute(e.target,"cim:ACDCTerminal.connected");return void 0!==t&&"false"===t.textContent?"5, 5":null}))},drawGrid(e){let t=parseInt(d3.select("svg").style("width"))/e,n=parseInt(d3.select("svg").style("height"))/e,a=d3.select("svg").select("g.diagram-grid");a.selectAll("*").remove();const o=25;for(let e=o;e<=n-o;e+=o)a.append("svg:line").attr("x1",0).attr("y1",e).attr("x2",t).attr("y2",e).attr("stroke-dasharray","1, 5").style("stroke","rgb(6,120,155)").style("stroke-width",1);for(let e=o;e<=t-o;e+=o)a.append("svg:line").attr("x1",e).attr("y1",0).attr("x2",e).attr("y2",n).attr("stroke-dasharray","1, 5").style("stroke","rgb(6,120,155)").style("stroke-width",1);a.attr("transform","scale("+e+")")},voltageColor(e,a){let o=a;if(null!=e){let a="ConductingEquipment.BaseVoltage";!0===n.props.model.schema.isA("TransformerEnd",e)&&(a="TransformerEnd.BaseVoltage");const r=n.props.model.getTargets([e],a)[0],i=n.props.model.getAttribute(r,"cim:BaseVoltage.nominalVoltage");if(void 0!==i&&""!==i.textContent){const e=i.textContent,n=parseFloat(e);o=t(n)}}return o},drawLegend(){let e=n.props.model.getObjects(["cim:BaseVoltage"])["cim:BaseVoltage"];d3.select("#legend-rect").attr("height",60+20*e.length),e.sort((function(e,t){const a=n.props.model.getAttribute(e,"cim:BaseVoltage.nominalVoltage"),o=n.props.model.getAttribute(t,"cim:BaseVoltage.nominalVoltage");if(void 0!==a&&void 0!==o){const e=a.textContent,t=parseFloat(e),n=o.textContent;return t<parseFloat(n)}return 0})),d3.select("#legend").selectAll("g.voltage").remove();const a=d3.select("#legend").selectAll("g.voltage").data(e).enter().append("g").attr("class","voltage");a.append("rect").attr("x",10).attr("y",(function(e,t){return 50+20*t})).attr("width",40).attr("height",10).attr("fill",(function(e){const a=n.props.model.getAttribute(e,"cim:BaseVoltage.nominalVoltage");if(void 0!==a){const e=a.textContent,n=parseFloat(e);return t(n)}return"black"})).attr("stroke","black"),a.append("text").attr("x",60).attr("y",(function(e,t){return 55+20*t})).attr("dominant-baseline","middle").text((function(e){const t=n.props.model.getAttribute(e,"cim:BaseVoltage.nominalVoltage");if(void 0!==t){if(""!==t.textContent){let e=parseFloat(t.textContent);return e=+e.toFixed(1),e+" kV"}return"n.a."}return"undefined"}))},getTermNode(e){let t=null;const a=n.props.model.getTargets([e],"TransformerEnd.Terminal"),o=n.props.model.ID(a[0]);let r=d3.select("g#cimdiagram-"+o);return 1===r.size()&&(t=r.node()),t}},template:function(e,t,n,a){return e('<cimdiagramcontrols expr18="expr18"></cimdiagramcontrols><div class="app-diagram"><svg width="1200" height="800" style="border: 1px solid black;"><path stroke-width="1" stroke="black" fill="none"/><circle r="3.5" cy="-10" cx="-10"/><g class="brush"></g><g class="diagram-grid"></g><g class="diagram-highlight"><line class="highlight-x"/><line class="highlight-y"/></g><g class="diagram"><g class="edges"></g></g><g id="legend" transform="translate(1050,50)"><rect id="legend-rect" x="0" y="0" width="150" height="100" fill="white"/><text x="75" y="25" text-anchor="middle" font-weight="bold">Legend</text></g></svg></div>',[{type:n.TAG,getComponent:a,evaluate:function(e){return"cimdiagramcontrols"},slots:[],attributes:[{type:t.ATTRIBUTE,name:"model",evaluate:function(e){return e.props.model}},{type:t.ATTRIBUTE,name:"dispatcher",evaluate:function(e){return e.props.dispatcher}}],redundantAttribute:"expr18",selector:"[expr18]"}])},name:"cimdiagram"}})),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).cimDiagramControls=t()}(this,(function(){"use strict";let e=null,t="ConnectivityNode",n="ConnectivityNode.Terminals",a="Terminal.ConnectivityNode",o=d3.quadtree(),r=[],i=[],l=!1,s=!1,c=[{title:"Copy",action:function(t,n){let a=this;!0===e.props.model.schema.isA("TransformerEnd",d3.select(a).datum())&&(a=a.parentElement),-1===r.indexOf(a)&&(r.push(a),e.updateSelected());let o=d3.selectAll(r).data();for(let t of o)if("cim:ConnectivityNode"===t.nodeName){let n=e.props.model.getBusbar(t);null!==n&&(n.x=t.x,n.y=t.y,i.push(n))}else i.push(t)}},{title:"Rotate",action:function(t,n){let a=this;!0===e.props.model.schema.isA("TransformerEnd",d3.select(a).datum())&&(a=a.parentElement),-1===r.indexOf(a)&&(e.deselectAll(),r.push(a),e.updateSelected()),$(r).filter('[data-toggle="popover"]').popover("hide");let o=d3.selectAll(r);e.props.model.getTerminals(o.data()).forEach((function(e){e.rotation=(e.rotation+90)%360}));for(let t of o.data())t.rotation=(t.rotation+90)%360,e.props.model.updateActiveDiagram(t,t.lineData)}},{title:"Delete",action:function(t,n){let a=this;!0===e.props.model.schema.isA("TransformerEnd",d3.select(a).datum())&&(a=a.parentElement),e.deleteObject(a)}},{title:"Delete from current diagram",action:function(t,n){let a=this;!0===e.props.model.schema.isA("TransformerEnd",d3.select(a).datum())&&(a=a.parentElement),e.deleteFromDiagram(a)}},{title:"Show element info",action:function(t,n){let a=this;!0===e.props.model.schema.isA("TransformerEnd",d3.select(a).datum())&&(a=a.parentElement),-1===r.indexOf(a)&&(e.deselectAll(),r.push(a),e.updateSelected()),$(r).filter('[data-toggle="popover"]').popover("show")}},{title:"Add new operational limit set",action:function(t,n){e.addNewLimitSet(this,n)}}],d=c.concat([{title:"Add points",action:function(t,n){let a=e.status,o=this;e.disableAll(),e.deselectAll(),r.push(o),d3.select("svg").on("contextmenu.general",null),e.addDrawing(n,(function(t){let r=d3.select("svg"),i=r.selectAll("svg > path"),l=r.selectAll("svg > circle");switch(t.preventDefault(),e.addNewPoint(n),e.deleteFromDiagram(o),e.props.model.addToActiveDiagram(n,n.lineData),r.on("mousemove",null),i.attr("d",null),l.attr("transform","translate(0, 0)"),d3.select("svg > path").datum(null),r.on("contextmenu.add",null),r.on("click.add",null),a){case"DRAG":e.enableDrag();break;case"ZOOM":e.enableZoom();break;case"CONNECT":e.enableConnect();break;default:{let t=a.substring("ADD".length);t.startsWith("Multi")?(t=t.substring("Multi".length),e.enableAddMulti(t)):e.enableAdd(t);break}}d3.select("svg").on("contextmenu.general",d3.contextMenu(h))})),d3.select("svg").on("click.add",(function(){e.addNewPoint(n)}))}}]),m=[{title:"Delete point",action:function(t,n){let a=d3.selectAll(r).data().filter((e=>e===n[0]))[0];r=r.filter((e=>d3.select(e).datum()!==n[0])),e.deselectAll(),r.push(a),e.updateSelected(),e.deleteFromDiagram(this.parentNode),n[0].lineData=n[0].lineData.filter((e=>e.seq!==n[1]));for(let e of n[0].lineData)e.seq>n[1]&&(e.seq=e.seq-1);e.props.model.addToActiveDiagram(n[0],n[0].lineData)}}],u=[{title:"Add new operational limit set",action:function(t,n){e.addNewLimitSet(this,n)}},{title:"Add regulating control",action:function(t,n){e.addRegulatingControl(this,n)}},{title:"Add tap changer control",action:function(t,n){e.addTCControl(this,n)}}],p=u.concat([{title:"Add ratio tap changer",action:function(t,n){e.addTC(this,n)}}]),g=c.concat([{title:"Add ratio tap changer",action:function(t,n){e.addTC(this,n)}}]),f=[{title:"Delete",action:function(t,a){let o=e.getLinkedCNs([a.target])[0];if(void 0!==o){let t=e.props.model.ID(o.cn),n=d3.select("svg").selectAll("g#cimdiagram-"+t).node();e.deleteObject(n)}else e.props.model.removeLink(a.source,"cim:"+n,a.target)}}],h=[{title:"Paste",disabled:function(e,t){return i.length<1},action:function(t,n){if(i.length<1)return;let a=d3.pointer(t,d3.select("svg").node()),o=d3.zoomTransform(d3.select("svg").node()),r=(o.x,o.y,o.k,a[0]-i[0].x),l=a[1]-i[0].y,s=null;for(let t of i){let n=e.props.model.createObject(t.nodeName);for(let a of e.props.model.getAttributes(t)){let t=a.nodeName,o=a.textContent;e.props.model.setAttribute(n,t,o)}if(n.x=t.x+r,n.y=t.y+l,"cim:BusbarSection"===n.nodeName){let n=e.props.model.getNode(t);if(null===n)return;s=n.lineData}else s=t.lineData;e.props.model.addToActiveDiagram(n,s)}i=[]}}],b=d3.drag().on("drag",(function(t,n){$(r).filter('[data-toggle="popover"]').popover("hide");let a={x:t.x,y:t.y,seq:n[1]},o=e.align(n[0],a,!0);!function(e,t,n){let a=e.lineData.filter((e=>e.seq===t))[0],o=rotate({x:n.x,y:n.y},-1*e.rotation);if(1!==a.seq)a.x=n.x,a.y=n.y;else{e.x=e.x+n.x,e.y=e.y+n.y;for(let t of e.lineData)1!==t.seq&&(t.x=t.x-o.x,t.y=t.y-o.y)}}(n[0],n[1],o),e.props.model.updateActiveDiagram(n[0],n[0].lineData)})).on("start",(function(t,n){e.removeFromQuadtree()})).on("end",(function(t,n){e.highlight(null),e.props.model.updateActiveDiagram(n[0],n[0].lineData),e.addToQuadtree(d3.selectAll(r))}));return{css:null,exports:{onBeforeMount(i,l){e=this,e.props.dispatcher.on("moveTo",(function(t){e.deselectAll();let n=e.props.model.getObject(t),a=null,o=null,i=null,l=null,s=null;if(void 0!==n){switch(n.nodeName){case"cim:Substation":case"cim:Line":a=e.props.model.getTargets([n],"EquipmentContainer.Equipments");for(let t of a)"cim:BusbarSection"===t.nodeName&&(i=e.props.model.getNode(t),null!==i&&(t=i)),s=d3.select("svg").select("#cimdiagram-"+e.props.model.ID(t)).node(),null!==s&&r.push(s);break;case"cim:Analog":case"cim:Discrete":o=e.props.model.getTargets([n],"Measurement.Terminal");for(let t of o)s=d3.select("svg").select("#cimdiagram-"+e.props.model.ID(t)).node(),null!==s&&r.push(s);break;case"cim:BusbarSection":i=e.props.model.getNode(n),l=e.props.model.ID(i),s=d3.select("svg").selectAll("g#cimdiagram-"+l).node(),r=[s];break;default:s=d3.select("svg").selectAll("g#cimdiagram-"+t).node(),r=[s]}e.updateSelected()}})),e.props.dispatcher.on("deselect",(function(){e.deselectAll()})),e.props.dispatcher.on("render",(function(){"BUS_BRANCH"===e.props.model.getMode()?(t="TopologicalNode",n="TopologicalNode.Terminal",a="Terminal.TopologicalNode"):(c.push({title:"Add new measurement",action:function(t,n){e.addNewMeasurement(this,n)}}),d.push({title:"Add new measurement",action:function(t,n){e.addNewMeasurement(this,n)}}),u.push({title:"Add new measurement",action:function(t,n){e.addNewMeasurement(this,n)}}));let r=d3.select("svg").selectAll("svg > g.diagram > g:not(.edges) > g");o.x((function(e){let t=d3.select(e.elm).datum(),n=t.lineData.filter((t=>t.seq===e.seq));return t.x+n[0].x})).y((function(e){let t=d3.select(e.elm).datum(),n=t.lineData.filter((t=>t.seq===e.seq));return t.y+n[0].y})),e.addToQuadtree(r);let i=d3.select("svg").selectAll("svg > g.diagram > g.edges > g");e.addContextMenu(r),d3.select("svg").on("contextmenu.general",d3.contextMenu(h)),i.on("contextmenu",d3.contextMenu(f)),e.disableZoom(),e.disableConnect(),e.enableDrag(),document.querySelector("#cim-diagram-controls").classList.remove("invisible");let l=null;d3.select("body").on("keydown",(function(t){void 0!==t&&t.ctrlKey&&(null===l&&(l=e.status),e.disableDrag(),e.disableZoom(),e.enableZoom())})).on("keyup",(function(t){if(17===t.keyCode){switch(e.disableZoom(),l){case"DRAG":e.enableDrag();break;case"ZOOM":e.enableZoom();break;default:e.status=l}l=null}27===t.keyCode&&d3.contextMenu("close")}))})),e.props.dispatcher.on("addToDiagram",(function(t){1===t.size()&&(e.addToQuadtree(t),"DRAG"===e.status&&(e.disableAll(),e.enableDrag()),e.addContextMenu(t))})),e.props.dispatcher.on("createEdges",(function(e){e.on("contextmenu",d3.contextMenu(f))}))},onMounted(){$("#select").change((function(){e.disableAll(),e.enableDrag()})),$("#pan").change((function(){e.disableAll(),e.enableZoom()})),$("#connect").change((function(){e.disableAll(),e.enableConnect()})),document.querySelector("#legendToggle").addEventListener("change",(function(){const e=d3.transition().duration(750).ease(d3.easeLinear);!1===this.checked?d3.select("#legend").transition(e).attr("transform",d3.zoomIdentity.translate(1200,50)):d3.select("#legend").transition(e).attr("transform",d3.zoomIdentity.translate(1050,50))}))},disableAll(){e.disableDrag(),e.disableZoom(),e.disableConnect(),e.disableAdd()},deselectAll(){d3.selectAll(r).selectAll("rect.selection-rect").remove(),d3.selectAll(r).selectAll("g.resize").remove(),d3.selectAll(r).selectAll("circle.selection-circle").remove(),r=[]},enableDrag(){let t=[];e.disableDrag(),d3.select(e.root).selectAll("#cim-diagram-controls > label:not(#selectLabel)").classed("active",!1),e.status="DRAG";let n=d3.drag().on("start",(function(n,a){if(d3.contextMenu("close"),-1===r.indexOf(this)&&e.deselectAll(),0===r.length&&(r.push(this),e.updateSelected()),e.removeFromQuadtree(),!0===e.props.model.schema.isA("ConductingEquipment",a)){let n=e.props.model.getTerminals([a]);t=e.getLinkedCNs(n)}let o=e.props.model.getTerminals(d3.selectAll(r).data());d3.select("svg").selectAll("svg > g.diagram > g.edges > g").filter((function(e){return d3.selectAll(r).data().indexOf(e.source)>-1||o.indexOf(e.target)>-1})).select("path").attr("stroke","green").attr("stroke-width","3")})).on("drag",(function(n,a){$(r).filter('[data-toggle="popover"]').popover("hide");let o=n.x-a.x,i=n.y-a.y,l={x:0,y:0};for(let t of r){let n=d3.select(t).data()[0];if(n.x=n.x+o,n.px=n.x,n.y=n.y+i,n.py=n.y,0===l.x&&0===l.y)for(let t of n.lineData){let a=e.align(n,t,!1);if(l={x:a.x-t.x,y:a.y-t.y},0!==l.x||0!==l.y){t.seq>1&&(l=rotate(l,n.rotation));break}}}for(let t of r){let n=d3.select(t).data()[0];s(n,null,l),e.props.model.updateActiveDiagram(n,n.lineData)}for(let n of t){let t={x:n.cnTerms[0].x,y:n.cnTerms[0].y},a={x:n.cnTerms[1].x,y:n.cnTerms[1].y};n.cnTerms[0].rotation>0&&(t=rotateTerm(e.props.model,n.cnTerms[0])),n.cnTerms[1].rotation>0&&(a=rotateTerm(e.props.model,n.cnTerms[1])),n.cn.x=(t.x+a.x)/2,n.cn.y=(t.y+a.y)/2,e.props.model.updateActiveDiagram(n.cn,n.cn.lineData)}function s(e,t,n){e.x=e.x+n.x,e.y=e.y+n.y,e.px=e.x,e.py=e.y}})).on("end",(function(n,a){e.addToQuadtree(d3.selectAll(r)),t=[];let o=e.props.model.getTerminals(d3.selectAll(r).data());d3.select("svg").selectAll("svg > g.diagram > g.edges > g").filter((function(e){return d3.selectAll(r).data().indexOf(e.source)>-1||o.indexOf(e.target)>-1})).select("path").attr("stroke","black").attr("stroke-width","1"),e.highlight("x",null),e.highlight("y",null)}));d3.select("svg").selectAll("svg > g.diagram > g:not(.edges) > g").call(n),d3.select("svg").select("g.brush").call(d3.brush().on("start",(function(){let t=window.location.hash.substring(1).split("/"),n=t[0]+"/"+t[1]+"/"+t[2];route.router.push(n),e.deselectAll(),$('[data-toggle="popover"]').popover("hide"),d3.contextMenu("close")})).on("end",(function(t){d3.select("svg").select("g.brush").selectAll("*:not(.overlay)").style("display","none");let n=t.selection;if(null===n)return;e.deselectAll();let a=d3.zoomTransform(d3.select("svg").node()),i=a.x,l=a.y,s=a.k;r=e.search(o,(n[0][0]-i)/s,(n[0][1]-l)/s,(n[1][0]-i)/s,(n[1][1]-l)/s),e.updateSelected()})))},search(e,t,n,a,o){let r=new Set;return e.visit((function(e,i,l,s,c){if(!e.length)do{let i=e.data,l=d3.select(i.elm).datum();for(let e of l.lineData){let s=rotate(e,l.rotation),c=l.x+s.x,d=l.y+s.y;if(c>=t&&c<a&&d>=n&&d<o){r.add(i.elm);break}}}while(e=e.next);return i>=a||l>=o||s<t||c<n})),[...r]},addToQuadtree(e){let t=[];e.each((function(e){for(let n of e.lineData)t.push({elm:this,seq:n.seq})})),o.addAll(t)},removeFromQuadtree(){let e=o.data().filter((e=>r.indexOf(e.elm)>-1));o.removeAll(e)},updateSelected(){d3.selectAll(r).each((function(t){e.hover(this)})).selectAll("g.resize").call(b).filter((function(e){return e[0].lineData.length>2})).on("contextmenu",d3.contextMenu(m))},getLinkedCNs(t){let o=[],r=e.props.model.getTargets(t,a);for(let t of r){if(void 0===t.lineData)continue;if(t.lineData.length>1)continue;let a=e.props.model.getTargets([t],n);if(2===a.length){let e={cn:t,cnTerms:a};o.push(e)}}return o},disableDrag(){d3.select("svg").selectAll("svg > g.diagram > g:not(.edges) > g").on(".drag",null),d3.select("svg").select("g.brush").on(".brush",null),"DRAG"===e.status&&d3.select("svg").select("g.brush").call(d3.brush().move,null)},enableZoom(){e.status="ZOOM",$('[data-toggle="popover"]').popover("hide"),d3.select("svg").selectAll("svg > g.diagram > g:not(.edges) > g").on("click.zoom",(function(t,n){let a=window.location.hash.substring(1).split("/"),o=a[0]+"/"+a[1]+"/"+a[2];route.router.push(o+"/"+e.props.model.ID(n))}));let t=d3.zoom();t.on("zoom",this.zooming),d3.select("svg").call(t)},disableZoom(){d3.select("svg").selectAll("svg > g.diagram > g:not(.edges) > g").on("click.zoom",null),d3.select("svg").on(".zoom",null)},zooming(t){d3.select("svg").select("g.diagram").attr("transform",t.transform),e.props.dispatcher.trigger("transform");let n=d3.select("svg > path").datum();if(void 0===n)return;let a=d3.line().x((function(e){return e.x})).y((function(e){return e.y})),o=d3.select("svg > path"),r=d3.zoomTransform(d3.select("svg").node()),i=d3.select("svg > circle").node().transform.baseVal.consolidate();if(null===i)return;let l=i.matrix,s=l.e-10,c=l.f-10,d=[],m=n.obj;if(void 0===m.lineData)d.push({x:m.x*r.k+r.x,y:m.y*r.k+r.y});else for(let e of m.lineData)d.push({x:(e.x+m.x)*r.k+r.x,y:(e.y+m.y)*r.k+r.y});d.push({x:s,y:c}),o.attr("d",(function(){return a(d)}))},enableConnect(){function n(t){d3.select("svg").selectAll("svg > path").attr("d",null),d3.select("svg").selectAll("svg > circle").attr("transform","translate(0, 0)");let n=d3.select("svg > path").datum();void 0!==n&&(d3.select("svg").on("mousemove",null),e.props.model.setLink(n.obj,"cim:"+a,t),d3.select("svg > path").datum(null))}e.deselectAll(),d3.select("body").on("keyup.connect",(function(t){27===t.keyCode&&(e.disableConnect(),e.enableConnect())})),d3.select(e.root).selectAll("#cim-diagram-controls > label:not(#connectLabel)").classed("active",!1),e.status="CONNECT",d3.select("svg").selectAll("svg > g.diagram > g:not(.edges) > g > g.Terminal").on("click",(function(n,o){let r=d3.line().x((function(e){return e.x})).y((function(e){return e.y})),i={x:o.x,y:o.y};o.rotation>0&&(i=rotateTerm(e.props.model,o));let l=d3.select("svg"),s=d3.select("svg > path"),c=d3.select("svg > circle"),d=s.datum();if(void 0!==d&&(d=d.obj),void 0!==d){let n=e.props.model.getTargets([o],a)[0];if(void 0===n)n=e.props.model.getTargets([d],a)[0];else{let n=e.getLinkedCNs([d]);for(let a of n){let n=e.props.model.ID(a.cn),o=d3.select("svg > g.diagram > g."+t+"s > g#cimdiagram-"+n).node();e.deleteObject(o)}}if(d3.select("svg").selectAll("svg > path").attr("d",null),d3.select("svg").selectAll("svg > circle").attr("transform","translate(0, 0)"),void 0===n){let a={x:d.x,y:d.y};d.rotation>0&&(a=rotateTerm(e.props.model,d)),n=e.props.model.createObject("cim:"+t),e.props.model.setAttribute(n,"cim:IdentifiedObject.name","new1"),n.x=(a.x+i.x)/2,n.y=(a.y+i.y)/2,e.props.model.addToActiveDiagram(n,[{x:0,y:0,seq:1}])}d3.select("svg").on("mousemove",null);let r="cim:"+a;e.props.model.setLink(d,r,n),e.props.model.setLink(o,r,n),s.datum(null)}else{l.on("mousemove",(function(e){let t=d3.pointer(e),n=d3.zoomTransform(d3.select("svg").node());c.attr("transform",(function(){return"translate("+(t[0]+10)+","+(t[1]+10)+")"})),s.attr("d",(function(){let e=i.x*n.k+n.x,a=i.y*n.k+n.y;return r([{x:e,y:a},{x:t[0],y:t[1]}])}))})),s.datum({obj:o})}})),d3.select("svg").selectAll("svg > g.diagram > g."+t+"s > g."+t).on("click",(function(e,t){n(t)})),d3.select("svg").selectAll("svg > g.diagram > g.edges > g").on("click",(function(e,t){n(t.source)}))},disableConnect(){d3.select("body").on("keyup.connect",null),d3.select("svg").selectAll("svg > g.diagram > g:not(.edges) > g > g.Terminal").on("click",null),d3.select("svg").selectAll("svg > g.diagram > g."+t+"s > g."+t).on("click",null),d3.select("svg").selectAll("svg > g.diagram > g.edges > g").on("click",null),d3.select("svg").on("mousemove",null),d3.select("svg > path").attr("d",null),d3.select("svg > circle").attr("transform","translate(0, 0)");let e=d3.select("svg > path").datum();void 0!==e&&"cim:Terminal"===e.nodeName&&d3.select("svg > path").datum(null)},enableAdd(t){let n="",a="";"object"==typeof t?(n=t.target.id,a=t.target.textContent):(n=t,a=d3.select("#"+n).text());let o=void 0;"Three-winding Transformer"===a&&(o={windNum:3}),e.disableAll(),d3.select(e.root).selectAll("#cim-diagram-controls > label").classed("active",!1),document.querySelector("cimDiagramControls").querySelectorAll("input").forEach((function(e){e.checked=!1})),document.querySelector("#addElement").textContent=a,e.status="ADD"+n,d3.select("svg").on("click.add",(function(t){if(!1===t.ctrlKey){let a=e.props.model.createObject("cim:"+n,o);addToDiagram(e.props.model,t,a)}}))},enableAddMulti(t){let n="",a="",o=d3.select("svg"),r=o.selectAll("svg > path"),i=o.selectAll("svg > circle");e.disableAll(),d3.select("svg").on("contextmenu.general",null),d3.select("body").on("keyup.addMulti",(function(n){27===n.keyCode&&(e.disableAdd(),e.enableAddMulti(t))})),"object"==typeof t?(n=t.target.id,a=t.target.textContent):(n=t,a=d3.select("#"+n).text()),d3.select(e.root).selectAll("#cim-diagram-controls > label").classed("active",!1),document.querySelector("cimDiagramControls").querySelectorAll("input").forEach((function(e){e.checked=!1})),document.querySelector("#addElement").textContent=a,e.status="ADDMulti"+n,d3.select("svg").on("click.add",(function(t){if(!1===t.ctrlKey)if(e.status==="ADDMulti"+n){l=e.props.model.createObject("cim:"+n);let a=d3.pointer(t),s=d3.zoomTransform(d3.select("svg").node()),c=s.x,d=s.y,m=s.k;l.x=Math.round((a[0]-c)/m),l.px=l.x,l.y=Math.round((a[1]-d)/m),l.py=l.y,l.lineData=[{x:0,y:0,seq:1}],l.rotation=0,e.addDrawing(l,(function(t){t.preventDefault(),e.addNewPoint(l),e.props.model.addToActiveDiagram(l,l.lineData),e.status="ADDMulti"+n,o.on("mousemove",null),r.attr("d",null),i.attr("transform","translate(0, 0)"),d3.select("svg > path").datum(null),o.on("contextmenu.add",null)}))}else e.addNewPoint(l)}));let l=void 0},addDrawing(t,n){e.status="ADDdrawing";let a=d3.select("svg");a.on("contextmenu.add",n),a.on("mousemove",(function(n){let o=d3.pointer(n),r=d3.zoomTransform(a.node()),i=(o[0]-r.x)/r.k,l=(o[1]-r.y)/r.k,s=rotate({x:i-t.x,y:l-t.y,seq:null},-1*t.rotation),c=rotate(e.align(t,s,!0),t.rotation);!function(e,n,o){let r=d3.zoomTransform(a.node()),i=a.selectAll("svg > path"),l=a.selectAll("svg > circle"),s=d3.line().x((function(e){return e.x})).y((function(e){return e.y}));l.attr("transform",(function(){return"translate("+((e.x+o.x)*r.k+r.x+10)+","+((e.y+o.y)*r.k+r.y+10)+")"})),i.attr("d",(function(){let n=[];for(let a of e.lineData){let o=rotate(a,t.rotation);n.push({x:(o.x+e.x)*r.k+r.x,y:(o.y+e.y)*r.k+r.y})}return n.push({x:(e.x+o.x)*r.k+r.x,y:(e.y+o.y)*r.k+r.y}),s(n)})),i.datum({obj:t,x:e.x+o.x,y:e.y+o.y})}(t,0,c)}))},addNewPoint(t){let n=d3.select("svg").selectAll("svg > path").datum(),a=n.x-t.x,o=n.y-t.y,r=t.lineData.length+1,i=rotate({x:a,y:o},-1*t.rotation);t.lineData.push({x:i.x,y:i.y,seq:r}),e.highlight(null)},align(t,n,a){let r=d3.zoomTransform(d3.select("svg").node()),i=!1,c=!1,d=rotate(n,t.rotation),m=t.x+d.x,u=t.y+d.y,p=d.x,g=d.y,f=m-250/r.k,h=u-250/r.k,b=m+250/r.k,v=u+250/r.k,y=e.search(o,f,h,b,v),x=d3.selectAll(y).data();!0===a&&x.push(t);for(let a of x)e:for(let o of a.lineData){if(a===t&&o.seq===n.seq)continue e;let d=rotate(o,a.rotation),f=d.x+a.x,h=d.y+a.y,b=m-f,v=u-h;if(Math.abs(b)<5){m=f,p=m-t.x;let n=f*r.k+r.x;e.highlight("x",n),i=!0,l=!0}if(Math.abs(v)<5){u=h,g=u-t.y;let n=h*r.k+r.y;e.highlight("y",n),c=!0,s=!0}}!1===i&&!0===l&&(e.highlight("x",null),l=!1),!1===c&&!0===s&&(e.highlight("y",null),s=!1);let T={x:p,y:g},A=rotate(T,-1*t.rotation);return 1===n.seq?T:A},highlight(e,t,n){let a=d3.select("svg").select("g.diagram-highlight"),o=null,r=null,i=null,l=null,s=parseInt(d3.select("svg").style("height")),c=parseInt(d3.select("svg").style("width")),d=2*Math.max(s,c);"x"===e?(o=t,r=-1*d,i=t,l=d,a.select("line.highlight-x").attr("x1",o).attr("y1",r).attr("x2",i).attr("y2",l)):"y"===e?(o=-1*d,r=t,i=d,l=t,a.select("line.highlight-y").attr("x1",o).attr("y1",r).attr("x2",i).attr("y2",l)):(a.select("line.highlight-x").attr("x1",o).attr("y1",r).attr("x2",i).attr("y2",l),a.select("line.highlight-y").attr("x1",o).attr("y1",r).attr("x2",i).attr("y2",l)),3===arguments.length?a.attr("transform","rotate("+n.val+","+n.x+","+n.y+")"):a.attr("transform",null)},disableAdd(){document.querySelector("#addElement").textContent="Insert element",d3.select("body").on("keyup.addMulti",null),d3.select("svg").on("click.add",null),d3.select("svg").on("contextmenu.add",null),d3.select("svg").on("contextmenu.general",d3.contextMenu(h)),d3.select("svg").on("mousemove",null),d3.select("svg > path").attr("d",null),d3.select("svg > circle").attr("transform","translate(0, 0)");let t=d3.select("svg > path").datum();if(void 0!==t){0===e.props.model.getDiagramObjects([t.obj]).length?e.props.model.deleteObject(t.obj):calcLineData(e.props.model,t.obj)}d3.select("svg > path").datum(null),e.highlight("x",null),e.highlight("y",null)},hover(e){let n=d3.select(e);n.filter("g:not(.ACLineSegment)").filter("g:not(."+t+")").filter("g:not(.Terminal)").each((function(e){d3.select(this).append("rect").attr("x",this.getBBox().x).attr("y",this.getBBox().y).attr("width",this.getBBox().width).attr("height",this.getBBox().height).attr("stroke","black").attr("stroke-width",2).attr("stroke-dasharray","5,5").attr("fill","none").attr("class","selection-rect")})),n.filter("g.ACLineSegment,g."+t).selectAll("g.resize").data((function(e){return e.lineData.map((t=>[e,t.seq]))})).enter().append("g").attr("class","resize").append("rect").attr("x",(function(e){return e[0].lineData.filter((t=>t.seq===e[1]))[0].x-2})).attr("y",(function(e){return e[0].lineData.filter((t=>t.seq===e[1]))[0].y-2})).attr("width",4).attr("height",4),n.filter("g.Terminal").each((function(e){let t=d3.select(this).select("circle");d3.select(this).append("circle").attr("cx",t.attr("cx")).attr("cy",t.attr("cy")).attr("r",8).attr("stroke-width",0).attr("fill","red").attr("fill-opacity","0.7").attr("class","selection-circle")}))},addNewMeasurement(n,a){e.deselectAll(),"cim:Terminal"!==a.nodeName&&(r.push(n),e.updateSelected());let o=null;if(o=!0===e.props.model.schema.isA("Switch",a)?e.props.model.createObject("cim:Discrete"):e.props.model.createObject("cim:Analog"),"cim:Terminal"===a.nodeName){let t=e.props.model.getTargets([a],"Terminal.ConductingEquipment")[0];e.props.model.setLink(o,"cim:Measurement.Terminal",a),e.props.model.setLink(o,"cim:Measurement.PowerSystemResource",t)}else if(a.nodeName==="cim:"+t){let t=e.props.model.getBusbar(a);null!==t&&e.props.model.setLink(o,"cim:Measurement.PowerSystemResource",t)}else e.props.model.setLink(o,"cim:Measurement.PowerSystemResource",a);e.props.model.addToActiveDiagram(o,[])},addNewLimitSet(n,a){e.deselectAll();let o=n,i=a;!0===e.props.model.schema.isA("TransformerEnd",d3.select(n).datum())&&(o=n.parentElement,i=d3.select(o).datum()),"cim:Terminal"!==i.nodeName&&(r.push(o),e.updateSelected());let l=e.props.model.createObject("cim:OperationalLimitSet");if("cim:Terminal"===i.nodeName){e.props.model.getTargets([i],"Terminal.ConductingEquipment")[0];e.props.model.setLink(l,"cim:OperationalLimitSet.Terminal",i)}else if(i.nodeName==="cim:"+t){let t=e.props.model.getBusbar(i);null!==t&&e.props.model.setLink(l,"cim:OperationalLimitSet.Equipment",t)}else e.props.model.setLink(l,"cim:OperationalLimitSet.Equipment",i);e.props.model.addToActiveDiagram(l,[])},addRegulatingControl(t,n){e.deselectAll();let a=e.props.model.createObject("cim:RegulatingControl");e.props.model.setLink(a,"cim:RegulatingControl.Terminal",n),e.props.model.addToActiveDiagram(a,[])},addTCControl(t,n){e.deselectAll();let a=e.props.model.createObject("cim:TapChangerControl");e.props.model.setLink(a,"cim:RegulatingControl.Terminal",n),e.props.model.addToActiveDiagram(a,[])},addTC(t,n){e.deselectAll();let a=n;if(!0===e.props.model.schema.isA("Terminal",n)&&(a=e.props.model.getTargets([n],"Terminal.TransformerEnd")[0]),0===e.props.model.getTargets([a],"TransformerEnd.RatioTapChanger").length){let t=e.props.model.createObject("cim:RatioTapChanger");e.props.model.setLink(t,"cim:RatioTapChanger.TransformerEnd",a),e.props.model.addToActiveDiagram(t,[])}},addContextMenu(e){e.filter("g:not(.ACLineSegment)").filter("g:not(."+t+")").filter("g:not(.PowerTransformer)").on("contextmenu",d3.contextMenu(c)),e.filter("g.ACLineSegment,g."+t).selectAll("path").on("contextmenu",(function(e,t){d3.contextMenu(d).bind(this.parentNode)(e,t),e.stopPropagation()})),e.filter("g:not(.PowerTransformer)").selectAll("g.Terminal").on("contextmenu",(function(e,t){d3.contextMenu(u).bind(this)(e,t),e.stopPropagation()})),e.filter("g.PowerTransformer").selectAll("g.Terminal").on("contextmenu",(function(e,t){d3.contextMenu(p).bind(this)(e,t),e.stopPropagation()})),e.filter("g.PowerTransformer").selectAll("g.TransformerEnd").on("contextmenu",(function(e,t){d3.contextMenu(g).bind(this)(e,t),e.stopPropagation()}))},deleteObject(t){let n=e.deleteSelection(t);e.props.model.deleteObjects(n.data())},deleteFromDiagram(t){let n=e.deleteSelection(t);for(let t of n.data())e.props.model.deleteFromDiagram(t)},deleteSelection(n){-1===r.indexOf(n)&&(e.deselectAll(),r.push(n));let a=d3.selectAll(r),o=e.props.model.getTerminals(a.data()),i=e.getLinkedCNs(o);for(let n of i){let a=e.props.model.ID(n.cn),o=d3.select("svg > g.diagram > g."+t+"s > g#cimdiagram-"+a).node();r.push(o)}return e.removeFromQuadtree(),a=d3.selectAll(r),$(r).filter('[data-toggle="popover"]').popover("dispose"),a.remove(),a}},template:function(e,t,n,a){return e('<div class="container-fluid"><div class="row justify-content-center"><div class="col-md-auto"><div class="btn-toolbar" role="toolbar"><div class="btn-group btn-group-toggle invisible" data-toggle="buttons" id="cim-diagram-controls"><label class="btn btn-secondary active" id="selectLabel"><input type="radio" id="select" name="tool" value="select" autocomplete="off" checked/>select\n                        </label><label class="btn btn-secondary" id="panLabel"><input type="radio" id="pan" name="tool" value="pan" autocomplete="off"/>pan\n                        </label><label class="btn btn-secondary" id="connectLabel"><input type="radio" id="connect" name="tool" value="connect" autocomplete="off"/>edit connections\n                        </label></div><div class="btn-group" role="group"><button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span id="addElement">Insert element</span><span class="caret"></span></button><div class="dropdown-menu" id="cimElementList"><h6 class="dropdown-header">Busses</h6><a expr3="expr3" class="dropdown-item" id="BusbarSection">Node</a><h6 class="dropdown-header">Branches</h6><a expr4="expr4" class="dropdown-item" id="ACLineSegment">AC Line Segment</a><h6 class="dropdown-header">Switches</h6><a expr5="expr5" class="dropdown-item" id="Breaker">Breaker</a><a expr6="expr6" class="dropdown-item" id="Disconnector">Disconnector</a><a expr7="expr7" class="dropdown-item" id="LoadBreakSwitch">Load Break Switch</a><h6 class="dropdown-header">Equivalents</h6><a expr8="expr8" class="dropdown-item" id="EnergySource">Energy Source</a><h6 class="dropdown-header">Rotating Machines</h6><a expr9="expr9" class="dropdown-item" id="SynchronousMachine">Synchronous Machine</a><a expr10="expr10" class="dropdown-item" id="AsynchronousMachine">Asynchronous Machine</a><h6 class="dropdown-header">Loads</h6><a expr11="expr11" class="dropdown-item" id="EnergyConsumer">Energy Consumer</a><a expr12="expr12" class="dropdown-item" id="ConformLoad">Conform Load</a><a expr13="expr13" class="dropdown-item" id="NonConformLoad">Non Conform Load</a><h6 class="dropdown-header">Compensators</h6><a expr14="expr14" class="dropdown-item" id="LinearShuntCompensator">Linear</a><a expr15="expr15" class="dropdown-item" id="NonlinearShuntCompensator">Nonlinear</a><h6 class="dropdown-header">Transformers</h6><a expr16="expr16" class="dropdown-item" id="PowerTransformer">Two-winding Transformer</a><a expr17="expr17" class="dropdown-item" id="PowerTransformer">Three-winding Transformer</a></div></div><div class="btn-group-toggle" data-toggle="buttons"><label class="btn btn-secondary active" id="legendLabel"><input type="checkbox" id="legendToggle" checked/> Show legend\n                        </label></div></div></div></div></div>',[{redundantAttribute:"expr3",selector:"[expr3]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAddMulti}}]},{redundantAttribute:"expr4",selector:"[expr4]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAddMulti}}]},{redundantAttribute:"expr5",selector:"[expr5]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr6",selector:"[expr6]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr7",selector:"[expr7]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr8",selector:"[expr8]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr9",selector:"[expr9]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr10",selector:"[expr10]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr11",selector:"[expr11]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr12",selector:"[expr12]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr13",selector:"[expr13]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr14",selector:"[expr14]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr15",selector:"[expr15]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr16",selector:"[expr16]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]},{redundantAttribute:"expr17",selector:"[expr17]",expressions:[{type:t.EVENT,name:"onclick",evaluate:function(e){return e.enableAdd}}]}])},name:"cimdiagramcontrols"}})),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).cimTree=t()}(this,(function(){"use strict";let e=null,t=d3.contextMenu([{title:"Delete",action:function(t,n){e.props.model.deleteObject(n)}}]),n=null;return{css:'cimtree .tree,[is="cimtree"] .tree{ display: flex; flex-flow: column; max-height: 800px; min-width: 500px; resize: horizontal; padding-top: 10px; overflow: auto; } cimtree .tab-content,[is="cimtree"] .tab-content{ overflow: scroll; } cimtree .cim-tree-attribute-name,[is="cimtree"] .cim-tree-attribute-name{ text-align: left; min-width: 200px; } cimtree .cim-tree-attribute-uom,[is="cimtree"] .cim-tree-attribute-uom{ width: 70px; } cimtree .cim-tree-btn-group,[is="cimtree"] .cim-tree-btn-group{ flex-grow: 1; } cimtree .cim-tree-dropdown-toggle,[is="cimtree"] .cim-tree-dropdown-toggle{ flex-grow: 1; } cimtree ul,[is="cimtree"] ul{ list-style-type: none; } cimtree #tree-link-dialog,[is="cimtree"] #tree-link-dialog{ max-width: 18rem; align-self: center; min-width: 90%; min-height: min-content; } cimtree #tree-link-dialog > .card-body,[is="cimtree"] #tree-link-dialog > .card-body{ text-align: center; } cimtree #tree-controls,[is="cimtree"] #tree-controls{ padding-bottom: 10px; align-self: center; flex-shrink: 0; width: 370px; } cimtree #cim-search-form,[is="cimtree"] #cim-search-form{ align-self: center; max-width: 600px; padding-right: 20px; padding-left: 20px; padding-bottom: 20px; } cimtree .list-group-item > div,[is="cimtree"] .list-group-item > div{ width: 100%; } cimtree .cim-tree-btn-group > .cimLinkBtn,[is="cimtree"] .cim-tree-btn-group > .cimLinkBtn{ flex-grow: 1; } cimtree .tree > .nav-tabs,[is="cimtree"] .tree > .nav-tabs{ flex-shrink: 0; } cimtree .cim-expand-object,[is="cimtree"] .cim-expand-object{ border: transparent; } cimtree .cim-expand-object:focus,[is="cimtree"] .cim-expand-object:focus{ box-shadow: initial; } cimtree .cim-expand-object:hover,[is="cimtree"] .cim-expand-object:hover{ color: #6c757d; background-color: transparent; }',exports:{onBeforeMount(t,n){e=this,e.state.mode="default",t.dispatcher.on("showDiagram",(function(t,n,a){decodeURI(n)!==e.state.diagramName&&(d3.drag().on("drag.end",null),e.render(n)),void 0!==a?e.moveTo(a):d3.select(".tree").selectAll(".btn-danger").classed("btn-danger",!1).classed("btn-primary",!0)}))},onMounted(){document.getElementById("cim-search-key").addEventListener("keyup",(function(t){if("Enter"===t.key){let t=document.getElementById("cim-search-case").classList.contains("active"),a=document.getElementById("cim-search-key").value;if(""===a)document.getElementById("cim-search-results").classList.add("d-none"),n=null;else{let o=[];document.getElementById("app-tree").querySelectorAll("ul:not(.CIM-object-list)").forEach((function(e){let n=null;n=!0===t?Array.prototype.filter.call(e.querySelectorAll("li.CIM-object>button.cim-object-btn"),(function(e){return e.textContent.indexOf(a)>=0})):Array.prototype.filter.call(e.querySelectorAll("li.CIM-object>button.cim-object-btn"),(function(e){let t=a.toLocaleLowerCase();return e.textContent.toLocaleLowerCase().indexOf(t)>=0})),o=o.concat(n)})),o=[...new Set(o)],document.getElementById("cim-search-results").classList.remove("d-none"),o.length>0?(document.querySelector("#cim-search-results > span").textContent="Result 1 of "+o.length,n={elements:d3.selectAll(o).data(),actualResult:0},e.moveTo(e.props.model.ID(n.elements[n.actualResult]))):document.querySelector("#cim-search-results > span").textContent="Text not found"}}})),document.getElementById("cim-search-next").addEventListener("click",(function(){if(null!==n&&n.actualResult<n.elements.length-1){n.actualResult=n.actualResult+1;let t=n.actualResult+1;document.querySelector("#cim-search-results > span").textContent="Result "+t+" of "+n.elements.length,e.moveTo(e.props.model.ID(n.elements[n.actualResult]))}})),document.getElementById("cim-search-prev").addEventListener("click",(function(){if(null!==n&&n.actualResult>0){n.actualResult=n.actualResult-1;let t=n.actualResult+1;document.querySelector("#cim-search-results > span").textContent="Result "+t+" of "+n.elements.length,e.moveTo(e.props.model.ID(n.elements[n.actualResult]))}})),document.getElementById("showAllObjects").addEventListener("change",(function(){e.createTree(this.checked)})),document.getElementById("sshInput").addEventListener("change",(function(){e.resetAttrs()})),document.querySelectorAll('a[data-toggle="tab"]').forEach((t=>t.addEventListener("click",(function(t){e.goToBasePath()})))),e.props.model.on("addToActiveDiagram",(function(t){e.addNewObject(t)})),e.props.model.on("deleteObject",(function(t){e.deleteObject(t)})),e.props.model.on("deleteFromDiagram",(function(t){!1===document.getElementById("showAllObjects").checked&&e.deleteObject(t)})),e.props.model.on("setAttribute",(function(t,n,a){if("cim:IdentifiedObject.name"===n){t.localName;let n=d3.select("div.tree").selectAll("ul#"+e.props.model.ID(t));if(!1===n.empty()){d3.select(n.node().parentNode).select("button").html(a)}document.querySelectorAll('[cim-target="'+e.props.model.ID(t)+'"]').innerHTML=a}})),e.props.model.on("addLink",(function(t,n,a){let o=e.props.model.ID(t),r=d3.select(".tree").select("#"+o),i=r.selectAll("#cimRemoveBtn").filter((function(e){return e.attributes[0].value==="#"+n.split(":")[1]}));r.selectAll(".cimLinkBtn").filter((function(e){return e.attributes[0].value==="#"+n.split(":")[1]})).html((function(){return e.props.model.getAttribute(a,"cim:IdentifiedObject.name").textContent})).attr("cim-target",(function(){return e.props.model.ID(a)})).attr("disabled",null),r.selectAll("#cimTarget").attr("id",null),i.attr("disabled",null),"BUS_BRANCH"===e.props.model.getMode()&&"cim:BusbarSection"===t.nodeName&&"cim:ConductingEquipment.BaseVoltage"===n&&e.props.model.setLink(e.props.model.getNode(t),"cim:TopologicalNode.BaseVoltage",a)})),e.props.model.on("removeLink",(function(t,n,a){let o=e.props.model.ID(t),r=d3.select(".tree").select("#"+o),i=r.selectAll("#cimRemoveBtn").filter((function(e){return e.attributes[0].value==="#"+n.split(":")[1]})),l=r.selectAll(".cimLinkBtn").filter((function(e){return e.attributes[0].value==="#"+n.split(":")[1]}));i.attr("disabled","disabled"),l.html("none").attr("cim-target","none").attr("disabled","disabled")})),e.props.model.on("createdDiagram",(function(){e.state.diagramName=decodeURI(e.props.model.activeDiagramName),document.getElementById("showAllObjects").checked=!1,document.getElementById("showAllObjects").dispatchEvent(new MouseEvent("click"))})),e.props.model.on("setMode",(function(t){"BUS_BRANCH"===e.state.mode&&(document.getElementById("measurementsTab").style.display=null)}))},goToBasePath(){let e=window.location.hash.substring(1).split("/");if(e.length>3){let t=e[0]+"/"+e[1]+"/"+e[2];route.router.push(t)}},addNewObject(t){let n=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMComponents"),a=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMContainers"),o=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMMeasurements"),r=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMBases"),i=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMCurvesAndRegs"),l=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMLimits"),s=void 0,c=void 0,d=void 0,m=void 0,u=void 0;switch(t.nodeName){case"cim:ACLineSegment":e.elements(n,"ACLineSegment","AC Line Segments",[t]);break;case"cim:Breaker":e.elements(n,"Breaker","Breakers",[t]);break;case"cim:Disconnector":e.elements(n,"Disconnector","Disconnectors",[t]);break;case"cim:LoadBreakSwitch":e.elements(n,"LoadBreakSwitch","Load Break Switches",[t]);break;case"cim:Junction":e.elements(n,"Junction","Junctions",[t]);break;case"cim:EnergySource":s=e.createTopContainer(n,"Equivalent","Equivalents",[t]),e.elements(s,"EnergySource","Energy Sources",[t]);break;case"cim:SynchronousMachine":c=e.createTopContainer(n,"RotatingMachine","RotatingMachines",[t]),e.elements(c,"SynchronousMachine","Synchronous Machines",[t]);break;case"cim:AsynchronousMachine":c=e.createTopContainer(n,"RotatingMachine","RotatingMachines",[t]),e.elements(c,"AsynchronousMachine","Asynchronous Machines",[t]);break;case"cim:EnergyConsumer":d=e.createTopContainer(n,"Load","Loads",[t]),e.elements(d,"EnergyConsumer","Energy Consumers",[t]);break;case"cim:ConformLoad":d=e.createTopContainer(n,"Load","Loads",[t]),e.elements(d,"ConformLoad","Conform Loads",[t]);break;case"cim:NonConformLoad":d=e.createTopContainer(n,"Load","Loads",[t]),e.elements(d,"NonConformLoad","Non Conform Loads",[t]);break;case"cim:LinearShuntCompensator":m=e.createTopContainer(n,"Compensator","Compensators",[t]),e.elements(m,"LinearShuntCompensator","Linear",[t]);break;case"cim:NonlinearShuntCompensator":m=e.createTopContainer(n,"Compensator","Compensators",[t]),e.nlCompensators(m,[t]);break;case"cim:NonlinearShuntCompensatorPoint":let p=e.props.model.getTargets([t],"NonlinearShuntCompensatorPoint.NonlinearShuntCompensator"),g=e.props.model.ID(p[0]),f=n.selectAll("ul#"+g);e.nlCompensatorPoints(f,[t]);break;case"cim:PowerTransformer":e.powerTransformers(n,[t]);break;case"cim:RatioTapChanger":let h=e.props.model.getTargets([t],"RatioTapChanger.TransformerEnd"),b=e.props.model.ID(h[0]),v=n.selectAll("ul#"+b);e.tapChangers(v,[t]);break;case"cim:BusbarSection":e.elements(n,"BusbarSection","Nodes",[t]);break;case"cim:BaseVoltage":let y=e.elements(r,"BaseVoltage","Base Voltages",[t]);e.createDeleteMenu(y);break;case"cim:GeographicalRegion":e.geoRegions(a,[t]);break;case"cim:SubGeographicalRegion":let x=e.props.model.getTargets([t],"SubGeographicalRegion.Region"),T=e.props.model.ID(x[0]),A=a.selectAll("ul#"+T);e.subGeoRegions(A,[t]);break;case"cim:Substation":e.substations(a,[t]);break;case"cim:VoltageLevel":let w=e.props.model.getTargets([t],"VoltageLevel.Substation"),C=e.props.model.ID(w[0]),N=a.selectAll("ul#"+C);e.voltageLevels(N,[t]);break;case"cim:Bay":let S=e.props.model.getTargets([t],"Bay.VoltageLevel"),E=e.props.model.ID(S[0]),L=a.selectAll("ul#"+E);e.bays(L,[t]);break;case"cim:Line":let k=e.elements(a,"Line","Lines",[t]);e.createDeleteMenu(k);break;case"cim:GeneratingUnit":u=e.createTopContainer(a,"GeneralGeneratingUnit","Generating Units",[t]),e.elements(u,"GeneratingUnit","General Units",[t]);break;case"cim:ThermalGeneratingUnit":u=e.createTopContainer(a,"GeneralGeneratingUnit","Generating Units",[t]),e.elements(u,"ThermalGeneratingUnit","Thermal Units",[t]);break;case"cim:Analog":let D=e.elements(o,"Analog","Analogs",[t]);e.createDeleteMenu(D);break;case"cim:Discrete":let M=e.elements(o,"Discrete","Discretes",[t]);e.createDeleteMenu(M);break;case"cim:LoadResponseCharacteristic":let I=e.elements(i,"LoadResponseCharacteristic","Load Response Characteristics",[t]);e.createDeleteMenu(I);break;case"cim:TapChangerControl":let B=e.elements(i,"TapChangerControl","Tap Changer Controls",[t]);e.createDeleteMenu(B);break;case"cim:RegulatingControl":let O=e.elements(i,"RegulatingControl","Regulating Controls",[t]);e.createDeleteMenu(O);break;case"cim:OperationalLimitType":let j=e.elements(l,"OperationalLimitType","Operational Limit Types",[t]);e.createDeleteMenu(j);case"cim:OperationalLimitSet":e.limitSets(l,[t]);break;case"cim:VoltageLimit":case"cim:CurrentLimit":case"cim:ActivePowerLimit":case"cim:ApparentPowerLimit":let R=e.props.model.getTargets([t],"OperationalLimit.OperationalLimitSet"),P=e.props.model.ID(R[0]),q=l.selectAll("ul#"+P);e.limits(q,[t])}},createTree(t){let n=function*(t){d3.select("#app-tree").selectAll("#CIMComponents > li").remove(),d3.select("#app-tree").selectAll("#CIMContainers > li").remove(),d3.select("#app-tree").selectAll("#CIMMeasurements > li").remove(),d3.select("#app-tree").selectAll("#CIMBases > li").remove(),d3.select("#app-tree").selectAll("#CIMCurvesAndRegs > li").remove(),d3.select("#app-tree").selectAll("#CIMLimits > li").remove();let n=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMComponents"),a=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMContainers"),o=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMMeasurements"),r=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMBases"),i=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMCurvesAndRegs"),l=d3.select("div.tree > div.tab-content > div.tab-pane > ul#CIMLimits"),s=["cim:Substation","cim:Line"],c=["cim:Analog","cim:Discrete"],d=["cim:GeneratingUnit","cim:ThermalGeneratingUnit"],m=null,u=null,p=null,g=null,f=null,h=null,b=null,v=e.props.model.getObjects,y=e.props.model.getObjects;!1===t&&(v=e.props.model.getGraphicObjects,y=e.props.model.getConnectors);if("BUS_BRANCH"===e.props.model.getMode()){let t=e.props.model.getObjects(["cim:BusbarSection","cim:TopologicalNode"]);0===t["cim:BusbarSection"].length&&t["cim:TopologicalNode"].forEach((function(t){let n=e.props.model.createObject("cim:BusbarSection",{node:t}),a=e.props.model.getAttribute(t,"cim:IdentifiedObject.name");void 0!==a&&e.props.model.setAttribute(n,"cim:IdentifiedObject.name",a.innerHTML)}))}let x=v(["cim:BusbarSection","cim:PowerTransformer","cim:ACLineSegment","cim:Breaker","cim:Disconnector","cim:LoadBreakSwitch","cim:Junction","cim:EnergySource","cim:EquivalentInjection","cim:SynchronousMachine","cim:AsynchronousMachine","cim:EnergyConsumer","cim:ConformLoad","cim:NonConformLoad","cim:LinearShuntCompensator","cim:NonlinearShuntCompensator"]);yield"TREE: extracted equipments",g=v(["cim:SubGeographicalRegion"])["cim:SubGeographicalRegion"],f=v(["cim:GeographicalRegion"])["cim:GeographicalRegion"],!1===t?(m=e.props.model.getLinkedObjects(s,["EquipmentContainer.Equipments","Substation.VoltageLevels/EquipmentContainer.Equipments","Substation.VoltageLevels/VoltageLevel.Bays/EquipmentContainer.Equipments"]),u=e.props.model.getLinkedObjects(c,["Measurement.PowerSystemResource"]),p=e.props.model.getLinkedObjects(d,["GeneratingUnit.RotatingMachine"]),g=g.concat(e.props.model.getTargets(m["cim:Substation"],"Substation.Region")),f=f.concat(e.props.model.getTargets(g,"SubGeographicalRegion.Region")),g=[...new Set(g)],f=[...new Set(f)],h=e.props.model.getLinkedObjects(["cim:LoadResponseCharacteristic"],["LoadResponseCharacteristic.EnergyConsumer"]),b=e.props.model.getLinkedObjects(["cim:OperationalLimitSet"],["OperationalLimitSet.Equipment","OperationalLimitSet.Terminal/Terminal.ConductingEquipment"])):(m=v(s),u=v(c),p=v(d),h=v(["cim:LoadResponseCharacteristic"]),b=v(["cim:OperationalLimitSet"]));let T=e.props.model.getObjects(["cim:BaseVoltage","cim:TapChangerControl","cim:RegulatingControl","cim:OperationalLimitType"]),A=y(["cim:BusbarSection"])["cim:BusbarSection"],w=x["cim:EnergySource"].concat(x["cim:EquivalentInjection"]),C=x["cim:SynchronousMachine"].concat(x["cim:AsynchronousMachine"]),N=x["cim:EnergyConsumer"].concat(x["cim:ConformLoad"]).concat(x["cim:NonConformLoad"]),S=x["cim:LinearShuntCompensator"].concat(x["cim:nonlinearShuntCompensator"]),E=e.elements(o,"Analog","Analogs",u["cim:Analog"]);e.createDeleteMenu(E);let L=e.elements(o,"Discrete","Discretes",u["cim:Discrete"]);e.createDeleteMenu(L);let k=e.elements(r,"BaseVoltage","Base Voltages",T["cim:BaseVoltage"]);e.createDeleteMenu(k),e.elements(n,"ACLineSegment","AC Line Segments",x["cim:ACLineSegment"]),e.elements(n,"Breaker","Breakers",x["cim:Breaker"]),e.elements(n,"Disconnector","Disconnectors",x["cim:Disconnector"]),e.elements(n,"LoadBreakSwitch","Load Break Switches",x["cim:LoadBreakSwitch"]),e.elements(n,"Junction","Junctions",x["cim:Junction"]);let D=e.createTopContainer(n,"Equivalent","Equivalents",w);e.elements(D,"EnergySource","Energy Sources",x["cim:EnergySource"]),e.elements(D,"EquivalentInjection","Equivalent Injections",x["cim:EquivalentInjection"]);let M=e.createTopContainer(n,"RotatingMachine","Rotating Machines",C);e.elements(M,"SynchronousMachine","Synchronous Machines",x["cim:SynchronousMachine"]),e.elements(M,"AsynchronousMachine","Asynchronous Machines",x["cim:AsynchronousMachine"]);let I=e.createTopContainer(n,"Load","Loads",N);e.elements(I,"EnergyConsumer","Energy Consumers",x["cim:EnergyConsumer"]),e.elements(I,"ConformLoad","Conform Loads",x["cim:ConformLoad"]),e.elements(I,"NonConformLoad","Non Conform Loads",x["cim:NonConformLoad"]);let B=e.createTopContainer(n,"Compensator","Compensators",S);e.elements(B,"LinearShuntCompensator","Linear",x["cim:LinearShuntCompensator"]),e.nlCompensators(B,x["cim:NonlinearShuntCompensator"]),e.elements(n,"BusbarSection","Nodes",A),e.powerTransformers(n,x["cim:PowerTransformer"]),e.geoRegions(a,f),e.substations(a,m["cim:Substation"]);let O=e.elements(a,"Line","Lines",m["cim:Line"]);e.createDeleteMenu(O);let j=e.createTopContainer(a,"GeneralGeneratingUnit","Generating Units",p["cim:GeneratingUnit"].concat(p["cim:ThermalGeneratingUnit"]));e.elements(j,"GeneratingUnit","General Units",p["cim:GeneratingUnit"]),e.elements(j,"ThermalGeneratingUnit","Thermal Units",p["cim:ThermalGeneratingUnit"]),e.elements(i,"LoadResponseCharacteristic","Load Response Characteristics",h["cim:LoadResponseCharacteristic"]);let R=e.elements(i,"TapChangerControl","Tap Changer Controls",T["cim:TapChangerControl"]);e.createDeleteMenu(R);let P=e.elements(i,"RegulatingControl","Regulating Controls",T["cim:RegulatingControl"]);e.createDeleteMenu(P);let q=e.elements(l,"OperationalLimitType","Operational Limit Types",T["cim:OperationalLimitType"]);e.createDeleteMenu(q),e.limitSets(l,b["cim:OperationalLimitSet"]),e.createAddButton(r,"BaseVoltage"),e.createAddButton(a,"Substation"),e.createAddButton(a,"GeographicalRegion"),e.createAddButton(a,"Line"),e.createAddButton(a,"GeneratingUnit"),e.createAddButton(a,"ThermalGeneratingUnit"),e.createAddButton(i,"LoadResponseCharacteristic"),e.createAddButton(l,"OperationalLimitType")}(t);!function t(){let a=n.next().value;void 0!==a?(document.getElementById("loadingDiagramMsg").innerHTML="<br>"+a,setTimeout(t,1)):e.props.dispatcher.trigger("loaded")}()},render(t){e.props.model.selectDiagram(decodeURI(t)),e.state.diagramName=decodeURI(t),document.getElementById("showAllObjects").checked=!0,document.getElementById("showAllObjects").dispatchEvent(new MouseEvent("click"))},geoRegions(t,n){let a=e.elements(t,"GeographicalRegion","Geographical Regions",n);a.each((function(t,n){let a=e.props.model.getTargets([t],"GeographicalRegion.Regions");e.subGeoRegions(d3.select(this),a),e.subAddButton(d3.select(this),"SubGeographicalRegion","cim:SubGeographicalRegion.Region")})),e.createDeleteMenu(a)},subGeoRegions(t,n){let a=t.data()[0],o=e.elements(t,e.props.model.ID(a)+"SubGeographicalRegion","Sub-Geographical Regions",n);e.createDeleteMenu(o)},substations(t,n){let a=e.elements(t,"Substation","Substations",n);a.each((function(t,n){let a=e.props.model.getTargets([t],"Substation.VoltageLevels");e.voltageLevels(d3.select(this),a),e.subAddButton(d3.select(this),"VoltageLevel","cim:VoltageLevel.Substation")})),e.createDeleteMenu(a)},voltageLevels(t,n){let a=t.data()[0],o=e.elements(t,e.props.model.ID(a)+"VoltageLevel","Voltage Levels",n);o.each((function(t,n){let a=e.props.model.getTargets([t],"VoltageLevel.Bays");e.bays(d3.select(this),a),e.subAddButton(d3.select(this),"Bay","cim:Bay.VoltageLevel")})),e.createDeleteMenu(o)},bays(t,n){let a=t.data()[0],o=e.elements(t,e.props.model.ID(a)+"Bay","Bays",n);e.createDeleteMenu(o)},powerTransformers(t,n){e.elements(t,"PowerTransformer","Transformers",n).each((function(t,n){let a=e.props.model.getTargets([t],"PowerTransformer.PowerTransformerEnd"),o=e.elements(d3.select(this),e.props.model.ID(t)+"PowerTransformerEnd","Transformer Windings",a);for(const e of o.nodes())e.parentNode.classList.add("CIM-subobject");o.each((function(t,n){let a=e.props.model.getTargets([t],"TransformerEnd.RatioTapChanger");e.tapChangers(d3.select(this),a)}))}))},nlCompensators(t,n){e.elements(t,"NonlinearShuntCompensator","Nonlinear",n).each((function(t,n){let a=e.props.model.getTargets([t],"NonlinearShuntCompensator.NonlinearShuntCompensatorPoints");e.nlCompensatorPoints(d3.select(this),a),e.subAddButton(d3.select(this),"NonlinearShuntCompensatorPoint","cim:NonlinearShuntCompensatorPoint.NonlinearShuntCompensator")}))},nlCompensatorPoints(t,n){let a=t.data()[0],o=e.elements(t,e.props.model.ID(a)+"NonlinearShuntCompensatorPoint","Points",n,!0);for(const e of o.nodes())e.parentNode.classList.add("CIM-subobject");e.createDeleteMenu(o)},tapChangers(t,n){let a=t.data()[0],o=e.elements(t,e.props.model.ID(a)+"RatioTapChanger","Ratio Tap Changer",n);for(const e of o.nodes())e.parentNode.classList.add("CIM-subobject");e.createDeleteMenu(o)},limitSets(t,n){let a=e.elements(t,"OperationalLimitSet","Operational Limit Sets",n);a.each((function(t,n){let a=e.props.model.getTargets([t],"OperationalLimitSet.OperationalLimitValue");e.limits(d3.select(this),a),e.subAddButton(d3.select(this),"VoltageLimit","cim:OperationalLimit.OperationalLimitSet"),e.subAddButton(d3.select(this),"CurrentLimit","cim:OperationalLimit.OperationalLimitSet"),e.subAddButton(d3.select(this),"ActivePowerLimit","cim:OperationalLimit.OperationalLimitSet"),e.subAddButton(d3.select(this),"ApparentPowerLimit","cim:OperationalLimit.OperationalLimitSet")})),e.createDeleteMenu(a)},limits(t,n){let a=t.data()[0],o=n.filter((t=>e.props.model.schema.isA("VoltageLimit",t))),r=n.filter((t=>e.props.model.schema.isA("CurrentLimit",t))),i=n.filter((t=>e.props.model.schema.isA("ActivePowerLimit",t))),l=n.filter((t=>e.props.model.schema.isA("ApparentPowerLimit",t))),s=e.elements(t,e.props.model.ID(a)+"VoltageLimit","Voltage limits",o),c=e.elements(t,e.props.model.ID(a)+"CurrentLimit","Current limits",r),d=e.elements(t,e.props.model.ID(a)+"ActivePowerLimit","Active power limits",i),m=e.elements(t,e.props.model.ID(a)+"ApparentPowerLimit","Apparent power limits",l);e.createDeleteMenu(s),e.createDeleteMenu(c),e.createDeleteMenu(d),e.createDeleteMenu(m)},createTopContainer(t,n,a,o){let r=t.select("li."+n+"s"),i=r.select("ul#"+n+"sList");if(r.empty()){r=t.append("li").attr("class",n+"s list-group-item d-flex justify-content-between cim-parent-container");let o=r.append("div");o.append("a").attr("class","btn btn-primary btn-sm").attr("role","button").attr("data-toggle","collapse").attr("href","#"+n+"sList").html(a),r.append("h4").append("span").attr("class","badge badge-primary badge-pill").html(0),i=o.append("ul").attr("id",n+"sList").attr("class","collapse"),r.on("click",(function(t){t.target===this&&e.goToBasePath()}))}return i},createAddButton(t,n){let a=t.select("li."+n+"s"),o=a.select("ul#"+n+"sList"),r=a.select("ul#"+n+"sList > button.cim-add-btn");!0===r.empty()&&(r=o.insert("li",":first-child").append("button").attr("class","btn btn-default btn-sm cim-add-btn").attr("type","submit"),r.html('<span class="fas fa-plus" aria-hidden="true"></span> Add'),r.on("click.add",(function(){let t=e.props.model.createObject("cim:"+n);e.props.model.addToActiveDiagram(t,[])})))},subAddButton(t,n,a){let o=t.data()[0],r=e.props.model.ID(o)+n,i=t.select("li."+r+"s"),l=i.select("ul#"+r+"sList"),s=i.select("ul#"+r+"sList > button.cim-add-btn");!0===s.empty()&&(s=l.insert("li",":first-child").append("button").attr("class","btn btn-default btn-sm cim-add-btn").attr("type","submit"),s.html('<span class="fas fa-plus" aria-hidden="true"></span> Add'),s.on("click.add",(function(){let t=e.props.model.createObject("cim:"+n);e.props.model.setLink(t,a,o),e.props.model.addToActiveDiagram(t,[])})))},createDeleteMenu(e){e.selectAll((function(){return this.parentNode.childNodes})).filter("button.cim-object-btn").on("contextmenu",t)},elements(t,n,a,o,r){let i=t.select("li."+n+"s"),l=i.select("ul#"+n+"sList");if(!0===i.empty()){i=t.append("li").attr("class",n+"s list-group-item d-flex justify-content-between"),i.append("div").append("a").attr("class","btn btn-primary btn-sm").attr("role","button").attr("data-toggle","collapse").attr("href","#"+n+"sList").html(a),i.append("h4").append("span").attr("class","badge badge-primary badge-pill").html(0),i.on("click",(function(t){t.target===this&&e.goToBasePath()})),l=i.select("div").append("ul").attr("id",n+"sList").attr("class","collapse")}let s=l.selectAll("li."+n).data(o,(function(t){return e.props.model.ID(t)})).enter().append("li").attr("class",n+" CIM-object").on("click",(function(t){t.target===this&&e.goToBasePath()}));s.append("a").attr("class","btn btn-outline-secondary btn-sm cim-expand-object").attr("role","button").attr("data-toggle","collapse").attr("href",(function(t){return"#"+e.props.model.ID(t)})).on("click",(function(t,n){let a=d3.select(this.parentNode).select("ul");0===a.selectAll("li.attribute").size()&&e.generateAttrsAndLinks(a)})).html('<span class="fas fa-plus" aria-hidden="true"></span>'),s.append("button").attr("class","btn btn-primary btn-sm cim-object-btn").on("click",(function(t,n){let a=window.location.hash.substring(1).split("/"),o=a[0]+"/"+a[1]+"/"+a[2];window.location.hash.substring(1)!==o+"/"+e.props.model.ID(n)&&route.router.push(o+"/"+e.props.model.ID(n))})).html((function(t){let n=e.props.model.getAttribute(t,"cim:IdentifiedObject.name");return void 0!==n?n.innerHTML:"unnamed"})).attr("draggable","true").on("dragstart",(function(t,n){t.dataTransfer.setData("text/plain",e.props.model.ID(n))}));let c=s.append("ul").attr("id",(function(t){return e.props.model.ID(t)})).attr("class","collapse CIM-object-list"),d=parseInt(i.select(":scope > h4 > span").html());if(d+=c.size(),i.select(":scope > h4 > span").html(d),void 0===r||!1===r){let e=i.node().closest("li.cim-parent-container");for(;null!==e;){let t=e.querySelector(":scope>h4>span"),n=parseInt(t.innerHTML);n+=c.size(),t.innerHTML=n,e=e.parentNode.closest("li.cim-parent-container")}}return c},generateAttrsAndLinks(t){let n=i(!1===document.getElementById("sshInput").checked,"EQ");e.generateAttributes(n);let a=i(!0===document.getElementById("sshInput").checked,"SSH");e.generateAttributes(a);let o=l(!1===document.getElementById("sshInput").checked,"EQ");e.generateLinks(o);let r=l(!0===document.getElementById("sshInput").checked,"SSH");function i(n,a){return t.selectAll("li.attribute."+a).data((function(n){let o=e.props.model.schema.getSchemaAttributes(n.localName,a),r=t.selectAll("li.attribute > div > span.cim-tree-attribute-name").nodes().map((e=>e.textContent));return o=o.filter((function(e){let t=e.attributes[0].value.substring(1).split(".")[1];return r.indexOf(t)<0})),o.filter((e=>"#IdentifiedObject.mRID"!==e.attributes[0].value))})).enter().append("li").attr("class",s(n,a)).attr("title",(function(e){let t=e.attributes.getNamedItem("rdf:about").value.split(".")[1],n=[].filter.call(e.children,(function(e){return"rdfs:comment"===e.nodeName}));return n.length>0?t+" - "+n[0].textContent:t})).append("div").attr("class","input-group")}function l(n,a){return t.selectAll("li.link."+a).data((function(t){let n=["#NonlinearShuntCompensatorPoint.NonlinearShuntCompensator","#TransformerEnd.Terminal","#PowerTransformerEnd.PowerTransformer","#RatioTapChanger.TransformerEnd","#RegulatingControl.Terminal","#Measurement.Terminal","#Measurement.PowerSystemResource","#Discrete.ValueAliasSet","#OperationalLimitSet.Terminal","#OperationalLimitSet.Equipment","#OperationalLimit.OperationalLimitSet","#SubGeographicalRegion.Region","#VoltageLevel.Substation","#Bay.VoltageLevel"];return e.props.model.schema.getSchemaLinks(t.localName,a).filter((t=>"Yes"===e.props.model.getAttribute(t,"cims:AssociationUsed").textContent)).filter((e=>n.indexOf(e.attributes[0].value)<0))})).enter().append("li").attr("class",s(n,a)).attr("title",(function(e){let t=e.attributes.getNamedItem("rdf:about").value.split(".")[1],n=[].filter.call(e.children,(function(e){return"rdfs:comment"===e.nodeName}));return n.length>0?t+" - "+n[0].textContent:t})).append("div").attr("class","input-group")}function s(t,n){return function(a){let o="attribute "+n;!1===a.attributes.getNamedItem("rdf:about").value.startsWith("#")&&(o+=" entsoe");let r=null;return"EQ"===n&&(r=e.props.model.schema.getSchemaStereotype(a),null!==r&&(o=o+" "+r)),("Operation"===r&&"BUS_BRANCH"===e.props.model.getMode()||!1===t)&&(o+=" d-none"),o}}e.generateLinks(r)},generateAttributes(t){t.append("div").attr("class","input-group-prepend").append("span").attr("class","input-group-text cim-tree-attribute-name").html((function(e){let t=e.attributes.getNamedItem("rdf:about").value.split(".")[1];return t.length>20&&(t=t.substring(0,20)+"..."),t})),t.filter((function(t){return"#String"===e.props.model.schema.getSchemaAttributeType(t)[0]})).append("input").attr("class","form-control").each(s).attr("type","text").on("input",d),t.filter((function(t){return"#Integer"===e.props.model.schema.getSchemaAttributeType(t)[0]})).append("input").attr("class","form-control").each((function(t){let n=d3.select(this.closest("ul")).data()[0],a=e.props.model.getAttribute(n,"cim:"+t.attributes[0].value.substring(1));void 0!==a?this.value=parseInt(a.innerHTML):d3.select(this).attr("placeholder","none")})).attr("type","number").on("input",d);let n=t.filter((function(t){let n=e.props.model.schema.getSchemaAttributeType(t);return"#Float"===n[0]||"#Decimal"===n[0]}));n.append("input").attr("class","form-control").each((function(t){let n=d3.select(this.closest("ul")).data()[0],a=e.props.model.getAttribute(n,"cim:"+t.attributes[0].value.substring(1));void 0!==a?this.value=parseFloat(a.innerHTML).toFixed(5):d3.select(this).attr("placeholder","none")})).attr("type","number").attr("step","0.00001").on("input",d),n.append("div").attr("class","input-group-append").append("span").attr("class","input-group-text cim-tree-attribute-uom").html((function(t){let n=e.props.model.schema.getSchemaAttributeType(t);return"none"===n[2]?n[1]:n[2]+n[1]}));let a=t.filter((function(t){return"#Boolean"===e.props.model.schema.getSchemaAttributeType(t)[0]})).append("div").attr("class","input-group-append cim-tree-btn-group"),o=a.append("button").attr("type","button").attr("class","btn btn-outline-secondary dropdown-toggle cim-tree-dropdown-toggle").attr("data-toggle","dropdown").attr("aria-haspopup","true").attr("aria-expanded","false");o.append("span").attr("class","boolVal").each((function(t){let n=d3.select(this.closest("li.attribute").parentNode).data()[0],a=e.props.model.getAttribute(n,"cim:"+t.attributes[0].value.substring(1));void 0!==a?d3.select(this).text(a.innerHTML):d3.select(this).text("none")})),o.append("span").attr("class","caret");let r=a.append("div").attr("class","dropdown-menu");r.append("a").attr("class","dropdown-item").text("true").on("click",c),r.append("a").attr("class","dropdown-item").text("false").on("click",c),t.filter((function(t){return"#DateTime"===e.props.model.schema.getSchemaAttributeType(t)[0]})).append("input").attr("class","form-control").each(s).attr("type","datetime-local").on("input",d);let i=t.filter((function(t){return e.props.model.schema.isEnum(t)})).append("div").attr("class","input-group-append cim-tree-btn-group"),l=i.append("button").attr("type","button").attr("class","btn btn-outline-secondary dropdown-toggle cim-tree-dropdown-toggle").attr("data-toggle","dropdown").attr("aria-haspopup","true").attr("aria-expanded","false");function s(t){let n=d3.select(this.closest("li.attribute").parentNode).data()[0],a=e.props.model.getAttribute(n,"cim:"+t.attributes[0].value.substring(1));void 0!==a?this.value=a.innerHTML:d3.select(this).attr("placeholder","none")}function c(t,n){let a=d3.select(this).node().textContent;this.parentNode.parentNode.querySelector(":scope>button>span.boolVal").textContent=a;let o=d3.select(this.closest("li.attribute").parentNode).data()[0],r="cim:"+n.attributes[0].value.substring(1);e.props.model.setAttribute(o,r,a)}function d(t,n){let a=d3.select(this.closest("ul")).data()[0],o=n.attributes.getNamedItem("rdf:about").value,r="cim:";!1===o.startsWith("#")&&(r="entsoe:"),o=o.substring(o.indexOf("#")+1);let i=r+o;e.props.model.setAttribute(a,i,this.value)}l.append("span").attr("class","enumVal").each((function(t){let n=d3.select(this.closest("li.attribute").parentNode).data()[0],a=e.props.model.getEnum(n,"cim:"+t.attributes[0].value.substring(1));void 0!==a?d3.select(this).text(a):d3.select(this).text("none")})),l.append("span").attr("class","caret"),i.append("div").attr("class","dropdown-menu").selectAll("a").data((function(t){return e.props.model.schema.getSchemaEnumValues(t)})).enter().append("a").on("click",(function(t,n){this.parentNode.parentNode.querySelector(":scope>button>span.enumVal").textContent=n;let a=d3.select(this.closest("li.attribute").parentNode).data()[0],o=d3.select(this.closest("li.attribute")).data()[0],r="cim:"+o.attributes[0].value.substring(1),i=e.props.model.schema.getSchemaEnumName(o)+"."+n;e.props.model.setEnum(a,r,i)})).attr("class","dropdown-item").text((function(e){return e}))},generateLinks(t){t.attr("class","input-group-prepend").append("span").attr("class","input-group-text cim-tree-attribute-name").html((function(e){let t=e.attributes.getNamedItem("rdf:about").value.split(".")[1];return t.length>20&&(t=t.substring(0,20)+"..."),t}));let n=t.append("div").attr("class","btn-group cim-tree-btn-group");n.append("button").attr("class","btn btn-outline-secondary cimLinkBtn").attr("type","submit").on("click",(function(e,t){let n="#"+d3.select(this).attr("cim-target"),a=window.location.hash.substring(1).split("/"),o=a[0]+"/"+a[1]+"/"+a[2];route.router.push(o+"/"+n.substring(1))})).attr("cim-target",(function(t){let n=d3.select(this.closest("ul")).data()[0],a=e.props.model.getTargets([n],t.attributes[0].value.substring(1))[0];return void 0===a?"none":e.props.model.ID(a)})).html((function(t){let n=e.props.model.getObject(d3.select(this).attr("cim-target"));if(void 0===n)return d3.select(this).attr("disabled","disabled"),"none";let a=e.props.model.getAttribute(n,"cim:IdentifiedObject.name");return void 0!==a?a.innerHTML:"unnamed"})),n.append("button").attr("class","btn btn-outline-secondary").attr("type","submit").on("click",(function(t,n){let a=d3.select(this.parentNode),o=e.props.model.schema.getLinkRange(n),r=d3.select(".tree").selectAll(".tab-pane > .list-group > .list-group-item > div > ul"),i=r.filter((function(t){let n=!1,a=d3.select(this).select(".CIM-object");return a.size()>0&&(n=!0===e.props.model.schema.isA(o,a.datum())),n})),l=r.filter((function(t){let n=!0,a=d3.select(this).select(".CIM-object");return a.size()>0&&(n=!1===e.props.model.schema.isA(o,a.datum())),n}));e.enterSetLinkMode(a,i,l)})).html("change"),n.append("button").attr("class","btn btn-outline-secondary").attr("type","submit").attr("id","cimRemoveBtn").on("click",(function(t,n){let a=d3.select(this.closest("ul")).data()[0],o="cim:"+n.attributes[0].value.substring(1),r=e.props.model.getObject(this.parentNode.querySelector("[cim-target]").getAttribute("cim-target"));e.props.model.removeLink(a,o,r)})).html((function(){return void 0===e.props.model.getObject(this.parentNode.querySelector("[cim-target]").getAttribute("cim-target"))&&d3.select(this).attr("disabled","disabled"),"remove"}))},setLink(t,n){let a=d3.select(t.node().closest("ul")).data()[0],o=e.props.model.ID(a);if(null!==n){let o="cim:"+t.data()[0].attributes[0].value.substring(1);e.props.model.setLink(a,o,n)}let r=window.location.hash.substring(1).split("/"),i=r[0]+"/"+r[1]+"/"+r[2];route.router.push(i+"/"+o)},enterSetLinkMode(t,n,a){e.state.mode="setLinks",document.getElementById("tree-link-dialog").classList.remove("d-none"),document.getElementById("tree-controls").classList.add("d-none"),n.each((function(n){let a=d3.select(this).selectAll(".CIM-object");a.select("button.cim-object-btn").classed("btn-primary",!1).classed("btn-outline-dark",!0),a.insert("button",":first-child").attr("class","btn btn-outline-dark btn-sm cim-check-btn").attr("type","submit").on("click",(function(){d3.select(this.firstChild).attr("class","far fa-check-square");let n=d3.select(this).datum();e.setLink(t,n),e.exitSetLinkMode()})).append("span").attr("class","far fa-square"),a.selectAll("a.cim-expand-object").classed("d-none",!0)})),a.each((function(e){this.parentNode.parentNode.classList.add("d-none"),this.parentNode.parentNode.classList.remove("d-flex")})),document.querySelectorAll(".tab-content > .tab-pane > ul").forEach((function(e){const t=e.parentNode.getAttribute("id")+"Tab";0===e.querySelectorAll(":scope > li.d-flex").length?document.getElementById(t).classList.add("d-none"):$("#"+t).tab("show")})),d3.select("body").on("keyup.tree",(function(n){27===n.keyCode&&(e.exitSetLinkMode(),e.setLink(t,null))})),d3.select("#tree-link-dialog-cancel").on("click",(function(){e.exitSetLinkMode(),e.setLink(t,null)}))},exitSetLinkMode(){e.state.mode="default",document.getElementById("tree-link-dialog").classList.add("d-none"),document.getElementById("tree-controls").classList.remove("d-none"),d3.select(".tree").selectAll(".tab-pane > .list-group > .list-group-item > div > ul").each((function(e){let t=d3.select(this).selectAll(".CIM-object");t.selectAll("button.cim-check-btn").remove(),t.select("button.cim-object-btn").classed("btn-primary",!0).classed("btn-outline-dark",!1),t.selectAll("a.cim-expand-object").classed("d-none",!1),this.parentNode.parentNode.classList.add("d-flex"),this.parentNode.parentNode.classList.remove("d-none")})),document.querySelectorAll(".tab-content > .tab-pane > ul").forEach((function(e){const t=e.parentNode.getAttribute("id")+"Tab";document.getElementById(t).classList.remove("d-none")})),d3.select("body").on("keyup.tree",null),d3.select("#tree-link-dialog-cancel").on("click",null)},moveTo(t){if(void 0===t)return;let n=null,a=null,o=e.props.model.getObject(t);if(void 0===o)return;if("cim:ConnectivityNode"===o.nodeName||"cim:TopologicalNode"===o.nodeName){let n=e.props.model.getBusbar(o);if(null===n)return;t=e.props.model.ID(n)}if(a=d3.select(".tree").select("#"+t).node(),null===a)return;n=a.parentNode,d3.select(".tree").selectAll(".btn-danger").classed("btn-danger",!1).classed("btn-primary",!0);const r=n.closest("div.tab-pane").getAttribute("id")+"Tab";document.getElementById(r).classList.contains("active")?e.scrollTo("#"+t):$("#"+r).on("shown.bs.tab",(function(n){e.scrollTo("#"+t),$(this).off("shown.bs.tab")})),$("#"+r).tab("show"),d3.select(n).select("button.cim-object-btn").classed("btn-danger",!0).classed("btn-primary",!1)},deleteObject(e){let t=d3.select("div.tree").select("ul#"+e).node();if(null!==t){let e=t.parentNode;e.closest("li.list-group-item").querySelectorAll(":scope>h4>span").forEach((function(e){let t=parseInt(e.innerHTML);t-=1,e.innerHTML=t}));let n=e.closest("li.cim-parent-container");for(;null!==n;){let e=n.querySelector(":scope>h4>span"),t=parseInt(e.innerHTML);t-=1,e.innerHTML=t,n=n.parentNode.closest("li.cim-parent-container")}e.remove()}},scrollTo(t){function n(e){const t=document.getElementById("tab-content"),n=t.querySelector(e),a=t.getBoundingClientRect().top+document.body.scrollTop,o=n.parentNode.getBoundingClientRect().top+document.body.scrollTop;t.scrollTop=t.scrollTop+o-a}null!==document.querySelector(t).parentNode.closest(".collapse:not(.show)")?$(t).parents(".collapse:not(.show)").on("shown.bs.collapse",(function(a){a.stopPropagation();let o=d3.select(this.parentNode).filter(".CIM-object").select("ul");0===o.selectAll("li.attribute").size()&&e.generateAttrsAndLinks(o),n(t),$(this).off("shown.bs.collapse")})):n(t),$(t).parents(".collapse:not(.show)").collapse("show")},resetAttrs(){!0===document.getElementById("sshInput").checked?(d3.select("#app-tree").selectAll("li.attribute:not(.SSH)").classed("d-none",!0),d3.select("#app-tree").selectAll("li.link:not(.SSH)").classed("d-none",!0),d3.select("#app-tree").selectAll("li.attribute.SSH").classed("d-none",!1),d3.select("#app-tree").selectAll("li.link.SSH").classed("d-none",!1)):(d3.select("#app-tree").selectAll("li.attribute:not(.SSH)").classed("d-none",!1),d3.select("#app-tree").selectAll("li.link:not(.SSH)").classed("d-none",!1),d3.select("#app-tree").selectAll("li.attribute.SSH").classed("d-none",!0),d3.select("#app-tree").selectAll("li.link.SSH").classed("d-none",!0))}},template:function(e,t,n,a){return e('<div class="app-tree" id="app-tree"><div class="tree"><div class="card bg-light mb-3 d-none" id="tree-link-dialog"><div class="card-body"><h5 class="card-title">Choose the target element</h5><p class="card-text">Click on the selection box to select it.</p><button type="button" class="btn btn-outline-danger" id="tree-link-dialog-cancel">Cancel</button></div></div><div class="row" id="tree-controls"><div class="col"><div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="showAllObjects"/><label class="custom-control-label" for="showAllObjects">Show all objects</label></div></div><div class="col"><div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="sshInput"/><label class="custom-control-label" for="sshInput">Power flow input</label></div></div></div><div class="input-group" id="cim-search-form"><input type="text" class="form-control" placeholder="Search..." aria-label="Search" aria-describedby="button-addon4" id="cim-search-key"/><div class="input-group-append" id="button-addon4"><button class="btn btn-outline-secondary" id="cim-search-prev" type="button" title="Find previous"><span class="fas fa-angle-up"></span></button><button class="btn btn-outline-secondary" id="cim-search-next" type="button" title="Find next"><span class="fas fa-angle-down"></span></button></div><div class="input-group-append"><button class="btn btn-outline-secondary" type="button" id="cim-search-case" data-toggle="button" aria-pressed="false" autocomplete="off">Match case</button></div><div class="input-group-append d-none" id="cim-search-results"><span class="input-group-text" id="basic-addon2"></span></div></div><ul class="nav nav-tabs" role="tablist"><li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#components" id="componentsTab">Components</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#containers" id="containersTab">Containers</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#measurements" id="measurementsTab">Measurements</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#bases" id="basesTab">Bases</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#curvesAndRegs" id="curvesAndRegsTab">Curves and Regulations</a></li><li class="nav-item"><a class="nav-link" data-toggle="tab" href="#limits" id="limitsTab">Operational Limits</a></li></ul><div class="tab-content" id="tab-content"><div role="tabpanel" class="tab-pane fade show active" id="components"><ul class="list-group" id="CIMComponents"></ul></div><div role="tabpanel" class="tab-pane fade" id="containers"><ul class="list-group" id="CIMContainers"></ul></div><div role="tabpanel" class="tab-pane fade" id="measurements"><ul class="list-group" id="CIMMeasurements"></ul></div><div role="tabpanel" class="tab-pane fade" id="bases"><ul class="list-group" id="CIMBases"></ul></div><div role="tabpanel" class="tab-pane fade" id="curvesAndRegs"><ul class="list-group" id="CIMCurvesAndRegs"></ul></div><div role="tabpanel" class="tab-pane fade" id="limits"><ul class="list-group" id="CIMLimits"></ul></div></div></div></div>',[])},name:"cimtree"}})),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).cimDraw=t()}(this,(function(){"use strict";let e=null;return{css:'cimdraw .center-block,[is="cimdraw"] .center-block{ text-align: center; } cimdraw .diagramTools,[is="cimdraw"] .diagramTools{ margin-bottom: 20px; } cimdraw .app-container,[is="cimdraw"] .app-container{ display: flex; flex-flow: row nowrap; } cimdraw .navbar-light .navbar-text,[is="cimdraw"] .navbar-light .navbar-text{ color: rgba(0,0,0,1); } cimdraw .navbar-light .navbar-nav .nav-link,[is="cimdraw"] .navbar-light .navbar-nav .nav-link{ color: rgba(0,0,0,1); } cimdraw .cim-content-center,[is="cimdraw"] .cim-content-center{ text-align: center; max-width: 700px; } cimdraw #upload-boundary,[is="cimdraw"] #upload-boundary{ display: none; }',exports:{onBeforeMount(t,n){e=this,e.state.cimModel=cimModel(),e.state.diagramsToLoad=2,e.state.dispatcher={},observable(e.state.dispatcher),e.state.cimModel.on("setMode",(function(e){document.getElementById("cim-mode").textContent="NODE_BREAKER"===e?"Mode: Operational":"Mode: Planning"})),e.state.dispatcher.on("loaded",(function(){e.state.diagramsToLoad=e.state.diagramsToLoad-1,0===e.state.diagramsToLoad&&($("#loadingModal").modal("hide"),document.getElementById("loadingDiagramMsg").textContent="loading diagram...",e.state.diagramsToLoad=2)}))},onMounted(){let t={},n=!1,a=window.location.pathname.substring(1);function o(t){r();const n=document.getElementById("cim-diagrams"),a=document.createElement("option");a.setAttribute("value","#"+t+"/createNew"),a.textContent="Generate a new diagram",n.appendChild(a);const o=e.state.cimModel.getDiagramList();for(let e in o){const a=document.createElement("option");a.setAttribute("value","#"+t+"/diagrams/"+o[e]),a.setAttribute("id",o[e]),a.textContent=o[e],n.appendChild(a)}0===o.length&&route.router.push(t+"/createNew")}function r(){const e=document.getElementById("cim-diagrams");for(;null!==e.firstChild;)e.removeChild(e.lastChild);const t=document.createElement("option");t.setAttribute("disabled","disabled"),t.setAttribute("selected","selected"),t.textContent="Select a diagram",e.appendChild(t)}-1===a.indexOf("index.html")&&(a+="index.html"),route.setBase(a+"#"),route.router.push(window.location.hash.replace("#","")),route.initDomListeners(),document.getElementById("operational").addEventListener("change",(function(){e.state.cimModel.setMode("NODE_BREAKER")})),document.getElementById("planning").addEventListener("change",(function(){e.state.cimModel.setMode("BUS_BRANCH")})),document.getElementById("cim-create-new-container").addEventListener("click",(function(){t={name:"new1"},n=!0,$("#cimModeModal").modal("show")})),document.getElementById("cim-loading-modal-error").addEventListener("click",(function(){$("#loadingModal").modal("hide"),route.router.push("")})),document.getElementById("cim-boundary-modal-error").addEventListener("click",(function(){$("#boundaryModal").modal("hide"),document.getElementById("boundaryMsg").textContent="loading boundary file..."})),document.getElementById("cim-create-new-modal").addEventListener("click",(function(){route.router.push(t.name+"/diagrams")})),document.getElementById("load-boundary").addEventListener("click",(function(){return document.getElementById("upload-boundary").click(),!1})),document.getElementById("upload-boundary").addEventListener("change",(function(){const t=this.files[0];$("#boundaryModal").off("shown.bs.modal"),$("#boundaryModal").on("shown.bs.modal",(function(){e.state.cimModel.loadBoundary(t).then((function(e){const t=document.createElement("br");document.getElementById("boundaryMsg").append(t,"OK. "+e),document.getElementById("cim-boundary-modal-error-container").style.display=null})).catch((function(e){const t=document.createElement("br");document.getElementById("boundaryMsg").append(t,e),document.getElementById("cim-boundary-modal-error-container").style.display=null}))})),$("#boundaryModal").modal("show")})),document.getElementById("cim-save").addEventListener("click",(function(t){const n=e.state.cimModel.save(),a=new Blob([n],{type:"text/xml"}),o=URL.createObjectURL(a);t.currentTarget.setAttribute("href",o)})),document.getElementById("cgmes-save").addEventListener("click",(function(t){e.state.cimModel.saveAsCGMES().then((function(e){const t=URL.createObjectURL(e);document.getElementById("cgmes-download").setAttribute("href",t),document.getElementById("cgmes-download").click()})).catch((function(e){console.log(e)}))})),document.getElementById("cim-export").addEventListener("click",(function(t){const n=e.state.cimModel.export(),a=new Blob([n],{type:"text/xml"}),o=URL.createObjectURL(a);t.currentTarget.setAttribute("href",o)})),document.getElementById("matpower-export").addEventListener("click",(function(t){const n=exportToMatpower(e.state.cimModel),a=new Blob([n],{type:"text/plain"}),o=URL.createObjectURL(a);t.currentTarget.setAttribute("href",o)})),document.getElementById("newDiagramBtn").addEventListener("click",(function(e){const t=document.getElementById("newDiagramName").value,n=window.location.hash.substring(1).split("/")[0]+"/diagrams/"+t;$("#newDiagramModal").modal("hide"),route.router.push(n)})),route.route("").on.value((function(e){document.getElementById("cim-local-file-component").style.display=null,document.getElementById("app-container").style.display="none",document.getElementById("cim-load-container").style.display="none",document.getElementById("cim-home-container").style.display="none",document.getElementById("cim-diagrams").style.display="none",document.getElementById("cim-mode").style.display="none",document.getElementById("cim-loading-modal-error-container").style.display="none",document.getElementById("cim-boundary-modal-error-container").style.display="none",r(),document.getElementById("cim-filename").textContent="";document.getElementById("cim-file-input").addEventListener("change",(function(){t=this.files[0],n=!1;const e="#"+encodeURI(t.name)+"/diagrams";document.getElementById("cim-load").setAttribute("href",e),document.getElementById("cim-load-container").style.display=null}))})),route.route(":file/diagrams").on.value((function(a){document.getElementById("cim-home-container").style.display=null,document.getElementById("cim-diagrams").style.display=null,document.getElementById("cim-mode").style.display=null,document.getElementById("cim-local-file-component").style.display="none",document.getElementById("app-container").style.display="none",document.getElementById("cim-export").parentNode.classList.add("disabled"),$("#cimModeModal").modal("hide");const r=document.getElementById("cim-filename").textContent;t.name!==r?(document.getElementById("loadingDiagramMsg").textContent="loading CIM network...",$("#loadingModal").off("shown.bs.modal"),$("#loadingModal").on("shown.bs.modal",(function(a){if(void 0===t.name)return $("#loadingModal").modal("hide"),void route.router.push("");{document.getElementById("cim-filename").innerHTML="["+t.name+"]&nbsp&nbsp";let a=null;a=!1===n?e.state.cimModel.load(t):e.state.cimModel.newFile(t.name),a.then((function(){o(t.name),$("#loadingModal").modal("hide"),"new1"!==t.name&&function(){const t=e.state.cimModel.getObjects(["cim:ConnectivityNode","cim:TopologicalNode"]);let n=t["cim:ConnectivityNode"];const a=t["cim:TopologicalNode"];n=n.filter((function(t){return!1===e.state.cimModel.isBoundary(t)})),n.length>0||0===a.length?e.state.cimModel.setMode("NODE_BREAKER"):e.state.cimModel.setMode("BUS_BRANCH")}()})).catch((function(e){const t=document.createElement("br");document.getElementById("loadingDiagramMsg").append(t,e),document.getElementById("cim-loading-modal-error-container").style.display=null}))}})),$("#loadingModal").modal("show"),e.state.dispatcher.trigger("diagrams")):o(t.name)})),route.route(":file/diagrams/:name").on.value((function(n){const a=n.params.file,r=n.params.name;if(void 0!==t.name){if(e.state.cimModel.activeDiagramName===decodeURI(r))return e.state.dispatcher.trigger("showDiagram",a,r),void(document.getElementById("app-container").style.display=null);document.getElementById("cim-local-file-component").style.display="none",document.getElementById("loadingDiagramMsg").textContent="loading diagram...",$("#loadingModal").off("shown.bs.modal"),$("#loadingModal").modal("show"),$("#loadingModal").on("shown.bs.modal",(function(t){!function(t,n,a){e.state.cimModel.selectDiagram(decodeURI(n)),o(decodeURI(t)),document.getElementById(decodeURI(n)).setAttribute("selected",!0),document.getElementById("app-container").style.display=null,document.getElementById("cim-export").parentNode.classList.remove("disabled"),e.state.dispatcher.trigger("showDiagram",t,n,a)}(a,r)}))}else route.router.push("")})),route.route(":file/diagrams/:name/:element").on.value((function(t){const n=t.params.file,a=t.params.name,o=t.params.element;document.getElementById("cim-local-file-component").style.display="none",e.state.dispatcher.trigger("showDiagram",n,a,o)})),route.route(":file/createNew").on.value((function(e){window.history.back(),$("#newDiagramModal").modal("show")}))}},template:function(e,t,n,a){return e('<nav class="navbar navbar-expand-lg navbar-expand navbar-light bg-light"><div class="container-fluid"><a class="navbar-brand" href>CIMDraw</a><div class="collapse navbar-collapse justify-content-between" id="navbarSupportedContent"><ul class="nav navbar-nav" id="cim-home-container"><li class="nav-item"><span class="navbar-text" id="cim-filename"></span></li><li class="nav-item dropdown"><a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">\n                            File <span class="caret"></span></a><div class="dropdown-menu"><a class="dropdown-item" href>Open</a><a class="dropdown-item" id="cim-save" download="file.xml">Save as RDF/XML...</a><a class="dropdown-item" id="cgmes-save">Save as CGMES...</a><a class="dropdown-item" id="cgmes-download" download="file.zip" style="display: none;"></a><a class="dropdown-item" id="cim-export" download="diagram.xml">Export current diagram</a><a class="dropdown-item" id="matpower-export" download="file.m">Export to Matpower</a><input type="file" id="upload-boundary" name="upload"/><a class="dropdown-item" id="load-boundary">Load boundary file</a></div></li><li class="nav-item"><cimtopologyprocessor expr0="expr0"></cimtopologyprocessor></li><li class="nav-item"><select id="cim-diagrams" class="custom-select" onchange="location = this.options[this.selectedIndex].value;" title="Select a diagram"></select></li></ul><span class="navbar-text" id="cim-mode">Mode: Operational</span></div></div></nav><div class="container-fluid"><div class="row justify-content-center" id="cim-local-file-component"><div class="col-md-12 cim-content-center"><div class="row justify-content-center"><div class="col-md-12" id="cim-file-input-container"><br/><br/><div class="custom-file"><input type="file" class="custom-file-input" id="cim-file-input"/><label class="custom-file-label" for="cim-file-input">Use existing file</label></div></div></div><div class="row justify-content-center"><div class="col-md-auto" id="cim-load-container"><br/><a class="btn btn-primary btn-lg" role="button" id="cim-load">Load</a></div></div><div class="row justify-content-center"><div class="col-md-auto"><label class="control-label">or</label></div></div><div class="row justify-content-center"><div class="col-md-auto" id="cim-create-new-container"><button class="btn btn-primary btn-lg" type="button" id="cim-create-new">Create new</button></div></div></div></div><div class="row diagramTools"><div class="col-md-4"></div><div class="col-md-4"></div></div><div class="row"><div class="app-container col-md-12" id="app-container"><cimtree expr1="expr1"></cimtree><cimdiagram expr2="expr2"></cimdiagram></div></div><div class="modal fade" id="newDiagramModal" tabindex="-1" role="dialog" aria-labelledby="newDiagramModalLabel"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="newDiagramModalLabel">Enter a name for the new diagram</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><form><input type="text" class="form-control" id="newDiagramName" placeholder="untitled"/></form></div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button><button type="button" class="btn btn-primary" id="newDiagramBtn">Create</button></div></div></div></div><div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="loadingDiagramModalLabel" data-backdrop="static"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-body"><p id="loadingDiagramMsg">loading diagram...</p></div><div class="modal-footer" id="cim-loading-modal-error-container"><button type="button" class="btn btn-primary" id="cim-loading-modal-error">Ok</button></div></div></div></div><div class="modal fade" id="boundaryModal" tabindex="-1" role="dialog" aria-labelledby="boundaryModalLabel" data-backdrop="static"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-body"><p id="boundaryMsg">loading boundary file...</p></div><div class="modal-footer" id="cim-boundary-modal-error-container"><button type="button" class="btn btn-primary" id="cim-boundary-modal-error">Ok</button></div></div></div></div><div class="modal fade" id="cimModeModal" tabindex="-1" role="dialog" aria-labelledby="cimModeModalLabel"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="cimModeModalLabel">Choose diagram type</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><div class="row justify-content-center"><div class="col-md-auto"><div class="custom-control custom-radio custom-control-inline"><input type="radio" id="operational" name="diagramTypes" class="custom-control-input" checked/><label class="custom-control-label" for="operational">Operational</label></div><div class="custom-control custom-radio custom-control-inline"><input type="radio" id="planning" name="diagramTypes" class="custom-control-input"/><label class="custom-control-label" for="planning">Planning</label></div></div></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" id="cim-create-new-modal">Create</button></div></div></div></div></div>',[{type:n.TAG,getComponent:a,evaluate:function(e){return"cimtopologyprocessor"},slots:[],attributes:[{type:t.ATTRIBUTE,name:"model",evaluate:function(e){return e.state.cimModel}},{type:t.ATTRIBUTE,name:"dispatcher",evaluate:function(e){return e.state.dispatcher}}],redundantAttribute:"expr0",selector:"[expr0]"},{type:n.TAG,getComponent:a,evaluate:function(e){return"cimtree"},slots:[],attributes:[{type:t.ATTRIBUTE,name:"model",evaluate:function(e){return e.state.cimModel}},{type:t.ATTRIBUTE,name:"dispatcher",evaluate:function(e){return e.state.dispatcher}}],redundantAttribute:"expr1",selector:"[expr1]"},{type:n.TAG,getComponent:a,evaluate:function(e){return"cimdiagram"},slots:[],attributes:[{type:t.ATTRIBUTE,name:"model",evaluate:function(e){return e.state.cimModel}},{type:t.ATTRIBUTE,name:"dispatcher",evaluate:function(e){return e.state.dispatcher}}],redundantAttribute:"expr2",selector:"[expr2]"}])},name:"cimdraw"}}));"use strict";function cimSchema(){let e={EQ:null,DL:null,SV:null,TP:null,SSH:null,GL:null};let t=new Map,n=new Map,a=new Map;function o(e,t){let n=[],a=r.getSchemaObject(e,t);if(null===a)return n;let i=[].filter.call(a.children,(function(e){return"rdfs:subClassOf"===e.nodeName}))[0];if(void 0!==i){let e=i.attributes[0].value.substring(1);n.push(e),n=n.concat(o(e,t))}return n}let r={schemaInvLinksMap:new Map,buildSchema(){return null===e.EQ?d3.xml("rdf-schema/EquipmentProfileCoreShortCircuitOperationRDFSAugmented-v2_4_15-16Feb2016.rdf").then((function(n){return e.EQ=n,t(e.EQ),d3.xml("rdf-schema/DiagramLayoutProfileRDFSAugmented-v2_4_15-16Feb2016.rdf")})).then((function(n){return e.DL=n,t(e.DL),d3.xml("rdf-schema/StateVariablesProfileRDFSAugmented-v2_4_15-16Feb2016.rdf")})).then((function(n){return e.SV=n,t(e.SV),d3.xml("rdf-schema/TopologyProfileRDFSAugmented-v2_4_15-16Feb2016.rdf")})).then((function(n){return e.TP=n,t(e.TP),d3.xml("rdf-schema/SteadyStateHypothesisProfileRDFSAugmented-v2_4_15-16Feb2016.rdf")})).then((function(n){return e.SSH=n,t(e.SSH),d3.xml("rdf-schema/GeographicalLocationProfileRDFSAugmented-v2_4_15-16Feb2016.rdf")})).then((function(n){e.GL=n,t(e.GL)})).catch((function(e){return Promise.reject(e)})):Promise.resolve();function t(e){let t=e.children[0].children;for(let e in t){let n=t[e];if(void 0===n.children)continue;let a=[].filter.call(n.children,(function(e){return"cims:inverseRoleName"===e.nodeName}))[0];void 0!==a&&r.schemaInvLinksMap.set(n.attributes[0].value.substring(1),a.attributes[0].value.substring(1))}}},getSchemaObject(t,n){let o=null;for(let r of Object.keys(e)){if(void 0!==n&&n!==r)continue;let i=a.get(r+t);if(void 0!==i){o=i;break}let l=e[r].children[0].children;if(i=[].filter.call(l,(function(e){return e.attributes[0].value==="#"+t}))[0],void 0!==i){o=i,a.set(r+t,i);break}}return o},getSchemaEnumValues(t,n){let a="EQ";void 0!==n&&(a=n);let o=[].filter.call(t.children,(function(e){return"rdfs:range"===e.nodeName}))[0].attributes.getNamedItem("rdf:resource").value.substring(1),r=e[a].children[0].children;return[].filter.call(r,(function(e){return e.attributes[0].value.startsWith("#"+o+".")})).map((e=>[].filter.call(e.children,(function(e){return"rdfs:label"===e.nodeName}))[0].textContent))},getSchemaEnumName:e=>[].filter.call(e.children,(function(e){return"rdfs:range"===e.nodeName}))[0].attributes.getNamedItem("rdf:resource").value.substring(1),getSchemaAttributes(n,a){let r=n,i="EQ";void 0!==a&&(i=a),r+=i;let l=t.get(r);if(void 0===l){let a=e[i].children[0].children;l=[].filter.call(a,(function(e){return e.attributes.getNamedItem("rdf:about").value.startsWith("#"+n+".")}));let s=o(n,i);for(let e in s)l=l.concat([].filter.call(a,(function(t){return t.attributes.getNamedItem("rdf:about").value.startsWith("#"+s[e]+".")})));l=l.filter((function(e){let t=e.attributes.getNamedItem("rdf:about").value;t=t.substring(t.indexOf("#"));let n=!1,a=t.split(".")[1];return void 0!==a&&(n=a.toLowerCase().charAt(0)===a.charAt(0)),n})),t.set(r,l)}return l},getSchemaAttribute:(e,t,n)=>r.getSchemaAttributes(e,n).filter((e=>e.attributes[0].value.substring(1)===t))[0],isEnum:e=>void 0===[].filter.call(e.children,(function(e){return"cims:dataType"===e.nodeName}))[0],getSchemaAttributeType(e){let t="none",n="none";if(r.isEnum(e))return["#Enum",t,n];let a=[].filter.call(e.children,(function(e){return"cims:dataType"===e.nodeName}))[0].attributes.getNamedItem("rdf:resource").value,o=r.getSchemaObject(a.substring(1));if("CIMDatatype"===[].filter.call(o.children,(function(e){return"cims:stereotype"===e.nodeName}))[0].textContent){let e=r.getSchemaObject(a.substring(1)+".value"),o=r.getSchemaObject(a.substring(1)+".unit"),i=r.getSchemaObject(a.substring(1)+".multiplier");if(a=[].filter.call(e.children,(function(e){return"cims:dataType"===e.nodeName}))[0].attributes.getNamedItem("rdf:resource").value,null!==o&&(t=[].filter.call(o.children,(function(e){return"cims:isFixed"===e.nodeName}))[0].attributes.getNamedItem("rdfs:Literal").value),null!==i){let e=[].filter.call(i.children,(function(e){return"cims:isFixed"===e.nodeName}))[0];void 0!==e&&(n=e.attributes.getNamedItem("rdfs:Literal").value)}}return[a,t,n]},getSchemaStereotype(e){let t=[].filter.call(e.children,(function(e){return"cims:stereotype"===e.nodeName&&""!==e.textContent}));return t.length>0?t[0].textContent:null},getSchemaLinks(t,a){let r=t;r+=void 0!==a?a:"EQ";let i=n.get(r);if(void 0===i){let l=e.EQ;void 0!==a&&(l=e[a]);let s=l.children[0].children;i=[].filter.call(s,(function(e){return e.attributes[0].value.startsWith("#"+t+".")}));let c=o(t);for(let e in c)i=i.concat([].filter.call(s,(function(t){return t.attributes[0].value.startsWith("#"+c[e]+".")})));i=i.filter((function(e){let t=!1,n=e.attributes[0].value.split(".")[1];return void 0!==n&&(t=n.toLowerCase().charAt(0)!==n.charAt(0)),t})),n.set(r,i)}return i},getAllSchemasLinks(t){let n=[];return Object.keys(e).forEach((function(e){n=n.concat(r.getSchemaLinks(t,e))})),n},getSchemaLink:(e,t,n)=>r.getSchemaLinks(e,n).filter((e=>e.attributes[0].value.substring(1)===t))[0],getAllSchemasLink:(e,t)=>r.getAllSchemasLinks(e).filter((e=>e.attributes[0].value.substring(1)===t))[0],isA:(e,t)=>t.localName===e||!(o(t.localName).indexOf(e)<0),isConcrete(e,t){let n=!1,a=r.getSchemaObject(e.localName,t);return[].filter.call(a.children,(function(e){return"cims:stereotype"===e.nodeName})).forEach((function(e){let t=e.attributes.getNamedItem("rdf:resource");if(null!==t){"http://iec.ch/TC57/NonStandard/UML#concrete"===t.value&&(n=!0)}})),n},isDescription(e,t){let n=!1,a=r.getSchemaObject(e.localName,t);return[].filter.call(a.children,(function(e){return"cims:stereotype"===e.nodeName})).forEach((function(e){"Description"===e.textContent&&(n=!0)})),n},checkLink(e,t){let n=t,a=r.getAllSchemasLink(e.localName,t.split(":")[1]);if(void 0!==a){if("No"===[].filter.call(a.children,(function(e){return"cims:AssociationUsed"===e.nodeName}))[0].textContent){n="cim:"+r.schemaInvLinksMap.get(t.split(":")[1])}}return n},getLinkDomain(e){if(void 0===e)return null;if(null===e)return null;let t=[].filter.call(e.children,(function(e){return"rdfs:domain"===e.nodeName}))[0];return void 0===t?null:t.attributes.getNamedItem("rdf:resource").value.substring(1)},getLinkRange(e){if(void 0===e)return null;if(null===e)return null;let t=[].filter.call(e.children,(function(e){return"rdfs:range"===e.nodeName}))[0];return void 0===t?null:t.attributes.getNamedItem("rdf:resource").value.substring(1)}};return r}function cimModel(){const e="http://iec.ch/TC57/2013/CIM-schema-cim16#",t="http://entsoe.eu/CIM/SchemaExtension/3/1#",n="http://iec.ch/TC57/61970-552/ModelDescription/1#",a="http://www.w3.org/1999/02/22-rdf-syntax-ns#",o='<?xml version="1.0" encoding="UTF-8" ?><rdf:RDF xmlns:cim="'+e+'" xmlns:entsoe="'+t+'" xmlns:md="'+n+'" xmlns:rdf="'+a+'"></rdf:RDF>';let r={all:null},i=new Map,l=new Map,s="NODE_BREAKER";function c(e){let t=new DOMParser,n=[],a=[],i=[],l=[],s=[],c=[],u=null,p=null;function g(e){return d(e).then((function(e){if(0===n.length||0===a.length||0===i.length||0===l.length||0===s.length||0===c.length||null===u||null===p){let t=[].filter.call(e.children[0].children,(function(e){return"md:FullModel"===e.nodeName}))[0];if(void 0===t)return Promise.reject("error: invalid CGMES file.");let o=A.getAttribute(t,"md:Model.profile");o.textContent.includes("Equipment")&&(!1===o.textContent.includes("Boundary")?n.push(e):u=e),o.textContent.includes("DiagramLayout")&&a.push(e),o.textContent.includes("StateVariables")&&i.push(e),o.textContent.includes("Topology")&&(!1===o.textContent.includes("Boundary")?l.push(e):p=e),o.textContent.includes("SteadyStateHypothesis")&&s.push(e),o.textContent.includes("GeographicalLocation")&&c.push(e)}return Promise.resolve()}))}return function(d){let f=[];return d.forEach((function(e,t){let n=t.async("blob").then(g).catch((function(e){return Promise.reject(e)}));f.push(n)})),Promise.all(f).then((function(){if(n.length>0&&!1===e){let e=t.parseFromString(o,"application/xml");for(let t of n)for(let n of t.children[0].children)"md:FullModel"!==n.nodeName&&e.children[0].appendChild(n.cloneNode(!0));for(let t of a)for(let n of t.children[0].children)"md:FullModel"!==n.nodeName&&e.children[0].appendChild(n.cloneNode(!0));for(let t of i)for(let n of t.children[0].children)"md:FullModel"!==n.nodeName&&e.children[0].appendChild(n.cloneNode(!0));for(let t of l)for(let n of t.children[0].children)"md:FullModel"!==n.nodeName&&e.children[0].appendChild(n.cloneNode(!0));for(let t of s)for(let n of t.children[0].children)"md:FullModel"!==n.nodeName&&e.children[0].appendChild(n.cloneNode(!0));for(let t of c)for(let n of t.children[0].children)"md:FullModel"!==n.nodeName&&e.children[0].appendChild(n.cloneNode(!0));if(null!==u)for(let t of u.children[0].children)"md:FullModel"!==t.nodeName&&e.children[0].appendChild(t.cloneNode(!0));if(null!==p)for(let t of p.children[0].children)"md:FullModel"!==t.nodeName&&e.children[0].appendChild(t.cloneNode(!0));return r.all=e,m()}if(null===r.all||!1===e)return Promise.reject("Invalid CGMES file: no equipment description found.");if(null!==u){let e=u.children[0].children,t=[].filter.call(e,(function(e){return"cim:ConnectivityNode"===e.nodeName})).filter((e=>A.isBoundary(e))).length;return A.updateModel(u),null!==p&&A.updateModel(p),Promise.resolve("Loaded "+t+" boundary nodes.")}return Promise.reject("Invalid boundary file: no equipment boundary file found.")})).catch((function(t){return!1===e&&A.clear(),Promise.reject(t)}))}}function d(e){const t=new FileReader;return new Promise((function(n,a){t.onerror=function(){t.abort(),a(new DOMException("problem parsing input file."))},t.onload=function(){let e=new DOMParser,o=t.result,r=e.parseFromString(o,"application/xml");r.children.length>0&&"rdf:RDF"!==r.children[0].nodeName&&a(new DOMException("invalid input file.")),n(r)},t.readAsText(e)}))}function m(){let e=u();for(let t in e){let n=e[t],a=A.ID(n);if(null!==a&&(i.set("#"+a,n),void 0!==n.attributes)){let e=A.getLinks(n);for(let t of e){let e=t.localName+t.attributes[0].value,a=l.get(e);void 0===a?l.set(e,[n]):a.push(n)}}}for(let t in e){let n=e[t],a=n.attributes.getNamedItem("rdf:about");if(null!==a){let e=i.get(a.value);if(void 0===e)continue;for(let t of A.getAttributes(n))e.appendChild(t.cloneNode(!0));for(let t of A.getLinks(n)){e.appendChild(t.cloneNode(!0));let n=t.localName+t.attributes[0].value,a=l.get(n);void 0===a?l.set(n,[e]):a.push(e)}n.remove()}}return A.schema.buildSchema()}function u(){let e=[];for(let t of Object.keys(r))void 0!==r[t]&&null!==r[t]&&(e=e.concat([...r[t].children[0].children]));return e}function p(t,n){let o=void 0;void 0!==n&&(o=n.uuid);let l=r.all,s=l.createElementNS(e,t);return l.children[0].appendChild(s),void 0!==o?s.setAttributeNS(a,"rdf:ID",o):s.setAttributeNS(a,"rdf:ID",y()),i.set("#"+A.ID(s),s),s}function g(e){let t=p("cim:Terminal");return f(t,"cim:Terminal.ConductingEquipment",e),A.setAttribute(t,"cim:ACDCTerminal.connected","true"),t}function f(t,n,o){if(A.getTargets([t],n).length>0)return;let r=t.ownerDocument.createElementNS(e,n);t.appendChild(r),r.setAttributeNS(a,"rdf:resource","#"+A.ID(o));let i=r.localName+r.attributes[0].value,s=l.get(i);void 0===s?l.set(i,[t]):s.push(t),A.trigger("addLink",t,n,o)}function h(e,t){let n=A.schema.schemaInvLinksMap.get(t),a=new Map,o=[];for(let r of e){let e=A.ID(r),s=A.getLink(r,"cim:"+t);for(let t of s){let n=i.get(t.attributes.getNamedItem("rdf:resource").value);if(void 0!==n){let t=A.ID(n);o.push({source:r,target:n}),a.set(e+t,1)}}let c=l.get(n+"#"+e);if(void 0!==c)for(let t of c){let n=A.ID(t);void 0===a.get(e+n)&&o.push({source:r,target:t})}}return o}function b(e){let t=[];if(0===arguments.length){let e=[];void 0!==A.activeDiagram&&(e=A.getTargets([A.activeDiagram],"Diagram.DiagramElements")),t=h(e,"DiagramObject.IdentifiedObject")}else if(void 0!==A.activeDiagram){let n=A.getTargets(e,"IdentifiedObject.DiagramObjects");n=h(n,"DiagramObject.Diagram").filter((e=>e.target===A.activeDiagram)).map((e=>e.source)),t=h(n,"DiagramObject.IdentifiedObject")}return t}function v(e){let t=[];if(0===arguments.length){if(void 0!==A.activeDiagram){t=h(b().map((e=>e.target)),"ConductingEquipment.Terminals")}}else if(void 0!==A.activeDiagram){t=h(b(e).map((e=>e.target)),"ConductingEquipment.Terminals")}else t=h(e,"ConductingEquipment.Terminals");return t}function y(){let e=(new Date).getTime();return"_"+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)}))}function x(e){return[].filter.call(e.children,(function(e){let t=e.attributes.getNamedItem("rdf:resource");return 0!==e.attributes.length&&null!==t&&"#"!==t.value.charAt(0)}))}function T(e,t){return x(e).filter((e=>e.nodeName===t))[0]}let A={fileName:null,activeDiagramName:"none",schema:new cimSchema,load(e){let t=Promise.resolve();if(A.fileName!==e.name){if(A.fileName=e.name,!e.name.endsWith(".zip")){return d(e).then((function(e){return r.all=e,m()})).catch((function(e){return A.clear(),Promise.reject(e)}))}t=JSZip.loadAsync(e).then(c(!1)).catch((function(e){return A.clear(),Promise.reject(e)}))}return t},newFile(e){let t=new DOMParser;return r.all=t.parseFromString(o,"application/xml"),A.fileName=e,m()},updateModel(e){let t=e.children[0].children;for(let e of t){if("md:FullModel"===e.nodeName)continue;let t=e.attributes.getNamedItem("rdf:ID");if(null===t&&(t=e.attributes.getNamedItem("rdf:about")),null===t)continue;let n=t.value;n.startsWith("#")&&(n=n.substring(1));let a=A.getObject(n);void 0===a&&(a=A.createObject(e.nodeName,{uuid:n}))}for(let e of t){if("md:FullModel"===e.nodeName)continue;let t=e.attributes.getNamedItem("rdf:ID");if(null===t&&(t=e.attributes.getNamedItem("rdf:about")),null===t)continue;let n=t.value;n.startsWith("#")&&(n=n.substring(1));let a=A.getObject(n);if(void 0===a)continue;let o=A.getAttributes(e);for(let e of o)A.setAttribute(a,e.nodeName,e.innerHTML);let r=A.getLinks(e);for(let e of r){let t=e.attributes.getNamedItem("rdf:resource").value.substring(1);A.setLink(a,e.nodeName,A.getObject(t))}}},loadBoundary(e){let t=Promise.resolve();return t=e.name.endsWith(".zip")?JSZip.loadAsync(e).then(c(!0)).catch((function(e){return Promise.reject(e)})):Promise.reject("Error: not a boundary file."),t},loadRemote(e){let t=Promise.resolve();return A.fileName!==decodeURI(e).substring(1)&&(A.fileName=decodeURI(e).substring(1),t=d3.xml(e).then((function(e){return r.all=e,m()})).catch((function(e){return A.clear(),Promise.reject(e)}))),t},save(){if(null===r.all)throw new Error("error: no CIM file loaded.");let e="";return e=(new XMLSerializer).serializeToString(r.all),e},saveAsCGMES(){if(null===r.all)return Promise.reject("error: no CIM file loaded.");let e=new XMLSerializer,t=new JSZip,a=null,i=[];for(let e of r.all.children[0].children){A.getLinks(e).forEach((function(t){let n=A.schema.checkLink(e,t.nodeName);if(n!==t.nodeName){A.getTargets([e],t.localName).forEach((function(t){i.push({s:t,l:n,t:e})}))}}))}i.forEach((function(e){A.setLink(e.s,e.l,e.t)})),a=r.all.children[0].cloneNode(!0).children;let l=["http://entsoe.eu/CIM/EquipmentCore/3/1"];"NODE_BREAKER"===s&&l.push("http://entsoe.eu/CIM/EquipmentOperation/3/1");let c=f("EQ",l,a,[]),d=f("DL",["http://entsoe.eu/CIM/DiagramLayout/3/1"],a,[c]),m=f("SV",["http://entsoe.eu/CIM/StateVariables/4/1"],a,[c]),u=f("TP",["http://entsoe.eu/CIM/Topology/4/1"],a,[c]),p=f("SSH",["http://entsoe.eu/CIM/SteadyStateHypothesis/1/1"],a,[c]),g=f("GL",["http://entsoe.eu/CIM/GeographicalLocation/2/1"],a,[c]);return t.file("EQ.xml",e.serializeToString(c)),t.file("DL.xml",e.serializeToString(d)),t.file("SV.xml",e.serializeToString(m)),t.file("TP.xml",e.serializeToString(u)),t.file("SSH.xml",e.serializeToString(p)),t.file("GL.xml",e.serializeToString(g)),t.generateAsync({type:"blob",compression:"DEFLATE"});function f(e,t,a,r){let i=[].filter.call(a,(function(t){return null!==A.schema.getSchemaObject(t.localName,e)})),l=function(e,t){let a=(new DOMParser).parseFromString(o,"application/xml"),r=document.createElementNS(n,"md:FullModel");return a.children[0].appendChild(r),r.setAttribute("rdf:about","urn:uuid:"+y().substring(1)),e.forEach((function(e){let t=r.ownerDocument.createElementNS(n,"md:Model.profile");t.innerHTML=e,r.appendChild(t)})),t.forEach((function(e){let t=[].filter.call(e.children[0].children,(function(e){return"md:FullModel"===e.nodeName}))[0],n=r.ownerDocument.createElement("md:Model.DependentOn");n.setAttribute("rdf:resource",t.attributes.getNamedItem("rdf:about").value),r.appendChild(n)})),a}(t,r);return function(e,t,n){for(let a in t){let o=t[a].cloneNode();A.getAttributes(t[a]).forEach((function(e){void 0!==A.schema.getSchemaAttribute(o.localName,e.localName,n)&&o.appendChild(e)})),A.getLinks(t[a]).forEach((function(e){void 0!==A.schema.getSchemaLink(o.localName,e.localName,n)&&o.appendChild(e)})),x(t[a]).forEach((function(e){void 0!==A.schema.getSchemaAttribute(o.localName,e.localName,n)&&o.appendChild(e)}));let r=A.schema.isDescription(o,n),i=A.schema.isConcrete(o,n);if(!0===r&&null!==A.ID(o)){let e=A.ID(o);o.removeAttribute("rdf:ID");let t=o.ownerDocument.createAttribute("rdf:about");t.value="#"+e,o.setAttributeNode(t)}!0===i&&(!1===r||o.children.length>0)&&e.children[0].appendChild(o)}}(l,i,e),l}},export(){let e=new DOMParser,t=new XMLSerializer,n=e.parseFromString(o,"application/xml");if(void 0===A.activeDiagram)return t.serializeToString(n);n.children[0].appendChild(A.activeDiagram.cloneNode(!0));let a=A.getTargets([A.activeDiagram],"Diagram.DiagramElements");for(let e of a)n.children[0].appendChild(e.cloneNode(!0));let r=A.getTargets(a,"DiagramObject.IdentifiedObject");for(let e of r)n.children[0].appendChild(e.cloneNode(!0));let i=A.getTargets(a,"DiagramObject.DiagramObjectPoints");for(let e of i)n.children[0].appendChild(e.cloneNode(!0));let l=A.getTerminals(r);for(let e of l)n.children[0].appendChild(e.cloneNode(!0));let s=A.getNodes();for(let e of s)n.children[0].appendChild(e.cloneNode(!0));let c=A.getLinkedObjects(["cim:Substation","cim:Line"],["EquipmentContainer.Equipments"]),d=c["cim:Substation"];for(let e of d)n.children[0].appendChild(e.cloneNode(!0));let m=c["cim:Line"];for(let e of m)n.children[0].appendChild(e.cloneNode(!0));let u=A.getTargets(r,"ConductingEquipment.BaseVoltage");for(let e of u)n.children[0].appendChild(e.cloneNode(!0));let p=A.getTargets(r,"PowerTransformer.PowerTransformerEnd");for(let e of p)n.children[0].appendChild(e.cloneNode(!0));let g=A.getTargets(l,"ACDCTerminal.Measurements");for(let e of g)n.children[0].appendChild(e.cloneNode(!0));let f=A.getTargets(g,"Analog.AnalogValues");for(let e of f)n.children[0].appendChild(e.cloneNode(!0));return t.serializeToString(n)},getDiagramList:()=>A.getObjects(["cim:Diagram"])["cim:Diagram"].map((e=>(void 0===A.getAttribute(e,"cim:IdentifiedObject.name")&&A.setAttribute(e,"cim:IdentifiedObject.name","unnamed diagram"),A.getAttribute(e,"cim:IdentifiedObject.name")))).map((e=>e.textContent)),getObjects(e){let t={},n=u();for(let n of e)t[n]=[];return t=[].reduce.call(n,(function(e,t){return void 0!==e[t.nodeName]&&e[t.nodeName].push(t),e}),t),t},getSubObjects:e=>u().filter((function(t){return!0===A.schema.isA(e,t)})),getGraphicObjects(e){let t={},n=b().map((e=>e.target)),a=new Set(n);for(let n of e)t[n]=[];return t=[...a].reduce((function(e,t){return void 0!==e[t.nodeName]&&e[t.nodeName].push(t),e}),t),t},getNodes(){let e="cim:ConnectivityNode";"BUS_BRANCH"===s&&(e="cim:TopologicalNode");let t=A.getObjects([e])[e],n=A.getGraphicObjects([e])[e],a=t.filter((e=>-1===n.indexOf(e)));return a=a.filter((function(e){let t=A.getBusbar(e),n=A.getEquipments(e);return null!==t||n.length>1})),n.concat(a)},getConnectors(e){let t={};for(let n of e){let e=A.getObjects([n])[n],a=A.getGraphicObjects([n])[n],o=e.filter((e=>-1===a.indexOf(e)));o=o.filter((function(e){let t=A.getNode(e);if(null!==t){return A.getDiagramObjects([t]).length>0}return!1})),t[n]=a.concat(o)}return t},getLinkedObjects(e,t){let n={};for(let a of e)n[a]=A.getObjects([a])[a].filter((function(e){let n=[e],a=[];for(let a of t){let t=a.split("/"),o=[e];for(let e=0;e<t.length-1;e++)o=A.getTargets(o,t[e]);n=n.concat(o)}for(let e of t){let t=e.split("/"),o=t.length-1;a=a.concat(A.getTargets(n,t[o]))}return A.getDiagramObjects(n.concat(a)).length>0}));return n},getTerminals(e){let t=v(e).map((e=>e.target));return t=[...new Set(t)],t},getObject:e=>i.get("#"+e),getAttributes(e){if(null!=e)return[].filter.call(e.children,(function(e){return 0===e.attributes.length}))},getAttribute(e,t){if(void 0===e)return;if(null===e)return;return A.getAttributes(e).filter((e=>e.nodeName===t))[0]},setAttribute(n,a,o){let r=A.getAttribute(n,a);if(void 0!==r)r.innerHTML=o;else{let i=e;a.startsWith("entsoe:")&&(i=t),r=n.ownerDocument.createElementNS(i,a),r.innerHTML=o,n.appendChild(r)}A.trigger("setAttribute",n,a,o)},setEnum(t,n,a){let o=T(t,n);if(void 0===o){o=t.ownerDocument.createElement(n);let e=t.ownerDocument.createAttribute("rdf:resource");e.nodeValue="#",o.setAttributeNode(e),t.appendChild(o)}o.attributes[0].value=e+a,A.trigger("setEnum",t,n,a)},createObject(e,t){let n=p(e,t);if(A.schema.isA("IdentifiedObject",n)&&A.setAttribute(n,"cim:IdentifiedObject.name","new1"),!1===A.schema.isA("ConductingEquipment",n))return A.trigger("createObject",n),n;let a=2,o=null;void 0!==t&&(void 0!==t.windNum&&(a=t.windNum),void 0!==t.node&&(o=t.node));let r=g(n),i=null,l=null;if("cim:ACLineSegment"!==e&&"cim:Breaker"!==e&&"cim:Disconnector"!==e&&"cim:LoadBreakSwitch"!==e&&"cim:Junction"!==e&&"cim:PowerTransformer"!==e||(i=g(n)),"cim:PowerTransformer"===e&&3===a&&(l=g(n)),"cim:BusbarSection"===e){let e="ConnectivityNode";"BUS_BRANCH"===s&&(e="TopologicalNode"),null===o&&(o=p("cim:"+e)),f(r,"cim:Terminal."+e,o)}if("cim:PowerTransformer"===e){let e=p("cim:PowerTransformerEnd"),t=p("cim:PowerTransformerEnd");if(A.setAttribute(e,"cim:IdentifiedObject.name","winding1"),A.setAttribute(t,"cim:IdentifiedObject.name","winding2"),f(n,"cim:PowerTransformer.PowerTransformerEnd",e),f(n,"cim:PowerTransformer.PowerTransformerEnd",t),f(e,"cim:TransformerEnd.Terminal",r),f(t,"cim:TransformerEnd.Terminal",i),3===a){let e=p("cim:PowerTransformerEnd");A.setAttribute(e,"cim:IdentifiedObject.name","winding3"),f(n,"cim:PowerTransformer.PowerTransformerEnd",e),f(e,"cim:TransformerEnd.Terminal",l)}}return A.trigger("createObject",n),n},deleteObjects(e){let t=[],n=[];for(let l of e){"cim:ConnectivityNode"!==l.nodeName&&"cim:TopologicalNode"!==l.nodeName||(n=n.concat(r(l))),"cim:BusbarSection"===l.nodeName&&(n=n.concat(o(l)));let e=A.getLinks(l);for(let o of e){let e=i.get(o.attributes.getNamedItem("rdf:resource").value),r=o.nodeName;void 0!==e&&(a(l,e)&&n.push(e),t.push({s:l,l:r,t:e}))}}for(let[o,r]of l){let l=o.split("#"),s="cim:"+l[0],c="#"+l[1],d=i.get(c);if(e.indexOf(d)>-1)for(let e of r)t.push({s:e,l:s,t:d}),a(d,e)&&n.push(e)}for(let e of t)A.removeLink(e.s,e.l,e.t);n.length>0&&A.deleteObjects(n);for(let t of e){let e=A.ID(t);i.delete("#"+e),t.remove(),A.trigger("deleteObject",e)}function a(e,t){return!(!A.schema.isA("ConductingEquipment",e)||"cim:Terminal"!==t.nodeName)||("cim:DiagramObjectPoint"===t.nodeName||("cim:DiagramObjectPoint"!==e.nodeName&&"cim:DiagramObject"===t.nodeName||("cim:PowerTransformer"===e.nodeName&&"cim:PowerTransformerEnd"===t.nodeName||("cim:GeographicalRegion"===e.nodeName&&"cim:SubGeographicalRegion"===t.nodeName||("cim:SubGeographicalRegion"===e.nodeName&&"cim:Substation"===t.nodeName||("cim:Substation"===e.nodeName&&"cim:VoltageLevel"===t.nodeName||"cim:VoltageLevel"===e.nodeName&&"cim:Bay"===t.nodeName))))))}function o(e){let t="ConnectivityNode";if("BUS_BRANCH"===s&&(t="TopologicalNode"),"cim:BusbarSection"===e.nodeName){let n=A.getTargets([e],"ConductingEquipment.Terminals");return A.getTargets(n,"Terminal."+t)}return[]}function r(e){let t="ConnectivityNode.Terminals";"BUS_BRANCH"===s&&(t="TopologicalNode.Terminal");let n=A.getTargets([e],t);return A.getTargets(n,"Terminal.ConductingEquipment").filter((e=>"cim:BusbarSection"===e.nodeName))}},deleteObject(e){A.deleteObjects([e])},getNode(e){let t="ConnectivityNode";if("BUS_BRANCH"===s&&(t="TopologicalNode"),"cim:BusbarSection"===e.nodeName){let n=A.getTargets([e],"ConductingEquipment.Terminals"),a=A.getTargets(n,"Terminal."+t);return 0===a.length?null:a[0]}return null},getBusbar(e){let t="ConnectivityNode.Terminals";"BUS_BRANCH"===s&&(t="TopologicalNode.Terminal");let n=A.getTargets([e],t),a=A.getTargets(n,"Terminal.ConductingEquipment").filter((e=>"BusbarSection"===e.localName)),o=A.getDiagramObjects([e].concat(a));return a.length>0&&o.length>0?a[0]:null},deleteFromDiagram(e){let t=A.ID(e),n=A.getDiagramObjects([e]),a="ConnectivityNode";if("BUS_BRANCH"===s&&(a="TopologicalNode"),"BusbarSection"===e.localName){let t=A.getNode(e);n=n.concat(A.getDiagramObjects([t]))}if(e.localName===a){let t=A.getBusbar(e);null!==t&&(n=n.concat(A.getDiagramObjects([t])))}let o=A.getTargets(n,"DiagramObject.DiagramObjectPoints");for(let e of n)A.deleteObject(e);for(let e of o)A.deleteObject(e);A.trigger("deleteFromDiagram",t)},addToActiveDiagram(e,t){let n=p("cim:DiagramObject");for(let a of t){let t=p("cim:DiagramObjectPoint");A.setAttribute(t,"cim:DiagramObjectPoint.xPosition",a.x+e.x),A.setAttribute(t,"cim:DiagramObjectPoint.yPosition",a.y+e.y),A.setAttribute(t,"cim:DiagramObjectPoint.sequenceNumber",a.seq),f(t,"cim:DiagramObjectPoint.DiagramObject",n)}void 0!==e.rotation&&A.setAttribute(n,"cim:DiagramObject.rotation",e.rotation),f(n,"cim:DiagramObject.IdentifiedObject",e),f(n,"cim:DiagramObject.Diagram",A.activeDiagram),A.trigger("addToActiveDiagram",e)},updateActiveDiagram(e,t){let n=A.getDiagramObjects([e]);if(("cim:ConnectivityNode"===e.nodeName||"cim:TopologicalNode"===e.nodeName)&&0===n.length){let t=A.getEquipments(e).filter((e=>"BusbarSection"===e.localName))[0];void 0!==t&&(n=A.getDiagramObjects([t]))}for(let t of n)A.setAttribute(t,"cim:DiagramObject.rotation",e.rotation);let a=A.getTargets(n,"DiagramObject.DiagramObjectPoints");if(a.length>0){for(let t of a){let n=1,a=A.getAttribute(t,"cim:DiagramObjectPoint.sequenceNumber");void 0!==a&&(n=parseInt(a.innerHTML));let o=e.lineData.filter((e=>e.seq===n))[0];A.getAttribute(t,"cim:DiagramObjectPoint.xPosition").innerHTML=o.x+e.x,A.getAttribute(t,"cim:DiagramObjectPoint.yPosition").innerHTML=o.y+e.y}A.trigger("updateActiveDiagram",e)}else A.addToActiveDiagram(e,e.lineData)},getLinks:e=>[].filter.call(e.children,(function(e){let t=e.attributes.getNamedItem("rdf:resource");return 0!==e.attributes.length&&null!==t&&"#"===t.value.charAt(0)})),getLink:(e,t)=>A.getLinks(e).filter((e=>e.nodeName===t)),getEnum(e,t){let n=T(e,t),a=void 0;return void 0!==n&&(a=n.attributes.getNamedItem("rdf:resource").value.split("#")[1].split(".")[1]),a},setLink(e,t,n){let a=A.getTargets([e],t.split(":")[1]);for(let n of a)A.removeLink(e,t,n);f(e,t,n)},removeLink(e,t,n){o(A.getLink(e,t),e,n);let a=A.schema.schemaInvLinksMap.get(t.split(":")[1]);if(void 0!==a){o(A.getLink(n,"cim:"+a),n,e)}function o(e,t,n){for(let a of e){let e=a.attributes.getNamedItem("rdf:resource").value;if(e==="#"+A.ID(n)){let n=a.localName+e,o=l.get(n);a.remove(),1===o.length?l.delete(n):o.splice(o.indexOf(t),1)}}}A.trigger("removeLink",e,t,n)},getTargets(e,t){let n=h(e,t).map((e=>e.target));return[...new Set(n)]},getDiagramObjects(e){let t=b(e).map((e=>e.source));return[...new Set(t)]},getEquipments(e){let t="ConnectivityNode.Terminals";"BUS_BRANCH"===s&&(t="TopologicalNode.Terminal");let n=A.getTargets([e],t),a=A.getTargets(n,"Terminal.ConductingEquipment");return a=v(a).map((e=>e.source)),[...new Set(a)]},selectDiagram(e){e!==A.activeDiagramName&&(A.activeDiagramName=e,A.activeDiagram=A.getObjects(["cim:Diagram"])["cim:Diagram"].filter((e=>A.getAttribute(e,"cim:IdentifiedObject.name").textContent===A.activeDiagramName))[0]),void 0===A.activeDiagram&&(A.activeDiagram=p("cim:Diagram"),A.setAttribute(A.activeDiagram,"cim:IdentifiedObject.name",e),A.activeDiagramName=e,A.trigger("createdDiagram")),A.trigger("changedDiagram")},isBoundary(e){let t=!1,n=A.getAttribute(e,"entsoe:ConnectivityNode.boundaryPoint");return void 0!==n&&"true"===n.textContent&&(t=!0),t},getMode:()=>s,setMode(e){"NODE_BREAKER"!==e&&"BUS_BRANCH"!==e||(s=e),A.trigger("setMode",s)},ID(e){if(null==e)return null;if(void 0===e.attributes)return null;{let t=e.attributes.getNamedItem("rdf:ID");return null===t?null:t.value}},clear(){r.all=null,A.fileName=null,i=new Map,l=new Map}};return observable(A),A}function topologyProcessor(e){return{calcTopology(){let t=[],n=e.getObjects(["cim:TopologicalNode"])["cim:TopologicalNode"];"BUS_BRANCH"===e.getMode()&&n.forEach((function(t){let n=e.createObject("cim:ConnectivityNode");e.getTargets([t],"TopologicalNode.Terminal").forEach((function(t){e.setLink(t,"cim:Terminal.ConnectivityNode",n)}))})),e.deleteObjects(n),n=[];let a=[],o=e.getObjects(["cim:ConnectivityNode"])["cim:ConnectivityNode"];for(;o.length>0;){let e=r(o[0]);o=o.filter((t=>e.indexOf(t)<0)),a.push(e)}function r(t){let n=new Set,a=-1;for(n.add(t);a!==n.size;){a=n.size;let t=e.getTargets([...n],"ConnectivityNode.Terminals"),o=e.getTargets(t,"Terminal.ConductingEquipment").filter((function(t){return!0===e.schema.isA("Switch",t)}));o=o.filter((function(t){let n=!0,a=e.getAttribute(t,"cim:Switch.open");return void 0!==a&&(n="false"===a.textContent),n}));let r=e.getTargets(o,"ConductingEquipment.Terminals"),i=e.getTargets(r,"Terminal.ConnectivityNode");for(let e of i)n.add(e)}return[...n]}return a.forEach((function(n){let a=e.createObject("cim:TopologicalNode");n.forEach((function(t){e.setLink(t,"cim:ConnectivityNode.TopologicalNode",a)}));let o=e.getTargets(n,"ConnectivityNode.Terminals"),r=e.getTargets(o,"Terminal.ConductingEquipment"),i=e.getTargets(r,"ConductingEquipment.BaseVoltage");if(i.length>0)e.setLink(a,"cim:TopologicalNode.BaseVoltage",i[0]);else{let t=e.getTargets(o,"Terminal.TransformerEnd");if(i=e.getTargets(t,"TransformerEnd.BaseVoltage"),i.length>0)console.log(t),e.setLink(a,"cim:TopologicalNode.BaseVoltage",i[0]);else{let t=e.getTargets(r,"Equipment.EquipmentContainer"),n=t.filter((t=>e.schema.isA("VoltageLevel",t)));if(i=e.getTargets(n,"VoltageLevel.BaseVoltage"),i.length>0)e.setLink(a,"cim:TopologicalNode.BaseVoltage",i[0]);else{let o=t.filter((t=>e.schema.isA("Bay",t)));n=e.getTargets(o,"Bay.VoltageLevel"),i=e.getTargets(n,"VoltageLevel.BaseVoltage"),i.length>0&&e.setLink(a,"cim:TopologicalNode.BaseVoltage",i[0])}}}o.forEach((function(t){e.setLink(t,"cim:Terminal.TopologicalNode",a),void 0===e.getAttribute(t,"cim:ACDCTerminal.connected")&&e.setAttribute(t,"cim:ACDCTerminal.connected","true")})),t.push(a)})),t},getTerminals(t){let n=[];return n=e.schema.isA("TopologicalNode",t)?e.getTargets([t],"TopologicalNode.Terminal"):e.schema.isA("TransformerEnd",t)?e.getTargets([t],"TransformerEnd.Terminal"):e.getTargets([t],"ConductingEquipment.Terminals"),n=n.filter((function(t){let n=e.getAttribute(t,"cim:ACDCTerminal.connected");return void 0!==n&&"true"===n.textContent})),n}}}function exportToMatpower(e){let t="function mpc = cim\n",n="100",a=[],o=topologyProcessor(e);a="NODE_BREAKER"===e.getMode()?o.calcTopology():e.getObjects(["cim:TopologicalNode"])["cim:TopologicalNode"],t+="% MATPOWER Case Format : Version 2\n",t+="mpc.version = '2';\n",t+="% system MVA base\n",t=t+"mpc.baseMVA = "+"100;\n",t+="% bus data\n",t+="mpc.bus = [\n",t+="%bus_i\ttype\tPd\tQd\tGs\tBs\tarea\tVm\tVa\tbaseKV\tzone\tVmax\tVmin\n";let r=new Map;for(let n in a){let i=e.ID(a[n]),l=1,s=d(e.getTargets([a[n]],"TopologicalNode.BaseVoltage")[0],"cim:BaseVoltage.nominalVoltage","0"),c=parseInt(n)+1,m=o.getTerminals(a[n]),u=e.getTargets(m,"Terminal.ConductingEquipment"),p=u.filter((t=>!0===e.schema.isA("EnergyConsumer",t))),g=u.filter((t=>!0===e.schema.isA("ShuntCompensator",t))),f=u.filter((t=>!0===e.schema.isA("SynchronousMachine",t))),h=u.filter((t=>!0===e.schema.isA("AsynchronousMachine",t))),b=(e.getTargets(m,"Terminal.TransformerEnd"),0),v=0,y=1;p.forEach((function(e){b+=parseFloat(d(e,"cim:EnergyConsumer.p","0.0")),v+=parseFloat(d(e,"cim:EnergyConsumer.q","0.0"))})),h.forEach((function(e){b+=parseFloat(d(e,"cim:RotatingMachine.p","0")),v+=parseFloat(d(e,"cim:RotatingMachine.q","0"))}));let x=0,T=0;if(g.forEach((function(e){let t=parseFloat(d(e,"cim:ShuntCompensator.sections","0.0")),n=parseFloat(d(e,"cim:LinearShuntCompensator.gPerSection","0.0")),a=parseFloat(d(e,"cim:LinearShuntCompensator.bPerSection","0.0"));x+=n*t,T+=a*t})),x=x*s*s,T=T*s*s,f.length>0||g.length>0){if(g.length>0){let t=o.getTerminals(g[0]),n=(e.getTargets(t,"Terminal.TopologicalNode"),e.getTargets([g[0]],"RegulatingCondEq.RegulatingControl")[0]);if(void 0!==n){l=2;let e=d(n,"cim:RegulatingControl.targetValue",s);y=parseFloat(e)/parseFloat(s)}}if(f.length>0){void 0!==e.getTargets([f[0]],"RegulatingCondEq.RegulatingControl")[0]&&(l=2)}}f.filter((function(e){return parseInt(d(e,"cim:SynchronousMachine.referencePriority","0"))>0})).length>0&&(l=3),t=t+c+"\t",t=t+l+"\t",t=t+b+"\t",t=t+v+"\t",t=t+x+"\t",t=t+T+"\t",t=t+1+"\t",t=t+y+"\t",t=t+0+"\t",t=t+s+"\t",t=t+1+"\t",t=t+1.1+"\t",t=t+.9+";\t",t=t+"%Node ("+i+")",t+="\n",r.set(a[n],c)}t+="];\n";let i=e.getObjects(["cim:SynchronousMachine"])["cim:SynchronousMachine"],l=e.getObjects(["cim:EquivalentInjection"])["cim:EquivalentInjection"];t+="% generator data\n",t+="mpc.gen = [\n",t+="%bus\tPg\tQg\tQmax\tQmin\tVg\tmBase\tstatus\tPmax\tPmin\tPc1\tPc2\tQc1min\tQc1max\tQc2min\tQc2max\tramp_agc\tramp_10\tramp_30\tramp_q\tapf\n",i.forEach((function(a){let i={};i.genUUID=e.ID(a);let l=o.getTerminals(a),s=e.getTargets(l,"Terminal.TopologicalNode"),m=e.getTargets([a],"RotatingMachine.GeneratingUnit")[0],u=e.getTargets([a],"RegulatingCondEq.RegulatingControl")[0];s.forEach((function(o){if(i.busNum=r.get(o),i.p=-1*parseFloat(d(a,"cim:RotatingMachine.p","0")),i.q=-1*parseFloat(d(a,"cim:RotatingMachine.q","0")),i.qmax=parseFloat(d(a,"cim:SynchronousMachine.maxQ","0")),i.qmin=parseFloat(d(a,"cim:SynchronousMachine.minQ","0")),i.vg=1,void 0!==u){let t=d(e.getTargets([o],"TopologicalNode.BaseVoltage")[0],"cim:BaseVoltage.nominalVoltage","0"),n=d(u,"cim:RegulatingControl.targetValue",t);i.vg=parseFloat(n)/parseFloat(t)}i.mbase=parseFloat(d(a,"cim:SynchronousMachine.ratedS",n)),i.pmax=parseFloat(d(m,"cim:GeneratingUnit.maxOperatingP","0")),i.pmin=parseFloat(d(m,"cim:GeneratingUnit.minOperatingP","0")),t+=c(i)}))})),l.forEach((function(a){let i={};i.genUUID=e.ID(a);let l=o.getTerminals(a),s=e.getTargets(l,"Terminal.TopologicalNode"),m=d(a,"cim:EquivalentInjection.regulationStatus","false");s.forEach((function(o){if(i.busNum=r.get(o),i.p=-1*parseFloat(d(a,"cim:EquivalentInjection.p","0")),i.q=-1*parseFloat(d(a,"cim:EquivalentInjection.q","0")),i.qmax=parseFloat(d(a,"cim:EquivalentInjection.maxQ","0")),i.qmin=parseFloat(d(a,"cim:EquivalentInjection.minQ","0")),i.vg=1,"true"===m){let t=d(e.getTargets([o],"TopologicalNode.BaseVoltage")[0],"cim:BaseVoltage.nominalVoltage","0"),n=d(a,"cim:EquivalentInjection.regulationTarget",t);i.vg=parseFloat(n)/parseFloat(t)}i.mbase=n,i.pmax=parseFloat(d(a,"cim:EquivalentInjection.maxP","0")),i.pmin=parseFloat(d(a,"cim:EquivalentInjection.minP","0")),t+=c(i)}))})),t+="];\n";let s=e.getObjects(["cim:ACLineSegment"])["cim:ACLineSegment"];return t+="% branch data\n",t+="mpc.branch = [\n",t+="%fbus\ttbus\tr\tx\tb\trateA\trateB\trateC\tratio\tangle\tstatus\tangmin\tangmax\n",s.forEach((function(a){let i=e.ID(a),l=o.getTerminals(a),s=e.getTargets(l,"Terminal.TopologicalNode");if(2===s.length){let o=d(e.getTargets(s,"TopologicalNode.BaseVoltage")[0],"cim:BaseVoltage.nominalVoltage","0"),l=parseFloat(o)*parseFloat(o)/parseFloat(n),c=d(a,"cim:ACLineSegment.r","0"),m=d(a,"cim:ACLineSegment.x","0"),u=d(a,"cim:ACLineSegment.bch","0"),p=parseFloat(c)/l,g=parseFloat(m)/l,f=parseFloat(u)*l;t=t+r.get(s[0])+"\t",t=t+r.get(s[1])+"\t",t=t+p+"\t",t=t+g+"\t",t=t+f+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+1+"\t",t+="-360\t",t+="360;\t",t=t+"%AC line segment ("+i+")",t+="\n"}})),e.getObjects(["cim:PowerTransformer"])["cim:PowerTransformer"].forEach((function(a){let i=e.ID(a),l=e.getTargets([a],"PowerTransformer.PowerTransformerEnd");if(2===l.length){let a=l[0],s=l[1],c=d(a,"cim:PowerTransformerEnd.r","0"),m=d(a,"cim:PowerTransformerEnd.x","0");"0"===c&&"0"===m&&(s=l[0],a=l[1],c=d(a,"cim:PowerTransformerEnd.r","0"),m=d(a,"cim:PowerTransformerEnd.x","0"));let u=d(a,"cim:PowerTransformerEnd.b","0"),p=o.getTerminals(a),g=e.getTargets(p,"Terminal.TopologicalNode")[0],f=o.getTerminals(s),h=e.getTargets(f,"Terminal.TopologicalNode")[0];if(1===p.length&&1===f.length&&void 0!==g&&void 0!==h){let o=d(e.getTargets([g],"TopologicalNode.BaseVoltage")[0],"cim:BaseVoltage.nominalVoltage","0"),l=d(e.getTargets([h],"TopologicalNode.BaseVoltage")[0],"cim:BaseVoltage.nominalVoltage","0"),p=d(a,"cim:PowerTransformerEnd.ratedU",o),f=d(s,"cim:PowerTransformerEnd.ratedU",l),b=parseFloat(o)*parseFloat(o)/parseFloat(n),v=parseFloat(c)/b,y=parseFloat(m)/b,x=parseFloat(u)*b,T=e.getTargets([a],"TransformerEnd.RatioTapChanger"),A=parseFloat(l)*parseFloat(p)/(parseFloat(o)*parseFloat(f)),w=!1;if(0===T.length&&(T=e.getTargets([s],"TransformerEnd.RatioTapChanger"),w=!0),T.length>0){let e=d(T[0],"cim:TapChanger.neutralStep","0"),t=d(T[0],"cim:TapChanger.step",e),n=d(T[0],"cim:RatioTapChanger.stepVoltageIncrement","0"),a=(parseFloat(t)-parseFloat(e))*parseFloat(n);a/=100,a=1+a,!0===w&&(a=1/a),A*=a}t=t+r.get(g)+"\t",t=t+r.get(h)+"\t",t=t+v+"\t",t=t+y+"\t",t=t+x+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+A+"\t",t=t+0+"\t",t=t+1+"\t",t+="-360\t",t+="360;\t",t=t+"%Two-winding transformer ("+i+")",t+="\n"}}if(3===l.length){let a=l[0],s=l[1],c=l[2],f=d(a,"cim:PowerTransformerEnd.r","0"),h=d(s,"cim:PowerTransformerEnd.r","0"),b=d(c,"cim:PowerTransformerEnd.r","0"),v=d(a,"cim:PowerTransformerEnd.x","0"),y=d(s,"cim:PowerTransformerEnd.x","0"),x=d(c,"cim:PowerTransformerEnd.x","0"),T=d(a,"cim:PowerTransformerEnd.b","0"),A=d(s,"cim:PowerTransformerEnd.b","0"),w=d(c,"cim:PowerTransformerEnd.b","0"),C=o.getTerminals(a),N=o.getTerminals(s),S=o.getTerminals(c),E=e.getTargets(C,"Terminal.TopologicalNode")[0],L=e.getTargets(N,"Terminal.TopologicalNode")[0],k=e.getTargets(S,"Terminal.TopologicalNode")[0];if(1===C.length&&1===N.length&&1===S.length){let o=e.getTargets([E],"TopologicalNode.BaseVoltage")[0],l=e.getTargets([L],"TopologicalNode.BaseVoltage")[0],C=e.getTargets([k],"TopologicalNode.BaseVoltage")[0],N=d(o,"cim:BaseVoltage.nominalVoltage","0"),S=d(l,"cim:BaseVoltage.nominalVoltage","0"),D=d(C,"cim:BaseVoltage.nominalVoltage","0"),M=d(a,"cim:PowerTransformerEnd.ratedU",N),I=d(s,"cim:PowerTransformerEnd.ratedU",S),B=d(c,"cim:PowerTransformerEnd.ratedU",D),O=parseFloat(N)*parseFloat(N)/parseFloat(n),j=parseFloat(S)*parseFloat(S)/parseFloat(n),R=parseFloat(D)*parseFloat(D)/parseFloat(n),P=parseFloat(f)/O,q=parseFloat(h)/j,V=parseFloat(b)/R,F=parseFloat(v)/O,G=parseFloat(y)/j,U=parseFloat(x)/R,H=parseFloat(T)*O,z=parseFloat(A)*j,_=parseFloat(w)*R,$=m(P,F),Q=m(q,G),J=m(V,U),W=u(u(p($,Q),p(Q,J)),p(J,$)),Z=p(W,g(J)),K=p(W,g($)),X=p(W,g(Q)),Y=parseFloat(S)*parseFloat(M)/(parseFloat(N)*parseFloat(I)),ee=parseFloat(D)*parseFloat(I)/(parseFloat(S)*parseFloat(B)),te=parseFloat(N)*parseFloat(B)/(parseFloat(D)*parseFloat(M));t=t+r.get(E)+"\t",t=t+r.get(L)+"\t",t=t+Z.re+"\t",t=t+Z.im+"\t",t=t+H+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+Y+"\t",t=t+0+"\t",t=t+1+"\t",t+="-360\t",t+="360;\t",t=t+"%Three-winding transformer branch 1-2 ("+i+")",t+="\n",t=t+r.get(L)+"\t",t=t+r.get(k)+"\t",t=t+K.re+"\t",t=t+K.im+"\t",t=t+z+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+ee+"\t",t=t+0+"\t",t=t+1+"\t",t+="-360\t",t+="360;\t",t=t+"%Three-winding transformer branch 2-3 ("+i+")",t+="\n",t=t+r.get(k)+"\t",t=t+r.get(E)+"\t",t=t+X.re+"\t",t=t+X.im+"\t",t=t+_+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+te+"\t",t=t+0+"\t",t=t+1+"\t",t+="-360\t",t+="360;\t",t=t+"%Three-winding transformer branch 3-1 ("+i+")",t+="\n"}}})),t+="];\n",t;function c(e){let t="";return t=t+e.busNum+"\t",t=t+e.p+"\t",t=t+e.q+"\t",t=t+e.qmax+"\t",t=t+e.qmin+"\t",t=t+e.vg+"\t",t=t+e.mbase+"\t",t=t+1+"\t",t=t+e.pmax+"\t",t=t+e.pmin+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+"\t",t=t+0+";\t",t=t+"%Generator ("+e.genUUID+")",t+="\n",t}function d(t,n,a){let o=e.getAttribute(t,n);return o=void 0===o?a:o.textContent,o}function m(e,t){return{re:e,im:t}}function u(e,t){return{re:e.re+t.re,im:e.im+t.im}}function p(e,t){return{re:e.re*t.re-e.im*t.im,im:e.re*t.im+e.im*t.re}}function g(e){const t=e.re*e.re+e.im*e.im;return{re:e.re/t,im:-e.im/t}}}function rotate(e,t){let n=d3.select("svg").node(),a=n.createSVGPoint();if(a.x=e.x,a.y=e.y,0===t)return a;let o=n.createSVGTransform();return o.setRotate(t,0,0),a.matrixTransform(o.matrix)}function rotateTerm(e,t){let n=e.getTargets([t],"Terminal.ConductingEquipment")[0],a=n.x,o=n.y,r=rotate({x:t.x-a,y:t.y-o},t.rotation);return{x:a+r.x,y:o+r.y}}function addToDiagram(e,t,n){let a=d3.pointer(t,d3.select("svg").node()),o=d3.zoomTransform(d3.select("svg").node()),r=o.x,i=o.y,l=o.k;n.x=(a[0]-r)/l,n.px=n.x,n.y=(a[1]-i)/l,n.py=n.y;let s=[{x:0,y:0,seq:1}];"cim:ACLineSegment"!==n.nodeName&&"cim:BusbarSection"!==n.nodeName||s.push({x:150,y:0,seq:2}),e.addToActiveDiagram(n,s)}function calcLineData(e,t){let n="ConnectivityNode",a="ConnectivityNode.Terminals";"BUS_BRANCH"===e.getMode()&&(n="TopologicalNode",a="TopologicalNode.Terminal"),t.x=void 0,t.y=void 0,t.rotation=0;let o=[],r=0,i=0,l=e.getEquipments(t).filter((e=>void 0!==e.lineData||"BusbarSection"===e.localName)),s=l.filter((e=>"BusbarSection"===e.localName))[0],c=e.getDiagramObjects([t]);if(0===c.length){if(void 0!==s){c=e.getDiagramObjects([s]);let n=e.getAttribute(c[0],"cim:DiagramObject.rotation");void 0!==n&&(t.rotation=parseInt(n.innerHTML))}else if(l.length>0){let e=[];for(let t of l){let n=t.x+t.lineData[t.lineData.length-1].x,a=t.y+t.lineData[t.lineData.length-1].y;e.push({x:t.x+t.lineData[0].x,y:t.y+t.lineData[0].y,eq:t},{x:n,y:a,eq:t})}let t=1/0,n=e[0],a=e[0];for(let o of e)for(let r of e){if(o.eq===r.eq)continue;let e=distance2(o,r);e<t&&(t=e,n=o,a=r)}r=(n.x+a.x)/2,i=(n.y+a.y)/2}}else{let n=e.getAttribute(c[0],"cim:DiagramObject.rotation");void 0!==n&&(t.rotation=parseInt(n.innerHTML))}let d=e.getTargets(c,"DiagramObject.DiagramObjectPoints");if(d.length>0){for(let t of d){let n=e.getAttribute(t,"cim:DiagramObjectPoint.sequenceNumber");n=void 0===n?1:parseInt(n.innerHTML),o.push({x:parseFloat(e.getAttribute(t,"cim:DiagramObjectPoint.xPosition").innerHTML),y:parseFloat(e.getAttribute(t,"cim:DiagramObjectPoint.yPosition").innerHTML),seq:n})}o.sort((function(e,t){return e.seq-t.seq})),t.x=o[0].x,t.y=o[0].y;for(let e of o)e.x=e.x-t.x,e.y=e.y-t.y}else{if(o.push({x:0,y:0,seq:1}),t.nodeName==="cim:"+n){let n=e.getTargets([t],a);void 0!==e.getTargets(n,"Terminal.ConductingEquipment").filter((e=>"cim:BusbarSection"===e.nodeName))[0]&&o.push({x:150,y:0,seq:2})}t.x=r,t.y=i,e.addToActiveDiagram(t,o)}return t.lineData=o,o}function distance2(e,t){let n=e.x-t.x,a=e.y-t.y;return n*n+a*a}function closestPoint(e,t){let n=d3.line().x((function(e){return e.x})).y((function(e){return e.y})),a=d3.select(document.createElementNS("http://www.w3.org/2000/svg","svg")).append("path").attr("d",n(e.lineData)).node();if(null===a)return[0,0];let o,r,i=a.getTotalLength(),l=8,s=1/0;if(0===i)return[0,0];if(void 0===t.x||void 0===t.y)return[0,0];for(let t=0;t<=i;t+=l){let n=a.getPointAtLength(t);0!==e.rotation&&(n=rotate(n,e.rotation));let i=c(n);i<s&&(o=n,r=t,s=i)}for(l/=2;l>.5;){let t=r-l;if(t>=0){let n=a.getPointAtLength(t);0!==e.rotation&&(n=rotate(n,e.rotation));let i=c(n);if(i<s){o=n,r=t,s=i;continue}}let n=r+l;if(n<=i){let t=a.getPointAtLength(n);0!==e.rotation&&(t=rotate(t,e.rotation));let i=c(t);if(i<s){o=t,r=n,s=i;continue}}l/=2}return o=[o.x,o.y],o;function c(n){let a=n.x+e.x-t.x,o=n.y+e.y-t.y;return a*a+o*o}}
